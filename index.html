<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#121212">
    <title>Race to Singapore</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Michroma&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --bg-color: #121212;
            --text-color: #ffffff;
            --font-display: 'Michroma', sans-serif;
            --gray-track: rgba(255, 255, 255, 0.4); 
            --f1-purple: #B624FF; /* Fastest Lap Purple */
            
            /* Í∏∞Î≥∏Í∞í: Ìä∏ÎûôÏùÄ Ïù¥Ï†ú Ï†Ñ ÌåÄ Í≥µÌÜµÏúºÎ°ú Î≥¥ÎùºÏÉâÏûÖÎãàÎã§ üíú */
            --team-bg: #060025;
            --team-radio-bg: rgba(6, 0, 37, 0.95);
            --team-primary: #3671C6;
            --team-accent: #FF1E00;
            --track-active-color: var(--f1-purple); 
            --marker-bg: #3671C6;
            --marker-text: #ffffff;
        }

        /* üé® 2026 F1 Team Colors */

        /* 1. Red Bull - Î∏îÎ£® ÌÖçÏä§Ìä∏ & ÌååÌòï / Î†àÎìú Î≤ÑÌäº / Î≥¥ÎùºÏÉâ Ìä∏Îûô */
        body.redbull { 
            --team-bg: #060025; 
            --team-radio-bg: rgba(6, 0, 37, 0.95); 
            --team-primary: #3671C6; /* ÌåÄ Î∏îÎ£® (ÌååÌòï) */
            --team-accent: #FCD116; 
            --track-active-color: var(--f1-purple); /* Ìä∏Îûô: Î≥¥Îùº */
            --marker-bg: #FFEC00; 
            --marker-text: #000000; 
        }

        /* [Red Bull] ÎìúÎùºÏù¥Î≤Ñ Ïù¥Î¶Ñ & CUR Í∏àÏï° -> ÌåÄ Î∏îÎ£® */
        body.redbull .driver-name span,
        body.redbull #txt-current { 
            color: #3671C6 !important; 
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
        }

        /* [Red Bull] ÌÉÄÍ≤ü Í∏àÏï° -> Ïó∞Ìïú Ìù∞ÏÉâ */
        body.redbull #txt-goal { color: rgba(255, 255, 255, 0.6); }

        /* [Red Bull] ÎùºÎîîÏò§ ÎùºÎ≤® -> Ìù∞ÏÉâ */
        body.redbull .radio-label { color: #ffffff !important; }

        /* [Red Bull] Î≤ÑÌäº -> Î†àÎìú Ìè¨Ïù∏Ìä∏ üèéÔ∏èüî• */
        body.redbull .box-btn {
            color: #FF1E00;
            border-color: #FF1E00;
        }
        @media (hover: hover) and (pointer: fine) {
            body.redbull .box-btn:hover { 
                background-color: #FF1E00; color: #fff; box-shadow: 0 0 20px rgba(255, 30, 0, 0.6); 
            }
        }
        body.redbull .box-btn:active, body.redbull .box-btn.flash-active { 
            background-color: #FF1E00 !important; color: #fff !important; box-shadow: 0 0 20px rgba(255, 30, 0, 0.8) !important; 
        }

        /* 2. Mercedes */
        body.mercedes { 
            --team-bg: #121212; 
            --team-radio-bg: rgba(20, 20, 20, 0.95); 
            --team-primary: #00D2BE; 
            --team-accent: #00D2BE; 
            --track-active-color: var(--f1-purple); /* Ìä∏Îûô: Î≥¥Îùº */
            --marker-bg: #00D2BE;
            --marker-text: #000000; 
        }
        
        /* 3. Ferrari */
        body.ferrari { 
            --team-bg: #1A0000; 
            --team-radio-bg: rgba(40, 0, 0, 0.95); 
            --team-primary: #FF2800; 
            --team-accent: #FFF200; 
            --track-active-color: var(--f1-purple); /* Ìä∏Îûô: Î≥¥Îùº */
            --marker-bg: #FF2800;
            --marker-text: #ffffff; 
        }
        
        /* 4. Sauber / Audi */
        body.sauber { 
            --team-bg: #1C1C1C; 
            --team-radio-bg: rgba(28, 28, 28, 0.95); 
            --team-primary: #C0C0C0; 
            --team-accent: #FF0000; 
            --track-active-color: var(--f1-purple); /* Ìä∏Îûô: Î≥¥Îùº */
            --marker-bg: #C0C0C0;
            --marker-text: #000000; 
        }
        
        /* 5. Haas */
        body.haas { 
            --team-bg: #000000; 
            --team-radio-bg: rgba(10, 10, 10, 0.95); 
            --team-primary: #E6002B; 
            --team-accent: #FFFFFF; 
            --track-active-color: var(--f1-purple); /* Ìä∏Îûô: Î≥¥Îùº */
            --marker-bg: #E6002B;
            --marker-text: #ffffff;
        }

        /* 6. Aston Martin - ÎÑ§Ïò® Ïó∞Îëê Ìè¨Ïù∏Ìä∏ */
        body.astonmartin { 
            --team-bg: #002420; 
            --team-radio-bg: rgba(0, 36, 32, 0.95); 
            --team-primary: #CEDC00; 
            --team-accent: #CEDC00; 
            --track-active-color: var(--f1-purple); /* Ìä∏Îûô: Î≥¥Îùº */
            --marker-bg: #CEDC00;
            --marker-text: #000000; 
        }
        body.astonmartin .box-btn { color: #CEDC00; border-color: #CEDC00; }
        @media (hover: hover) and (pointer: fine) {
            body.astonmartin .box-btn:hover { background-color: #CEDC00; color: #002420; box-shadow: 0 0 20px rgba(206, 220, 0, 0.6); }
        }
        body.astonmartin .box-btn:active, body.astonmartin .box-btn.flash-active { 
            background-color: #CEDC00 !important; color: #002420 !important; box-shadow: 0 0 25px rgba(206, 220, 0, 0.8) !important; 
        }
        
        /* 7. RB (Visa Cash App RB) - Î∏îÎ£® ÌååÌòï / Í∑∏Î¶∞ ÌÖçÏä§Ìä∏ & Î≤ÑÌäº / Î≥¥ÎùºÏÉâ Ìä∏Îûô */
        body.rb { 
            --team-bg: #040814; 
            --team-radio-bg: rgba(4, 8, 20, 0.95); 
            --team-primary: #3671C6; /* ÌååÌòï: Î∏îÎ£® üîµ */
            --team-accent: #00D632;  /* Ìè¨Ïù∏Ìä∏: Í∑∏Î¶∞ üü¢ */
            --track-active-color: var(--f1-purple); /* Ìä∏Îûô: Î≥¥Îùº */
            --marker-bg: #FFFFFF;
            --marker-text: #040814; 
        }

        /* [RB] ÌÖçÏä§Ìä∏ Ï†ïÎ≥¥ -> Í∑∏Î¶∞ */
        body.rb .driver-name span, body.rb .session-step, body.rb .circuit-country { color: #00D632 !important; }
        /* [RB] ÎùºÎîîÏò§ ÎùºÎ≤® -> Ìù∞ÏÉâ */
        body.rb .radio-label { color: #ffffff !important; opacity: 0.8; }
        /* [RB] ÌååÌòï -> Î∏îÎ£® */
        body.rb .bar { background-color: #3671C6 !important; }
        /* [RB] Î≤ÑÌäº -> Í∑∏Î¶∞ */
        body.rb .box-btn { color: #00D632; border-color: #00D632; }
        @media (hover: hover) and (pointer: fine) {
            body.rb .box-btn:hover { background-color: #00D632; color: #ffffff; box-shadow: 0 0 20px rgba(0, 214, 50, 0.5); }
        }
        body.rb .box-btn:active, body.rb .box-btn.flash-active { 
            background-color: #00D632 !important; color: #ffffff !important; box-shadow: 0 0 25px rgba(0, 214, 50, 0.7) !important; 
        }

        /* 10. McLaren - ÌååÌååÏïº Ïò§Î†åÏßÄ */
        body.mclaren { 
            --team-bg: #151515; 
            --team-radio-bg: rgba(21, 21, 21, 0.95); 
            --team-primary: #FF8000; 
            --team-accent: #FF8000; 
            --track-active-color: var(--f1-purple); /* Ìä∏Îûô: Î≥¥Îùº */
            --marker-bg: #FF8000;
            --marker-text: #000000; 
        }
        body.mclaren .box-btn { color: #FF8000; border-color: #FF8000; }
        @media (hover: hover) and (pointer: fine) {
            body.mclaren .box-btn:hover { background-color: #FF8000; color: #000000; box-shadow: 0 0 20px rgba(255, 128, 0, 0.6); }
        }
        body.mclaren .box-btn:active, body.mclaren .box-btn.flash-active { 
            background-color: #FF8000 !important; color: #000000 !important; box-shadow: 0 0 20px rgba(255, 128, 0, 0.8) !important; 
        }

        /* 8. Alpine */
        body.alpine { 
            --team-bg: #00102A; 
            --team-radio-bg: rgba(0, 16, 42, 0.95); 
            --team-primary: #0090FF; 
            --team-accent: #FD4BC7; 
            --track-active-color: var(--f1-purple); /* Ìä∏Îûô: Î≥¥Îùº */
            --marker-bg: #0090FF;
            --marker-text: #ffffff;
        }
        
        /* 9. Williams */
        body.williams { 
            --team-bg: #040015; 
            --team-radio-bg: rgba(4, 0, 21, 0.95); 
            --team-primary: #00A0DE; 
            --team-accent: #FFFFFF; 
            --track-active-color: var(--f1-purple); /* Ìä∏Îûô: Î≥¥Îùº */
            --marker-bg: #00A0DE;
            --marker-text: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background-color: var(--team-bg); 
            color: var(--text-color); 
            font-family: var(--font-display); 
            height: 100vh;
            height: 100dvh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            transition: background 0.5s ease; 
        }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.3s ease-out; }
        .lights-container { display: flex; gap: 15px; padding: 20px; background: #111; border-radius: 10px; border: 2px solid #333; margin-bottom: 30px; }
        .light-pair { display: flex; flex-direction: column; gap: 5px; }
        .f1-light { width: 40px; height: 40px; background-color: rgba(255, 0, 0, 0.2); border-radius: 50%; border: 3px solid #222; transition: all 0.1s ease; }
        .f1-light.on { background-color: #ff0000; box-shadow: 0 0 30px #ff0000, 0 0 10px #ff0000 inset; border-color: #500; }
        .loading-text { color: #fff; font-family: var(--font-display); font-size: 14px; letter-spacing: 2px; animation: blink 1s infinite; margin-bottom: 20px; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        #start-engine-btn { background: transparent; color: #fff; border: 2px solid #fff; padding: 15px 40px; font-family: var(--font-display); font-size: 16px; font-weight: bold; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; transition: all 0.3s ease; box-shadow: 0 0 15px rgba(255,255,255,0.2); }
        #start-engine-btn:hover { background: #fff; color: #000; box-shadow: 0 0 30px rgba(255,255,255,0.6); }
        #bgm-player { position: absolute; top: -9999px; left: -9999px; visibility: hidden; pointer-events: none; }

        /* üí° [ÏàòÏ†ï] Ìó§Îçî Î†àÏù¥ÏïÑÏõÉ Í∞úÏÑ†: ÎÜíÏù¥ ÏïïÏ∂ï Î∞è ÏôºÏ™Ω Ï†ïÎ†¨ */
        .header-container { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            padding: 40px 20px 0 20px; 
            display: flex; 
            gap: 15px; 
            z-index: 100; 
            align-items: flex-start; /* ÏÉÅÎã® Í∏∞Ï§Ä Ï†ïÎ†¨ */
            justify-content: space-between; 
        }

        /* ÏôºÏ™Ω Ï†ïÎ≥¥ ÏòÅÏó≠: Ï†ïÎ†¨ÏùÑ ÏôºÏ™ΩÏúºÎ°ú, ÎÑàÎπÑ ÏûêÎèô Ï°∞Ï†ï */
        .logo-box { 
            flex: 0 1 auto; /* ÌïÑÏöîÌïú ÎßåÌÅºÎßå Í≥µÍ∞Ñ Ï∞®ÏßÄ */
            width: auto; 
            background: transparent; 
            border: none; 
            display: flex; 
            flex-direction: column; 
            justify-content: flex-start; 
            align-items: flex-start; /* ÏôºÏ™Ω Ï†ïÎ†¨ ÌïµÏã¨ */
            padding: 0; 
        }

        /* Î°úÍ≥† ÌÅ¨Í∏∞ Ï∂ïÏÜå */
        .f1-logo { 
            width: 60px; 
            height: auto; 
            object-fit: contain; 
            filter: brightness(0) invert(1); 
            margin-bottom: 15px; /* üí° Î°úÍ≥† ÏïÑÎûò Í∞ÑÍ≤© Ï¶ùÍ∞Ä (8px -> 15px) */
        }

        /* ÌÖçÏä§Ìä∏ ÏôºÏ™Ω Ï†ïÎ†¨ Î∞è Ïó¨Î∞± Ï†ïÎ¶¨ */
        .circuit-info { 
            text-align: left; /* ÏôºÏ™Ω Ï†ïÎ†¨ */
            margin-top: 0; 
            width: 100%; 
        }

        .circuit-country { 
            font-size: 10px; 
            color: var(--team-accent); 
            font-weight: bold; 
            letter-spacing: 1px; 
            text-transform: uppercase; 
        }

        .circuit-name { 
            font-size: 9px; 
            color: rgba(255,255,255,0.7); 
            font-weight: normal; 
            margin-top: 2px; 
            line-height: 1.2; 
            white-space: nowrap; /* Ï§ÑÎ∞îÍøà Î∞©ÏßÄ */
        }

        /* ÏÉÅÌÉú ÌëúÏãú(Q1, HOTEL) ÏôºÏ™Ω Ï†ïÎ†¨ Î∞è Í∞ÑÍ≤© Ï°∞Ï†ï */
        .status-container { 
            display: flex; 
            flex-direction: row; 
            align-items: center; 
            gap: 6px; 
            margin-top: 15px; /* üí° ÏúÑÏ™Ω ÏöîÏÜåÏôÄÏùò Í∞ÑÍ≤© Ï¶ùÍ∞Ä (10px -> 15px) */
        }

        .session-step { 
            font-size: 11px; /* Í∞ÄÎèÖÏÑ± ÏúÑÌï¥ ÏïΩÍ∞Ñ ÌÇ§ÏõÄ */
            font-weight: bold; 
            color: var(--team-accent); 
            letter-spacing: 1px; 
        }

        .session-name { 
            font-size: 11px; 
            font-weight: bold; 
            color: #fff; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            white-space: nowrap; 
        }

        /* üí° [ÏàòÏ†ï] ÎÑàÎπÑ Ï∂ïÏÜå (220px -> 180px) */
        .radio-box { 
            flex: 0 0 auto; 
            width: 180px; /* Î™®Î∞îÏùº ÏïàÏ†ÑÌè≠ÏúºÎ°ú Î≥ÄÍ≤Ω */
            background: var(--team-radio-bg); 
            border: 4px solid rgba(255, 255, 255, 0.1); 
            border-radius: 4px; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); 
            margin-left: auto; 
            border: 1px solid rgba(255,255,255,0.2); 
        }

/* 2. Ïò§Î•∏Ï™Ω ÎùºÎîîÏò§ Î∞ïÏä§: ÎÇ¥Î∂Ä Ïó¨Î∞±Í≥º Ï§Ñ Í∞ÑÍ≤© ÎåÄÌè≠ ÌôïÎ≥¥ */
        .radio-content-section { 
            padding: 15px 10px 20px 10px; /* üí° ÏúÑÏïÑÎûò Ìå®Îî©ÏùÑ ÎÑâÎÑâÌïòÍ≤å ÎäòÎ¶º */
            display: flex; 
            flex-direction: column; 
            gap: 12px; /* üí° ÏßàÎ¨∏Í≥º ÎãµÎ≥Ä ÏÇ¨Ïù¥ Í∞ÑÍ≤© 2Î∞∞ Ïù¥ÏÉÅ ÌôïÎ≥¥ (5px -> 12px) */
            justify-content: center; /* ÎÇ¥Ïö©Î¨ºÏùÑ ÏÑ∏Î°ú Ï§ëÏïôÏóê Î∞∞Ïπò */
            flex: 1; /* Î∞ïÏä§ ÎÇ®ÏùÄ Í≥µÍ∞ÑÏùÑ Ï±ÑÏö∞ÎèÑÎ°ù ÏÑ§Ï†ï */
        }

        .radio-top-section { 
            padding: 8px 8px 0px 8px; /* ÎÇ¥Î∂Ä Ïó¨Î∞±ÎèÑ ÏÇ¥Ïßù Ï§ÑÏûÑ */
            text-align: right; 
            overflow: hidden; 
        }

        /* üí° [ÏàòÏ†ï] Ï¢ÅÏïÑÏßÑ Ìè≠Ïóê ÎßûÏ∂∞ Ìè∞Ìä∏ ÌÅ¨Í∏∞ ÎØ∏ÏÑ∏ Ï°∞Ï†ï (14px -> 13px) */
        .driver-name { 
            font-size: 13px; 
            font-weight: bold; 
            color: #fff; 
            text-transform: uppercase; 
            letter-spacing: -0.5px; 
            transform: scaleX(1.1); 
            transform-origin: right; 
            display: inline-block; 
            white-space: nowrap; 
        }

        .driver-name span { color: var(--team-accent); }
        


        .radio-label { 
            display: block; 
            margin-top: 2px; 
            font-size: 8px; 
            font-weight: bold; 
            color: #fff; 
            letter-spacing: 2px; 
            opacity: 0.8; 
        }
        .audio-wave-divider { width: 100%; height: 20px; display: flex; justify-content: space-between; align-items: flex-end; padding: 0 5px; margin: 5px 0; }
        /* üí° [ÏàòÏ†ï] Ïò§ÎîîÏò§ Î∞î: ÏßÅÍ∞Å ÌòïÌÉú(Square) & Îã®Ïùº ÏÉâÏÉÅ(Solid) */
        .bar { 
            flex: 1; 
            margin: 0 1px; 
            background-color: var(--team-primary); /* ÌåÄ Ïª¨Îü¨ Îã®ÏÉâ Ïú†ÏßÄ */
            transform-origin: bottom; 
            height: 3px; 
            border-radius: 0; /* üí° Îë•Í∑º Î™®ÏÑúÎ¶¨ Ï†úÍ±∞ -> ÏôÑÏ†ÑÌïú ÏÇ¨Í∞ÅÌòï */
        }

        /* üí° [ÏàòÏ†ï] Ìà¨Î™ÖÎèÑ Î≥ÄÌôî Ï†úÍ±∞, ÎÜíÏù¥Îßå ÍπîÎÅîÌïòÍ≤å Î≥ÄÌôî */
        @keyframes equalizer { 
            0%, 100% { height: 3px; } 
            50% { height: var(--eq-height, 10px); } 
        }
        .quote-box { 
            font-family: var(--font-display); 
            font-style: italic; 
            font-weight: 400; 
            font-size: 11px; 
            letter-spacing: -0.5px; 
            line-height: 1.5; /* üí° Ï§ÑÍ∞ÑÍ≤©(ÌñâÍ∞Ñ)ÏùÑ ÎÑìÌòÄ Í∞ÄÎèÖÏÑ± Í∞úÏÑ† (1.3 -> 1.5) */
        }
        .quote-box::before { content: "‚Äú"; color: #fff; margin-right: 4px; }
        .quote-box::after { content: "‚Äù"; color: #fff; margin-left: 4px; }
        .top-msg { text-align: left; color: #fff; }
        .bottom-data { text-align: right; color: var(--team-accent); }
        .amount-container { display: inline-block; text-align: right; }
        .amount-row { display: block; line-height: 1.2; font-size: 11px; font-weight: bold; }
        .amount-goal { font-size: 9px; color: rgba(255,255,255,0.6); margin-top: 2px; font-family: var(--font-display); font-weight: normal; }

        .track-container { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; padding: 140px 20px 20px 20px; overflow: hidden; min-height: 0; }
        svg.track-svg { width: 100%; height: 100%; max-width: 900px; overflow: visible; }
        .track-path-bg { fill: none; stroke: var(--gray-track); stroke-width: 14; stroke-linecap: round; stroke-linejoin: round; }
        .track-path-active { fill: none; stroke: var(--track-active-color); stroke-width: 14; stroke-linecap: round; stroke-linejoin: round; filter: drop-shadow(0 0 10px var(--track-active-color)); transition: stroke-dasharray 0.5s ease, stroke 0.5s ease; }
        .checker-box { stroke: none; }
        .checker-white { fill: #fff; }
        .checker-black { fill: #000; }

        .ai-marker { cursor: default; pointer-events: none; }
        .ai-marker circle { fill: #555; stroke: none; transition: fill 0.3s; }
        .ai-marker rect { fill: #222; rx: 4; opacity: 0.9; transition: fill 0.3s, stroke 0.3s; stroke: none; }
        .ai-marker text { fill: #fff; font-weight: 900; font-family: var(--font-display); text-anchor: middle; dominant-baseline: middle; transition: fill 0.3s; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        
        .ai-marker.hero-marker rect { fill: var(--marker-bg) !important; stroke: none !important; opacity: 1; }
        .ai-marker.hero-marker text { fill: var(--marker-text) !important; font-weight: 900; text-shadow: none; }
        .ai-marker.hero-marker circle { fill: var(--team-accent) !important; r: 5; }
        .ai-marker.hero-marker { z-index: 999; filter: drop-shadow(0 0 8px var(--marker-bg)); }

        .controls { padding: 20px 30px 40px 30px; text-align: center; z-index: 20; position: relative; margin-top: auto; flex-shrink: 0; }
        
/* üí° [ÏàòÏ†ï] Î™®Î∞îÏùº Ìò∏Î≤Ñ Ïù¥Ïäà Ìï¥Í≤∞ÏùÑ ÏúÑÌïú Î≤ÑÌäº Ïä§ÌÉÄÏùº Ïû¨Ï†ïÏùò */
        .box-btn { 
            background-color: transparent; 
            color: var(--team-primary); 
            font-family: var(--font-display); 
            font-size: 18px; 
            font-weight: bold; 
            border: 2px solid var(--team-primary); 
            padding: 18px 50px; 
            border-radius: 4px; 
            text-transform: uppercase; 
            cursor: pointer; 
            box-shadow: none; 
            transition: transform 0.1s ease, box-shadow 0.1s ease, background-color 0.1s; 
            position: relative; 
            width: 100%; 
            max-width: 300px; 
            -webkit-tap-highlight-color: transparent; /* Î™®Î∞îÏùº ÌÉ≠ ÌïòÏù¥ÎùºÏù¥Ìä∏ Ï†úÍ±∞ */
            outline: none; /* Ìè¨Ïª§Ïä§ ÏïÑÏõÉÎùºÏù∏ Ï†úÍ±∞ */
        }

        /* PC(ÎßàÏö∞Ïä§) ÌôòÍ≤ΩÏóêÏÑúÎßå Ìò∏Î≤Ñ Ìö®Í≥º Ï†ÅÏö© (Î™®Î∞îÏùº Ï†úÏô∏) */
        @media (hover: hover) and (pointer: fine) {
            .box-btn:hover { 
                background-color: var(--team-primary); 
                color: #000; 
                transform: scale(1.02); 
                box-shadow: 0 0 15px var(--team-primary); 
            }
        }

        /* Î™®Î∞îÏùº ÌÑ∞Ïπò Î∞è ÌÅ¥Î¶≠ Ïãú Ï¶âÍ∞Å Î∞òÏùë (Active) */
        .box-btn:active, .box-btn.flash-active { 
            transform: scale(0.96); 
            background-color: var(--team-primary) !important; 
            color: #000 !important; 
            box-shadow: 0 0 15px var(--team-primary) !important; 
            transition: none; /* Ï¶âÍ∞Å Î∞òÏùë */
        }

        /* üí° [Ï∂îÍ∞Ä] Ïò§ÎîîÏò§ Ïª®Ìä∏Î°§ Î≤ÑÌäº (Ï¢åÏ∏° ÌïòÎã® Î∞∞Ïπò) */
        .audio-container {
            position: absolute;
            bottom: 40px; /* controls Ìå®Îî©Í≥º ÎÜíÏù¥ Í≥†Î†§ */
            left: 30px;
            z-index: 50;
        }

        .audio-btn {
            background: transparent;
            border: none;
            padding: 5px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .audio-btn:hover { opacity: 1; }
        
        .audio-icon {
            width: 24px;
            height: 24px;
            fill: #888; /* Ïó∞Ìïú ÌöåÏÉâ */
        }

        .tooltip { position: absolute; bottom: calc(100% + 15px); left: 50%; transform: translateX(-50%) translateY(10px); background: #000; color: #fff; border: 2px solid var(--team-primary); padding: 10px 16px; border-radius: 4px; font-size: 11px; font-family: var(--font-display); white-space: nowrap; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s, transform 0.3s; box-shadow: 0 5px 20px rgba(0,0,0,0.8); }
        .tooltip.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border: 8px solid transparent; border-top-color: var(--team-primary); }
        
        .settings-btn { background: none; border: 1px solid #555; color: #888; padding: 10px 20px; margin-top: 20px; border-radius: 4px; font-size: 11px; cursor: pointer; font-family: var(--font-display); text-transform: uppercase; letter-spacing: 1px; transition: all 0.3s ease; }
        .settings-btn:hover { border-color: #fff; color: #fff; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 5000; justify-content: center; align-items: center; }
        .modal-content { background: var(--team-radio-bg); padding: 25px; border-radius: 4px; width: 90%; max-width: 400px; border: 1px solid #333; overflow-y: auto; max-height: 80vh; border: 1px solid var(--team-accent); }
        .modal h2 { font-family: var(--font-display); font-size: 16px; margin-bottom: 20px; color: var(--team-accent); text-transform: uppercase; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 9px; color: rgba(255,255,255,0.7); margin-bottom: 6px; font-family: var(--font-display); text-transform: uppercase; }
        .input-group input, .input-group select { width: 100%; padding: 10px; background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.2); color: #fff; font-family: var(--font-display); font-size: 12px; color-scheme: dark; outline: none; }
        .input-group select option { background: #222; color: #fff; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); opacity: 0.8; cursor: pointer; }
        
        .close-btn { width: 100%; padding: 16px; background: transparent; color: var(--team-accent); border: 2px solid var(--team-accent); margin-top: 15px; font-weight: 900; font-family: var(--font-display); text-transform: uppercase; cursor: pointer; letter-spacing: 2px; transition: background 0.2s, color 0.2s; }
        .close-btn:hover { background: var(--team-accent); color: #000; }
        .recommendation-box { margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.5); border-left: 3px solid var(--team-accent); }
        .rec-title { font-size: 9px; color: #aaa; text-transform: uppercase; margin-bottom: 5px; font-family: var(--font-display); }
        .rec-value { font-size: 14px; color: var(--team-accent); font-weight: bold; font-family: var(--font-display); }
        
        #celebration-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
        .celebration-content { background: #000; border: 2px solid var(--team-primary); border-radius: 12px; width: 85%; max-width: 400px; padding: 40px 20px; text-align: center; box-shadow: none; border: 2px solid var(--team-primary); animation: slideUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .fastest-lap-title { color: var(--team-primary); font-family: var(--font-display); font-size: 12px; letter-spacing: 4px; margin-bottom: 12px; font-weight: 900; }
        .fastest-lap-driver { color: #fff; font-family: var(--font-display); font-size: 26px; font-weight: 900; text-transform: uppercase; margin-bottom: 30px; letter-spacing: -1px; }
        .next-session-btn { background: var(--team-primary); color: #fff; border: none; padding: 16px 30px; font-family: var(--font-display); font-size: 11px; font-weight: 900; border-radius: 4px; cursor: pointer; text-transform: uppercase; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
    <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body class="redbull">

    <div id="loading-overlay">
        <div class="lights-container">
            <div class="light-pair"><div class="f1-light" id="light-1"></div><div class="f1-light" id="light-1b"></div></div>
            <div class="light-pair"><div class="f1-light" id="light-2"></div><div class="f1-light" id="light-2b"></div></div>
            <div class="light-pair"><div class="f1-light" id="light-3"></div><div class="f1-light" id="light-3b"></div></div>
            <div class="light-pair"><div class="f1-light" id="light-4"></div><div class="f1-light" id="light-4b"></div></div>
            <div class="light-pair"><div class="f1-light" id="light-5"></div><div class="f1-light" id="light-5b"></div></div>
        </div>
        <div class="loading-text">GRID FORMED...</div>
        <button id="start-engine-btn" onclick="activateEngine()">START ENGINE</button>
    </div>

    <div id="bgm-player"></div>

    <div id="celebration-overlay" style="display: none;">
        <div class="celebration-content">
            <div class="fastest-lap-title" id="lap-session-title">[Q1] FASTEST LAP</div>
            <div class="fastest-lap-driver" id="lap-driver-name">ANTONELLI</div>
            <button class="next-session-btn" onclick="closeCelebration()">PUSH FOR NEXT LAP</button>
        </div>
    </div>

    <div class="header-container">
        <div class="logo-box">
            <img src="https://i.imgur.com/jan8CSk.png" alt="F1 Logo" class="f1-logo">
            <div class="circuit-info">
                <div class="circuit-country" id="disp-country">SINGAPORE</div>
                <div class="circuit-name" id="disp-circuit">Marina Bay Street Circuit</div>
            </div>
            <div class="status-container">
                <div id="session-step" class="session-step">[Q1]</div>
                <div id="session-name" class="session-name">HOTEL</div>
            </div>
        </div>
        <div class="radio-box">
            <div class="radio-top-section">
                <div class="driver-name" id="display-name"><span>VERSTAPPEN</span></div>
                <span class="radio-label">RADIO</span>
            </div>
            <div id="wave-container" class="audio-wave-divider"></div>
            <div class="radio-content-section">
                <div class="quote-box top-msg">BUDGET CHECK.</div>
                <div class="quote-box bottom-data">
                    <div class="amount-container">
                        <span class="amount-row" id="txt-current">CUR ‚Ç©0</span>
                        <span class="amount-row amount-goal" id="txt-goal">TAR ‚Ç©5,000,000</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="track-container">
        <svg class="track-svg" viewBox="0 0 1200 700" preserveAspectRatio="xMidYMid meet">
            <path id="bg-track" class="track-path-bg" />
            <path id="active-track" class="track-path-active" />
            <g id="start-finish-line" transform="translate(1040, 435)">
                 <rect x="0" y="0" width="10" height="5" class="checker-white"/>
                 <rect x="10" y="0" width="10" height="5" class="checker-black"/>
                 <rect x="0" y="5" width="10" height="5" class="checker-black"/>
                 <rect x="10" y="5" width="10" height="5" class="checker-white"/>
                 <rect x="0" y="10" width="10" height="5" class="checker-white"/>
                 <rect x="10" y="10" width="10" height="5" class="checker-black"/>
                 <rect x="0" y="15" width="10" height="5" class="checker-black"/>
                 <rect x="10" y="15" width="10" height="5" class="checker-white"/>
                 <rect x="0" y="20" width="10" height="5" class="checker-white"/>
                 <rect x="10" y="20" width="10" height="5" class="checker-black"/>
                 <rect x="0" y="25" width="10" height="5" class="checker-black"/>
                 <rect x="10" y="25" width="10" height="5" class="checker-white"/>
            </g>
            <g id="ai-cars-layer"></g>
        </svg>
    </div>

    <div class="controls">
        <div id="msg-tooltip" class="tooltip">NOT YET, STAY IN GARAGE</div>
        
        <button class="box-btn" onclick="addMoney()">BOX BOX</button>
        <br>
        
        <button class="settings-btn" onclick="openSettings()">PIT STOP</button>

        <div class="audio-container">
            <button class="audio-btn" onclick="toggleAudio()" aria-label="Toggle Audio">
                <svg id="icon-sound-on" class="audio-icon" viewBox="0 0 24 24">
                    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                </svg>
                <svg id="icon-sound-off" class="audio-icon" viewBox="0 0 24 24" style="display: none;">
                    <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73 4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                </svg>
            </button>
        </div>
    </div>

    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <h2>Strategy Settings</h2>
            
            <div class="input-group">
                <label>Constructor</label>
                <select id="team-select" onchange="updateDriverList(this.value)">
                    <option value="redbull">ORACLE RED BULL RACING</option>
                    <option value="mercedes">MERCEDES-AMG PETRONAS</option>
                    <option value="ferrari">SCUDERIA FERRARI HP</option>
                    <option value="mclaren">MCLAREN F1 TEAM</option>
                    <option value="astonmartin">ASTON MARTIN ARAMCO</option>
                    <option value="alpine">BWT ALPINE F1 TEAM</option>
                    <option value="williams">WILLIAMS RACING</option>
                    <option value="rb">VISA CASH APP RB</option>
                    <option value="sauber">SAUBER / AUDI</option>
                    <option value="haas">MONEYGRAM HAAS F1</option>
                </select>
            </div>
            
            <div class="input-group">
                <label>Driver</label>
                <select id="driver-select" onchange="setDriver(this.value)">
                    </select>
            </div>
            
            <div style="display:flex; gap:10px;">
                <div class="input-group" style="flex:1;">
                    <label>Deposit Day (DD)</label>
                    <input type="number" id="savings-day" min="1" max="31" oninput="calculateRecommendation()">
                </div>
                <div class="input-group" style="flex:1;">
                    <label>Target Date (Race Day)</label>
                    <input type="date" id="target-date" onchange="calculateRecommendation()">
                </div>
            </div>

            <div class="input-group"><label>Monthly Amount (‚Ç©)</label><input type="number" id="deposit-unit" oninput="calculateRecommendation()"></div>
            <div class="input-group"><label>Current Total Capital (‚Ç©)</label><input type="number" id="manual-amount" oninput="calculateRecommendation()"></div>
            <div class="input-group"><label>[Q1] HOTEL (‚Ç©) - BASE</label><input type="number" id="q1-goal" oninput="calculateRecommendation()"></div>
            <div class="input-group"><label>[Q2] FLIGHT (‚Ç©) - ENTRY</label><input type="number" id="q2-goal" oninput="calculateRecommendation()"></div>
            <div class="input-group"><label>[Q3] TICKET+ETC (‚Ç©) - RACE</label><input type="number" id="q3-goal" oninput="calculateRecommendation()"></div>
            
            <div class="recommendation-box" id="rec-box" style="display:none;">
                <div class="rec-title">Race Engineer Strategy</div>
                <div class="rec-value" id="rec-msg">Calculating...</div>
            </div>

            <button class="close-btn" onclick="saveAndCloseSettings()">PIT LIMITER OFF</button>
        </div>
    </div>

    <script>
        // üöÄ ÏÉàÎ°úÏö¥ 2030 ÌîåÎûúÏùÑ ÏúÑÌï¥ ÌÇ§ Î≤ÑÏ†Ñ ÏóÖÍ∑∏Î†àÏù¥Îìú
        const STORAGE_KEY = 'f1_singapore_2030_plan_v1';

        const singaporeCircuitPath = "M 1050,450 L 1050,300 C 1050,220 1000,200 950,200 L 900,200 L 880,250 L 840,250 L 500,220 L 450,150 L 350,200 L 300,350 L 200,300 L 100,500 C 100,650 250,650 250,550 L 300,400 L 550,420 L 550,500 L 700,500 L 700,470 L 800,470 L 800,500 L 950,500 C 1020,500 1050,480 1050,450 Z";
        
        const teamsDB = {
            redbull: { name: 'Red Bull Racing', drivers: ['VERSTAPPEN', 'LAWSON'] },
            mercedes: { name: 'Mercedes-AMG', drivers: ['ANTONELLI', 'RUSSELL'] },
            ferrari: { name: 'Ferrari HP', drivers: ['LECLERC', 'HAMILTON'] },
            mclaren: { name: 'McLaren F1', drivers: ['NORRIS', 'PIASTRI'] },
            astonmartin: { name: 'Aston Martin', drivers: ['ALONSO', 'STROLL'] },
            alpine: { name: 'Alpine', drivers: ['GASLY', 'DOOHAN'] },
            williams: { name: 'Williams', drivers: ['ALBON', 'SAINZ'] },
            rb: { name: 'Visa Cash App RB', drivers: ['TSUNODA', 'HADJAR'] },
            sauber: { name: 'Sauber / Audi', drivers: ['HULKENBERG', 'BORTOLETO'] },
            haas: { name: 'Haas F1', drivers: ['OCON', 'BEARMAN'] }
        };

        let state = { 
            currentAmount: 0, 
            team: 'redbull', 
            driver: 'VERSTAPPEN', 
            // üí° 2030 Ïã±Í∞ÄÌè¨Î•¥ ÌîåÎûú ÏòàÏÇ∞ ÏÑ§Ï†ï (Îã®ÏúÑ: Ïõê)
            // Q1 (ÏàôÏÜå - 4Î∞ï, 160Îßå): Î†àÏù¥Ïä§Ïùò Í∏∞Ï¥à
            q1: 1600000, 
            // Q2 (Ìï≠Í≥µÍ∂å - 80Îßå): ÌòÑÏû• ÎèÑÏ∞©
            q2: 800000, 
            // Q3 (Ìã∞Ïºì + ÏãùÎπÑ/ÏáºÌïë/ÏòàÎπÑÎπÑ - 260Îßå): Í∑∏ÎûëÌîÑÎ¶¨ Ï¶êÍ∏∞Í∏∞ (Ìã∞Ïºì 90 + Ïó¨Ïú†ÏûêÍ∏à 170)
            q3: 2600000, 
            lastSession: 'Q1', 
            savingsDay: 25, 
            // Ïõî ÎÇ©ÏûÖÍ∏à (500Îßå / 60Í∞úÏõî = ÏïΩ 84,000Ïõê)
            depositUnit: 84000, 
            lastDepositDate: '', 
            targetDate: '',
            circuitId: 'sin' 
        };
        let visualProgress = 0, animId = null;
        let trackSpeedProfile = [];
        let raceStarted = false; 

        let bgmPlayer;
let isMuted = false;

        /* üí° [Ï∂îÍ∞Ä] Ïò§ÎîîÏò§ ÌÜ†Í∏Ä Ìï®Ïàò */
        function toggleAudio() {
            isMuted = !isMuted;
            const onIcon = document.getElementById('icon-sound-on');
            const offIcon = document.getElementById('icon-sound-off');

            if (isMuted) {
                if (bgmPlayer && bgmPlayer.setVolume) bgmPlayer.setVolume(0);
                onIcon.style.display = 'none';
                offIcon.style.display = 'block';
            } else {
                if (bgmPlayer && bgmPlayer.setVolume) bgmPlayer.setVolume(70);
                onIcon.style.display = 'block';
                offIcon.style.display = 'none';
            }
        }

        /* üí° [ÏàòÏ†ï] addMoney Ìï®Ïàò ÎÇ¥ Î≤ÑÌäº Ìö®Í≥º Í∞ïÌôî */
        function addMoney() {
            // Î™®Î∞îÏùº Î≤ÑÌäº ÏãúÍ∞Å Ìö®Í≥º (ÌÑ∞Ïπò ÏãúÏ†êÍ≥º ÎèôÍ∏∞Ìôî)
            const btn = document.querySelector('.box-btn');
            
            // Í∏∞Ï°¥ active ÌÅ¥ÎûòÏä§ Ï†úÍ±∞ ÌõÑ Îã§Ïãú Ï∂îÍ∞ÄÌïòÏó¨ Ïï†ÎãàÎ©îÏù¥ÏÖò Î¶¨ÏÖã Ìö®Í≥º
            btn.classList.remove('flash-active');
            void btn.offsetWidth; // Î¶¨ÌîåÎ°úÏö∞ Í∞ïÏ†ú (Ïï†ÎãàÎ©îÏù¥ÏÖò Ïû¨ÏãúÏûë Ìä∏Î¶¨Í±∞)
            btn.classList.add('flash-active');
            
            setTimeout(() => { btn.classList.remove('flash-active'); }, 150);

            // ... Í∏∞Ï°¥ Î°úÏßÅ Í∑∏ÎåÄÎ°ú Ïú†ÏßÄ ...
            const now = new Date();
            // (ÏïÑÎûò ÏΩîÎìúÎäî Í∏∞Ï°¥ addMoney Ìï®Ïàò ÎÇ¥Ïö©Í≥º ÎèôÏùºÌïòÍ≤å Ïú†ÏßÄÌïòÏÑ∏Ïöî)
            const y = now.getFullYear(); const m = String(now.getMonth() + 1).padStart(2, '0'); const d = String(now.getDate()).padStart(2, '0');
            const todayStr = `${y}-${m}-${d}`;
            const currentDay = now.getDate();
            if (currentDay !== state.savingsDay) { const dayStr = getOrdinal(state.savingsDay); showTooltip(`NOT YET, BOX ON THE ${dayStr}`); return; }
            if (state.lastDepositDate === todayStr) { showTooltip("ENOUGH NOW"); return; }
            const totalGoal = state.q1 + state.q2 + state.q3;
            state.currentAmount += state.depositUnit;
            if(state.currentAmount > totalGoal) state.currentAmount = totalGoal;
            state.lastDepositDate = todayStr;
            showTooltip("COPY THAT, BOXING NOW!"); 
            let checkS = state.currentAmount >= totalGoal ? 'FINISH' : state.currentAmount >= (state.q1 + state.q2) ? 'Q3' : state.currentAmount >= state.q1 ? 'Q2' : 'Q1';
            if (checkS !== state.lastSession && checkS !== 'Q1' && checkS !== 'FINISH') triggerCelebration(state.lastSession);
            state.lastSession = checkS;
            saveData(); updateDashboard(); 
        }
        function onYouTubeIframeAPIReady() {
            bgmPlayer = new YT.Player('bgm-player', {
                height: '0', width: '0', videoId: 'YhX_Woa3kVA', 
                playerVars: { 'autoplay': 0, 'controls': 0, 'loop': 1, 'playlist': 'YhX_Woa3kVA' },
                events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
            });
        }
        function onPlayerReady(event) {}
        function onPlayerStateChange(event) { if (event.data === YT.PlayerState.ENDED) bgmPlayer.playVideo(); }

        const driverList = [
            { id: 'VER', speed: 1.25 }, { id: 'NOR', speed: 1.22 }, { id: 'PIA', speed: 1.19 }, { id: 'HAM', speed: 1.18 }, { id: 'LEC', speed: 1.15 }, { id: 'ANT', speed: 1.12 },
            { id: 'RUS', speed: 1.12 }, { id: 'SAI', speed: 1.10 }, { id: 'ALO', speed: 1.08 }, { id: 'PER', speed: 1.05 },
            { id: 'GAS', speed: 1.02 }, { id: 'OCO', speed: 1.00 }, { id: 'ALB', speed: 0.98 }, { id: 'BEA', speed: 0.97 },
            { id: 'TSU', speed: 0.96 }, { id: 'STR', speed: 0.95 }, { id: 'HUL', speed: 0.96 }, 
            { id: 'LAW', speed: 1.05 }, { id: 'DOO', speed: 0.95 }, { id: 'BOR', speed: 0.94 }, { id: 'HAD', speed: 0.93 }
        ];

        let aiDrivers = [];

        function init() {
            document.getElementById('bg-track').setAttribute('d', singaporeCircuitPath);
            document.getElementById('active-track').setAttribute('d', singaporeCircuitPath);
            const container = document.getElementById('wave-container');
            container.innerHTML = '';
            
            const totalBars = 30;

            for(let i = 0; i < totalBars; i++) {
                const bar = document.createElement('div');
                bar.className = 'bar';
                
                // 1. ÏÇ¨Ïù∏Ìåå(Sine Wave)Î•º Ïù¥Ïö©Ìï¥ 0 -> 1 -> 0 ÌòïÌÉúÏùò 'ÏÇ∞ Î™®Ïñë' Í≥ÑÏàò ÏÉùÏÑ±
                // Math.PI * (i / totalBars) : 0ÏóêÏÑú ÌååÏù¥(180ÎèÑ)ÍπåÏßÄ ÏßÑÌñâ -> sinÍ∞íÏùÄ 0ÏóêÏÑú 1Ï∞çÍ≥† 0ÏúºÎ°ú
                const curve = Math.sin((i / (totalBars - 1)) * Math.PI); 

                // 2. Í∞ÄÏö¥Îç∞ÏùºÏàòÎ°ù Îçî ÎÜíÏù¥ Îõ∏ Ïàò ÏûàÎäî 'ÏµúÎåÄ ÌïúÍ≥ÑÏπò' ÏÑ§Ï†ï
                // Ïñë ÎÅùÏùÄ ÏµúÏÜå 5px, Í∞ÄÏö¥Îç∞Îäî ÏµúÎåÄ 18pxÍπåÏßÄ ÌóàÏö©
                const maxEnvelope = (14 * curve) + 4; 
                
                // 3. ÎûúÎç§ÏÑ±ÏùÑ Î∂ÄÏó¨ÌïòÎêò, ÏúÑÏóêÏÑú ÎßåÎì† Envelope(ÌïúÍ≥ÑÏπò)Î•º ÎÑòÏßÄ ÏïäÎèÑÎ°ù Ìï®
                // 0.6 ~ 1.0 ÏÇ¨Ïù¥Ïùò ÎûúÎç§ Ïä§ÏºÄÏùºÏùÑ Í≥±Ìï¥ 'ÏÇ¥ÏïÑÏûàÎäî' ÎäêÎÇå Î∂ÄÏó¨
                const randomHeight = maxEnvelope * (0.6 + Math.random() * 0.4);

                // CSS Î≥ÄÏàòÏóê Í≥ÑÏÇ∞Îêú ÎÜíÏù¥ Ï†ÑÎã¨
                bar.style.setProperty('--eq-height', `${randomHeight}px`);
                
                // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏÜçÎèÑÎèÑ Í∞ÄÏö¥Îç∞Í∞Ä ÏïΩÍ∞Ñ Îçî Îπ†Î•¥Í≤å Î∞òÏùëÌïòÎèÑÎ°ù ÏÑ§Ï†ï
                const speed = 0.2 + Math.random() * 0.3;
                bar.style.animation = `equalizer ${speed}s infinite ease-in-out`;
                // ÏãúÏûë ÌÉÄÏù¥Î∞çÏùÑ ÎûúÎç§ÌïòÍ≤å ÏÑûÏñ¥ ÏûêÏó∞Ïä§Îü¨ÏõÄ Ïó∞Ï∂ú
                bar.style.animationDelay = `${Math.random() * -1}s`;

                container.appendChild(bar);
            }
            loadData(); 
            // üí° 2030ÎÖÑ Ïã±Í∞ÄÌè¨Î•¥ GP ÎÇ†Ïßú ÏûêÎèô ÏÑ§Ï†ï (2025+5ÎÖÑ)
            if (!state.targetDate) state.targetDate = get2030SingaporeDate();
            
            generateTrackSpeedProfile();
            initAIDrivers();
            requestAnimationFrame(animateAIDrivers);
            updateDashboard();
            updateTeamSelectUI(); 
        }

        function initAIDrivers() {
            const layer = document.getElementById('ai-cars-layer');
            layer.innerHTML = ''; 
            aiDrivers = [];
            
            const midPoint = Math.ceil(driverList.length / 2);
            const topTier = driverList.slice(0, midPoint); 
            const bottomTier = driverList.slice(midPoint); 
            const shuffledTop = shuffleArray([...topTier]);
            const shuffledBottom = shuffleArray([...bottomTier]);
            const finalGrid = [...shuffledTop, ...shuffledBottom];

            finalGrid.forEach((d, index) => {
                const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                g.setAttribute("class", "ai-marker");
                g.setAttribute("data-id", d.id); 
                
                const dim = getMarkerDimensions(false);
                const isMobile = window.innerWidth < 600;

                const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                rect.setAttribute("x", -dim.rectW/2); rect.setAttribute("y", -dim.rectH - 10);
                rect.setAttribute("width", dim.rectW); rect.setAttribute("height", dim.rectH);
                
                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute("x", 0); text.setAttribute("y", -dim.rectH/2 - (isMobile ? 8 : 9));
                text.textContent = d.id;
                text.style.fontSize = `${dim.fontSize}px`;

                const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute("r", dim.circleR);

                g.appendChild(rect); g.appendChild(text); g.appendChild(circle);
                layer.appendChild(g);

                const startPos = 0.999;
                const gridGap = 0.015;
                const initialProgress = startPos - (index * gridGap);

                aiDrivers.push({
                    id: d.id, 
                    element: g,
                    baseSpeed: d.speed, 
                    progress: initialProgress,
                    actualSpeed: 0,
                    randomOffset: Math.random() * 1000,
                    fluctuation: 0
                });
            });
            
            updateRaceScenario();
        }

        function updateRaceScenario() {
            const heroId = getDriverShortId(state.driver);
            const layer = document.getElementById('ai-cars-layer');
            const isMobile = window.innerWidth < 600;

            aiDrivers.forEach(ai => {
                const originalData = driverList.find(d => d.id === ai.id);
                let speed = originalData ? originalData.speed : 1.0;

                const isHero = (ai.id === heroId);
                const g = ai.element;
                const rect = g.querySelector('rect');
                const text = g.querySelector('text');
                const circle = g.querySelector('circle');

                if (isHero) {
                    g.classList.add('hero-marker');
                    layer.appendChild(g);

                    if (ai.id === 'VER') {
                        speed = 1.25; 
                    } else {
                        speed = speed * 1.1; 
                        if (speed > 1.24) speed = 1.24; 
                    }
                } else {
                    g.classList.remove('hero-marker');
                }

                ai.baseSpeed = speed;

                const dim = getMarkerDimensions(isHero);
                rect.setAttribute("x", -dim.rectW/2); rect.setAttribute("y", -dim.rectH - 10);
                rect.setAttribute("width", dim.rectW); rect.setAttribute("height", dim.rectH);
                text.setAttribute("y", -dim.rectH/2 - (isMobile ? 8 : 9));
                text.style.fontSize = `${dim.fontSize}px`;
                circle.setAttribute("r", dim.circleR);
            });
        }

        function updateDriverStyles() {
            updateRaceScenario();
        }

        function activateEngine() {
            document.getElementById('start-engine-btn').style.display = 'none'; 
            if (bgmPlayer && bgmPlayer.playVideo) { bgmPlayer.setVolume(70); bgmPlayer.playVideo(); }
            startRaceSequence();
        }

        function startRaceSequence() {
            let lightCount = 1;
            const loadingText = document.querySelector('.loading-text');
            function turnOnNextLight() {
                if (lightCount <= 5) {
                    document.getElementById(`light-${lightCount}`).classList.add('on');
                    document.getElementById(`light-${lightCount}b`).classList.add('on');
                    lightCount++;
                    setTimeout(turnOnNextLight, 1000); 
                } else {
                    loadingText.innerText = "ENGINES READY...";
                    const randomDelay = Math.random() * 1300 + 200;
                    setTimeout(() => {
                        document.querySelectorAll('.f1-light').forEach(l => l.classList.remove('on'));
                        raceStarted = true; 
                        setTimeout(() => {
                            const overlay = document.getElementById('loading-overlay');
                            overlay.style.opacity = '0';
                            setTimeout(() => { overlay.style.display = 'none'; }, 300);
                        }, 200);
                    }, randomDelay);
                }
            }
            setTimeout(turnOnNextLight, 500);
        }

        function generateTrackSpeedProfile() {
            const track = document.getElementById('bg-track');
            const len = track.getTotalLength();
            const samples = 1000;
            trackSpeedProfile = []; 
            for(let i=0; i<samples; i++) {
                const p = i / samples;
                const pNext = (i + 1) % samples / samples;
                const pPrev = (i - 1 + samples) % samples / samples;
                const pt1 = track.getPointAtLength(pPrev * len);
                const pt2 = track.getPointAtLength(p * len);
                const pt3 = track.getPointAtLength(pNext * len);
                const angle1 = Math.atan2(pt2.y - pt1.y, pt2.x - pt1.x);
                const angle2 = Math.atan2(pt3.y - pt2.y, pt3.x - pt2.x);
                let diff = Math.abs(angle1 - angle2);
                if (diff > Math.PI) diff = 2 * Math.PI - diff; 
                let targetSpeedFactor = 1.0;
                if (diff < 0.05) targetSpeedFactor = 2.2; 
                else if (diff < 0.2) targetSpeedFactor = 1.0; 
                else targetSpeedFactor = 0.3; 
                trackSpeedProfile.push(targetSpeedFactor);
            }
        }

        function animateAIDrivers() {
            const track = document.getElementById('bg-track');
            const len = track.getTotalLength();
            const now = Date.now();

            aiDrivers.forEach((ai, idx) => {
                if (!raceStarted) {
                    const point = track.getPointAtLength(len * ai.progress);
                    const jitterX = (Math.random() - 0.5) * 1.5;
                    const jitterY = (Math.random() - 0.5) * 1.5;
                    ai.element.setAttribute('transform', `translate(${point.x + jitterX}, ${point.y + jitterY})`);
                    return; 
                }

                const fluctuation = Math.sin(now * 0.001 + ai.randomOffset) * 0.03;
                let dynamicSpeed = ai.baseSpeed * (1 + fluctuation);

                const mapIndex = Math.floor(ai.progress * 1000) % 1000;
                const targetFactor = trackSpeedProfile[mapIndex] * dynamicSpeed;

                if (ai.actualSpeed > targetFactor) ai.actualSpeed -= (ai.actualSpeed - targetFactor) * 0.15;
                else ai.actualSpeed += (targetFactor - ai.actualSpeed) * 0.01;
                
                const moveStep = ai.actualSpeed * 0.00025;
                ai.progress += moveStep;
                if (ai.progress >= 1) ai.progress -= 1;
                
                const point = track.getPointAtLength(len * ai.progress);
                ai.element.setAttribute('transform', `translate(${point.x}, ${point.y})`);
            });
            requestAnimationFrame(animateAIDrivers);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function getMarkerDimensions(isHero) {
            const isMobile = window.innerWidth < 600;
            let rectW, rectH, fontSize, circleR;
            if (isMobile) {
                 rectW = isHero ? 90 : 70; rectH = isHero ? 40 : 30; fontSize = isHero ? 24 : 20; circleR = 6;
            } else {
                 rectW = isHero ? 50 : 40; rectH = isHero ? 24 : 20; fontSize = isHero ? 16 : 14; circleR = 4;
            }
            return { rectW, rectH, fontSize, circleR };
        }

        function getDriverShortId(name) {
            if(!name) return 'UNK';
            if(name === 'VERSTAPPEN') return 'VER';
            if(name === 'ANTONELLI') return 'ANT';
            if(name === 'LECLERC') return 'LEC';
            if(name === 'HAMILTON') return 'HAM';
            if(name === 'NORRIS') return 'NOR';   // üí° [Ï∂îÍ∞Ä]
            if(name === 'PIASTRI') return 'PIA';  // üí° [Ï∂îÍ∞Ä]
            if(name === 'ALONSO') return 'ALO';
            if(name === 'STROLL') return 'STR';
            if(name === 'GASLY') return 'GAS';
            if(name === 'DOOHAN') return 'DOO';
            if(name === 'ALBON') return 'ALB';
            if(name === 'SAINZ') return 'SAI';
            if(name === 'TSUNODA') return 'TSU';
            if(name === 'HADJAR') return 'HAD';
            if(name === 'HULKENBERG') return 'HUL';
            if(name === 'BORTOLETO') return 'BOR';
            if(name === 'OCON') return 'OCO';
            if(name === 'BEARMAN') return 'BEA';
            if(name === 'RUSSELL') return 'RUS';
            if(name === 'LAWSON') return 'LAW';
            return name.substring(0,3).toUpperCase();
        }

        // üí° 2030ÎÖÑ Ïã±Í∞ÄÌè¨Î•¥ GP ÏòàÏÉÅ ÎÇ†Ïßú (9Ïõî ÎßàÏßÄÎßâ Ï£º ÏùºÏöîÏùº) Í≥ÑÏÇ∞
        function get2030SingaporeDate() {
            // 2030ÎÖÑ 9Ïõî 29Ïùº(Ïùº) ÏòàÏÉÅ
            return '2030-09-29';
        }

        function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
        function loadData() { 
            const stored = localStorage.getItem(STORAGE_KEY); 
            if (stored) {
                state = JSON.parse(stored);
                if (!state.team || !teamsDB[state.team]) {
                    state.team = 'redbull';
                    state.driver = 'VERSTAPPEN';
                }
            } 
        }
        function showTooltip(msg) { const tip = document.getElementById('msg-tooltip'); tip.innerText = msg; tip.classList.add('show'); setTimeout(() => tip.classList.remove('show'), 2500); }
        function getOrdinal(n) { const s = ["th", "st", "nd", "rd"]; const v = n % 100; return n + (s[(v - 20) % 10] || s[v] || s[0]); }

        function addMoney() {
            // üí° Î™®Î∞îÏùº Î≤ÑÌäº ÏãúÍ∞Å Ìö®Í≥º (Active Í∞ïÏ†ú Ìä∏Î¶¨Í±∞)
            const btn = document.querySelector('.box-btn');
            btn.classList.add('flash-active');
            setTimeout(() => { btn.classList.remove('flash-active'); }, 150);

            const now = new Date();
            const y = now.getFullYear(); const m = String(now.getMonth() + 1).padStart(2, '0'); const d = String(now.getDate()).padStart(2, '0');
            const todayStr = `${y}-${m}-${d}`;
            const currentDay = now.getDate();
            if (currentDay !== state.savingsDay) { const dayStr = getOrdinal(state.savingsDay); showTooltip(`NOT YET, BOX ON THE ${dayStr}`); return; }
            if (state.lastDepositDate === todayStr) { showTooltip("ENOUGH NOW"); return; }
            const totalGoal = state.q1 + state.q2 + state.q3;
            state.currentAmount += state.depositUnit;
            if(state.currentAmount > totalGoal) state.currentAmount = totalGoal;
            state.lastDepositDate = todayStr;
            showTooltip("COPY THAT, BOXING NOW!"); 
            let checkS = state.currentAmount >= totalGoal ? 'FINISH' : state.currentAmount >= (state.q1 + state.q2) ? 'Q3' : state.currentAmount >= state.q1 ? 'Q2' : 'Q1';
            if (checkS !== state.lastSession && checkS !== 'Q1' && checkS !== 'FINISH') triggerCelebration(state.lastSession);
            state.lastSession = checkS;
            saveData(); updateDashboard(); 
        }

        function triggerCelebration(sessionName) {
            const overlay = document.getElementById('celebration-overlay');
            overlay.style.display = 'flex'; 
            document.getElementById('lap-session-title').innerText = `[${sessionName}] FASTEST LAP`;
            document.getElementById('lap-driver-name').innerText = state.driver;
            const teamPrimary = getComputedStyle(document.body).getPropertyValue('--team-primary').trim();
            const teamAccent = getComputedStyle(document.body).getPropertyValue('--team-accent').trim();
            confetti({ particleCount: 200, spread: 80, origin: { y: 0.6 }, zIndex: 10001, colors: [teamPrimary, teamAccent, '#ffffff'] });
        }

        function closeCelebration() { document.getElementById('celebration-overlay').style.display = 'none'; }
        function syncTrackFill(target) {
            if (animId) cancelAnimationFrame(animId);
            const activeTrack = document.getElementById('active-track');
            const totalLength = activeTrack.getTotalLength();
            function frame() {
                let diff = target - visualProgress; 
                visualProgress += diff * 0.08;
                activeTrack.style.strokeDasharray = `${totalLength * visualProgress} ${totalLength}`;
                if (Math.abs(diff) > 0.0001) animId = requestAnimationFrame(frame);
            }
            frame();
        }

        function updateDashboard() {
            document.body.className = state.team;
            
            document.getElementById('display-name').innerHTML = `<span>${state.driver}</span>`;
            
            document.getElementById('disp-country').innerText = "SINGAPORE";
            document.getElementById('disp-circuit').innerText = "Marina Bay Street Circuit";

            const totalGoal = state.q1 + state.q2 + state.q3;
            let targetP = 0;
            let stepText = "[Q1]"; let nameText = "HOTEL";
            
            // Q1: Ìò∏ÌÖî ÌôïÎ≥¥ Íµ¨Í∞Ñ (160Îßå)
            if (state.currentAmount < state.q1) { 
                targetP = state.currentAmount / state.q1; 
                stepText = "[Q1]"; nameText = "HOTEL"; 
            } 
            // Q2: Ìï≠Í≥µÍ∂å ÌôïÎ≥¥ Íµ¨Í∞Ñ (ÎàÑÏ†Å 240Îßå)
            else if (state.currentAmount < (state.q1 + state.q2)) { 
                targetP = (state.currentAmount - state.q1) / state.q2; 
                stepText = "[Q2]"; nameText = "FLIGHT"; 
            } 
            // Q3: Ìã∞Ïºì Î∞è Ï≤¥Î•òÎπÑ Íµ¨Í∞Ñ (ÎàÑÏ†Å 500Îßå)
            else { 
                targetP = (state.currentAmount - (state.q1 + state.q2)) / state.q3; 
                stepText = "[Q3]"; nameText = "TICKET"; 
                if (state.currentAmount >= totalGoal) { targetP = 1; stepText = "POLE"; nameText = "POSITION"; } 
            } 
            
            document.getElementById('session-step').innerText = stepText;
            document.getElementById('session-name').innerText = nameText;
            document.getElementById('txt-current').innerText = `CUR ‚Ç©${state.currentAmount.toLocaleString()}`;
            document.getElementById('txt-goal').innerText = `TAR ‚Ç©${totalGoal.toLocaleString()}`;
            syncTrackFill(targetP);
            document.getElementById('savings-day').value = state.savingsDay;
            document.getElementById('deposit-unit').value = state.depositUnit;
            document.getElementById('manual-amount').value = state.currentAmount;
            document.getElementById('q1-goal').value = state.q1;
            document.getElementById('q2-goal').value = state.q2;
            document.getElementById('q3-goal').value = state.q3;
            document.getElementById('target-date').value = state.targetDate;
        }

        function calculateRecommendation() {
            const savingsDay = parseInt(document.getElementById('savings-day').value) || 1;
            const targetDateStr = document.getElementById('target-date').value;
            const curAmt = parseInt(document.getElementById('manual-amount').value) || 0;
            const q1 = parseInt(document.getElementById('q1-goal').value) || 0;
            const q2 = parseInt(document.getElementById('q2-goal').value) || 0;
            const q3 = parseInt(document.getElementById('q3-goal').value) || 0;
            const recBox = document.getElementById('rec-box');
            const recMsg = document.getElementById('rec-msg');
            if (!targetDateStr) { recBox.style.display = 'none'; return; }
            recBox.style.display = 'block';
            const totalGoal = q1 + q2 + q3;
            const remaining = totalGoal - curAmt;
            if (remaining <= 0) { recMsg.innerText = "GOAL REACHED! PUSH HARD!"; return; }
            const today = new Date();
            const targetDate = new Date(targetDateStr);
            if (targetDate <= today) { recMsg.innerText = "RACE DAY PASSED / INVALID DATE"; return; }
            let depositCount = 0;
            let tempDate = new Date(today);
            if (tempDate.getDate() > savingsDay) tempDate.setMonth(tempDate.getMonth() + 1);
            tempDate.setDate(savingsDay);
            while (tempDate <= targetDate) { depositCount++; tempDate.setMonth(tempDate.getMonth() + 1); }
            if (depositCount === 0) { recMsg.innerText = "IMMEDIATE FULL DEPOSIT REQUIRED"; } 
            else { const monthlyRec = Math.ceil(remaining / depositCount); recMsg.innerText = `REC: ‚Ç©${monthlyRec.toLocaleString()} / month (${depositCount} stops)`; }
        }

        function openSettings() { 
            document.getElementById('settings-modal').style.display = 'flex'; 
            updateTeamSelectUI(); 
            calculateRecommendation(); 
        }

        function saveAndCloseSettings() {
            state.team = document.getElementById('team-select').value;
            state.driver = document.getElementById('driver-select').value;
            
            state.savingsDay = Number(document.getElementById('savings-day').value);
            state.depositUnit = Number(document.getElementById('deposit-unit').value);
            state.currentAmount = Number(document.getElementById('manual-amount').value);
            state.q1 = Number(document.getElementById('q1-goal').value);
            state.q2 = Number(document.getElementById('q2-goal').value);
            state.q3 = Number(document.getElementById('q3-goal').value);
            state.targetDate = document.getElementById('target-date').value;
            
            saveData(); 
            updateDashboard(); 
            updateRaceScenario(); 
            document.getElementById('settings-modal').style.display = 'none';
        }
        
        function setDriver(d) { /* UI Î≥ÄÍ≤ΩÏö©, Ïã§Ï†ú Ï†ÄÏû•ÏùÄ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú */ }

        function updateDriverList(teamKey) {
            const driverSelect = document.getElementById('driver-select');
            driverSelect.innerHTML = ''; 
            
            const teamInfo = teamsDB[teamKey];
            if (teamInfo) {
                teamInfo.drivers.forEach(dName => {
                    const option = document.createElement('option');
                    option.value = dName;
                    option.text = dName;
                    driverSelect.appendChild(option);
                });
                
                if (teamInfo.drivers.includes(state.driver) && state.team === teamKey) {
                    driverSelect.value = state.driver;
                } else {
                    driverSelect.selectedIndex = 0;
                }
            }
            document.body.className = teamKey; 
        }

        function updateTeamSelectUI() {
            const selectBox = document.getElementById('team-select');
            if(selectBox) {
                selectBox.value = state.team;
                updateDriverList(state.team); 
                const driverBox = document.getElementById('driver-select');
                if(driverBox) driverBox.value = state.driver;
            }
        }

        init();
    </script>
</body>
</html>
