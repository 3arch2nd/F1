<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#121212">
    <title>Race to World Tour</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Michroma&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --bg-color: #121212;
            --text-color: #ffffff;
            --font-display: 'Michroma', sans-serif;
            --gray-track: rgba(255, 255, 255, 0.4);
            --f1-purple: #B624FF;
            --team-bg: #060025;
            --team-radio-bg: rgba(6, 0, 37, 0.95);
            --team-primary: #3671C6;
            --team-accent: #FF1E00;
            --track-active-color: var(--f1-purple);
            --marker-bg: #3671C6;
            --marker-text: #ffffff;
            --dynamic-stroke: 10px;
        }

/* 1. üìä Î¶¨ÎçîÎ≥¥Îìú Ïª®ÌÖåÏù¥ÎÑà (ÎÜíÏù¥ ÏûêÎèô Ï°∞Ï†à) */
        #leaderboard {
            position: absolute;
            top: 240px;  /* ÏÉÅÎã® Ìó§Îçî ÏïÑÎûò */
            left: 20px;
            width: 160px;
            z-index: 900;
            display: flex;
            flex-direction: column;
            gap: 3px;
            pointer-events: none; /* ÌÅ¥Î¶≠ ÌÜµÍ≥º */
            
            /* üí° ÌïµÏã¨: Î¶¨ÎçîÎ≥¥Îìú ÎÜíÏù¥Í∞Ä Î≤ÑÌäºÏùÑ Ïπ®Î≤îÌïòÏßÄ ÏïäÎèÑÎ°ù Í≥ÑÏÇ∞ */
            /* Ï†ÑÏ≤¥ ÎÜíÏù¥ - (ÏÉÅÎã®Ïó¨Î∞± 240px + ÌïòÎã®Î≤ÑÌäºÏòÅÏó≠ 90px) */
            max-height: calc(100vh - 330px);
            overflow: hidden; /* ÎÑòÏπòÎ©¥ ÏûòÎ¶º */
            
            /* Ïä¨ÎùºÏù¥Îî© Ïï†ÎãàÎ©îÏù¥ÏÖò */
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;
            transform-origin: left center;
        }

        /* Ïà®ÍπÄ ÏÉÅÌÉú: ÌôîÎ©¥ ÏôºÏ™Ω Î∞ñÏúºÎ°ú Ïù¥Îèô */
        #leaderboard.hidden {
            transform: translateX(-180px) !important;
            opacity: 0;
        }

        /* üö® Ï§ëÏöî: Í∏∞Ï°¥Ïóê ÏûàÎçò @media display: none ÏΩîÎìúÎ•º Ïó¨Í∏∞ÏÑú ÏÇ≠Ï†úÌïòÍ±∞ÎÇò ÎçÆÏñ¥ÏîÅÎãàÎã§. */
        /* Ïù¥Ï†ú Î™®Î∞îÏùºÏóêÏÑúÎèÑ display: noneÏù¥ ÎêòÏßÄ ÏïäÍ≥†, Îã®ÏßÄ .hidden ÌÅ¥ÎûòÏä§Î°ú ÏúÑÏπòÎßå Ïù¥ÎèôÌï©ÎãàÎã§. */
        @media (max-width: 767px) {
            #leaderboard { display: flex; } /* Í∞ïÏ†úÎ°ú Î≥¥Ïù¥Í≤å ÏÑ§Ï†ï (ÏúÑÏπò Ïù¥ÎèôÏúºÎ°ú Ï†úÏñ¥) */
        }


        /* 2. üîò ÌÜ†Í∏Ä Î≤ÑÌäº Ïª®ÌÖåÏù¥ÎÑà (ÏúÑÏπò Í≥†Ï†ï) */
        .leaderboard-toggle-container {
            position: absolute;
            bottom: 40px; /* Ïò§ÎîîÏò§ Î≤ÑÌäºÍ≥º ÎÜíÏù¥ ÎßûÏ∂§ */
            left: 30px;
            z-index: 950;
        }

        /* 3. üîò ÌÜ†Í∏Ä Î≤ÑÌäº ÎîîÏûêÏù∏ (Solid Circle Style) */
        #lb-toggle-btn {
            /* üí° ÏöîÏ≤≠ÌïòÏã† ÎîîÏûêÏù∏: ÍΩâ Ï∞¨ ÏõêÌòï Î≤ÑÌäº */
            background-color: var(--team-primary); /* ÌåÄ Í≥†Ïú† ÏÉâÏÉÅÏúºÎ°ú Ï±ÑÏõÄ */
            border: 2px solid rgba(255, 255, 255, 0.2); /* ÏùÄÏùÄÌïú ÌÖåÎëêÎ¶¨ */
            color: #ffffff; /* Í∏ÄÏûêÏÉâ Ìù∞ÏÉâ */
            
            width: 44px;  /* ÌÅ¨Í∏∞ ÏÇ¥Ïßù ÌÇ§ÏõÄ */
            height: 44px;
            border-radius: 50%; /* ÏôÑÎ≤ΩÌïú ÏõêÌòï */
            
            font-family: var(--font-display);
            font-size: 24px;
            font-weight: 400; /* ÎÑàÎ¨¥ ÎëêÍªçÏßÄ ÏïäÍ≤å */
            
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            
            /* Í∑∏Î¶ºÏûê & Ïï†ÎãàÎ©îÏù¥ÏÖò */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.6);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Ï´ÄÎìùÌïú ÎäêÎÇå */
            padding: 0;
            padding-bottom: 4px; /* ÌÖçÏä§Ìä∏ ÏàòÏßÅ Ï§ëÏïô ÎØ∏ÏÑ∏ Î≥¥Ï†ï */
            line-height: 1;
        }

        /* Ìò∏Î≤Ñ Ìö®Í≥º */
        #lb-toggle-btn:hover {
            transform: scale(1.15); /* Ïª§Ïßê */
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.8);
            border-color: #fff;
        }

        /* ÌÅ¥Î¶≠(ÌôúÏÑ±) Ìö®Í≥º */
        #lb-toggle-btn:active {
            transform: scale(0.95);
        }

        /* 3. üìù Ìñâ(Row) Ïä§ÌÉÄÏùº (Ïú†ÏßÄ) */
        .lb-row {
            display: flex;
            align-items: center;
            height: 32px;
            background: rgba(0, 0, 0, 0.88);
            border-radius: 4px;
            overflow: hidden;
            transition: transform 0.4s;
            position: absolute;
            width: 100%;
            box-shadow: 0 4px 8px rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .lb-pos { width: 32px; text-align: center; font-size: 13px; font-weight: 900; color: #ffffff !important; font-family: var(--font-display); text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .lb-color-strip { width: 6px; height: 100%; }
        .lb-name { flex: 1; font-size: 13px; font-weight: bold; color: #ffffff; font-family: var(--font-display); padding-left: 10px; letter-spacing: 0.5px; white-space: nowrap; }

        /* 4. üì± Î∞òÏùëÌòï Ï¥àÍ∏∞ ÏÉÅÌÉú ÏÑ§Ï†ï */
        /* PC: Í∏∞Î≥∏ Î≥¥ÏûÑ (Ïà®ÍπÄ ÌÅ¥ÎûòÏä§ ÏóÜÏùå) */
        /* Î™®Î∞îÏùº/ÏûëÏùÄ ÌôîÎ©¥: Í∏∞Î≥∏ Ïà®ÍπÄ (JSÏóêÏÑú Ï≤òÎ¶¨ÌïòÍ±∞ÎÇò CSSÎ°ú Ï¥àÍ∏∞ ÏúÑÏπò ÏßÄÏ†ï) */
        @media (max-width: 768px) {
            /* Î™®Î∞îÏùºÏóêÏÑúÎäî Í∏∞Î≥∏Ï†ÅÏúºÎ°ú Ïà®Í≤®ÏßÑ ÏÉÅÌÉúÎ°ú ÏãúÏûë */
            /* JS init()ÏóêÏÑú ÌÅ¥ÎûòÏä§Î•º Ï∂îÍ∞ÄÌï† ÏòàÏ†ï */
        }

        /* üí° [ÏàòÏ†ï] Í∏ÄÏûêÍ∞Ä Í∏∏Ïñ¥ÎèÑ Ï†àÎåÄ Ï§ÑÎ∞îÍøà Ïïà ÎêòÍ≤å ÏÑ§Ï†ï & Ï§ëÏïô Ï†ïÎ†¨ ÎäêÎÇå */
        #race-status-display {
            position: absolute;
            top: 195px;
            left: 15px;
            width: auto;
            min-width: 120px;
            padding: 0 12px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 11px;
            font-family: var(--font-display);
            border-radius: 4px;
            z-index: 901;
            opacity: 0;
            transition: opacity 0.3s;
            letter-spacing: 1px;
            white-space: nowrap; /* üö® ÌïµÏã¨: Ï§ÑÎ∞îÍøà Ï†àÎåÄ Í∏àÏßÄ */
            box-sizing: border-box;
        }

        /* ÏÉÅÌÉúÎ≥Ñ Ïä§ÌÉÄÏùº */
        .status-sc { background-color: #FF8700; color: #000; box-shadow: 0 0 10px #FF8700; }
        .status-yellow { background-color: #FFD700; color: #000; box-shadow: 0 0 10px #FFD700; }
        .status-green { background-color: #00D632; color: #fff; box-shadow: 0 0 10px #00D632; }

        /* Í≥†Ïû•ÎÇú Ï∞®Îüâ Ïä§ÌÉÄÏùº (ÍπúÎπ°ÏûÑ) */
        .ai-marker.stopped rect { fill: #333 !important; stroke: #FF0000 !important; stroke-width: 2px; }
        .ai-marker.stopped text { fill: #FF0000 !important; }

        /* Ìñâ ÎÜíÏù¥ Î∞è Ìè∞Ìä∏ Ï∂ïÏÜå */
        .lb-row {
            display: flex;
            align-items: center;
            height: 20px; /* 24px -> 20pxÎ°ú Ï∂ïÏÜå */
            background: rgba(0, 0, 0, 0.8);
            border-radius: 2px;
            overflow: hidden;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: absolute;
            width: 100%;
        }

        .lb-pos {
            width: 22px; /* ÎÑàÎπÑ Ï∂ïÏÜå */
            text-align: center;
            font-size: 9px; /* Ìè∞Ìä∏ Ï∂ïÏÜå */
            font-weight: bold;
            color: #ffffff !important;
            font-family: var(--font-display);
        }

        .lb-color-strip {
            width: 3px; /* 4px -> 3px */
            height: 100%;
        }

        .lb-name {
            flex: 1;
            font-size: 10px; /* 12px -> 10px */
            font-weight: bold;
            color: #ffffff;
            font-family: var(--font-display);
            letter-spacing: 0px;
            padding-left: 5px;
        }

        /* Team Styles */
        body.redbull { --team-bg: #060025; --team-radio-bg: rgba(6, 0, 37, 0.95); --team-primary: #3671C6; --team-accent: #FCD116; --track-active-color: var(--f1-purple); --marker-bg: #FFEC00; --marker-text: #000000; }
        body.redbull .driver-name span, body.redbull #txt-current { color: #3671C6 !important; text-shadow: 0 0 2px rgba(0, 0, 0, 0.5); }
        body.redbull #txt-goal { color: rgba(255, 255, 255, 0.6); }
        body.redbull .radio-label { color: #ffffff !important; }
        body.redbull .box-btn { color: #FF1E00; border-color: #FF1E00; }
        @media (hover: hover) and (pointer: fine) { body.redbull .box-btn:hover { background-color: #FF1E00; color: #fff; box-shadow: 0 0 20px rgba(255, 30, 0, 0.6); } }
        body.redbull .box-btn:active, body.redbull .box-btn.flash-active { background-color: #FF1E00 !important; color: #fff !important; box-shadow: 0 0 20px rgba(255, 30, 0, 0.8) !important; }

        body.mercedes { --team-bg: #121212; --team-radio-bg: rgba(20, 20, 20, 0.95); --team-primary: #00D2BE; --team-accent: #00D2BE; --track-active-color: var(--f1-purple); --marker-bg: #00D2BE; --marker-text: #000000; }
        body.ferrari { --team-bg: #1A0000; --team-radio-bg: rgba(40, 0, 0, 0.95); --team-primary: #FF2800; --team-accent: #FFF200; --track-active-color: var(--f1-purple); --marker-bg: #FF2800; --marker-text: #ffffff; }
        body.mclaren { --team-bg: #151515; --team-radio-bg: rgba(21, 21, 21, 0.95); --team-primary: #FF8000; --team-accent: #FF8000; --track-active-color: var(--f1-purple); --marker-bg: #FF8000; --marker-text: #000000; }
        body.mclaren .box-btn { color: #FF8000; border-color: #FF8000; }
        @media (hover: hover) and (pointer: fine) { body.mclaren .box-btn:hover { background-color: #FF8000; color: #000000; box-shadow: 0 0 20px rgba(255, 128, 0, 0.6); } }
        body.mclaren .box-btn:active, body.mclaren .box-btn.flash-active { background-color: #FF8000 !important; color: #000000 !important; box-shadow: 0 0 20px rgba(255, 128, 0, 0.8) !important; }
        
        body.astonmartin { --team-bg: #002420; --team-primary: #CEDC00; --team-accent: #CEDC00; }
        body.alpine { --team-bg: #00102A; --team-primary: #0090FF; --team-accent: #FD4BC7; }
        body.williams { --team-bg: #040015; --team-primary: #00A0DE; --team-accent: #FFFFFF; }
        body.rb { --team-bg: #040814; --team-primary: #3671C6; --team-accent: #00D632; }
        body.sauber { --team-bg: #1C1C1C; --team-primary: #C0C0C0; --team-accent: #FF0000; }
        body.haas { --team-bg: #000000; --team-primary: #E6002B; --team-accent: #FFFFFF; }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: var(--team-bg); color: var(--text-color); font-family: var(--font-display); height: 100vh; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; transition: background 0.5s ease; }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.3s ease-out; }
        .lights-container { display: flex; gap: 15px; padding: 20px; background: #111; border-radius: 10px; border: 2px solid #333; margin-bottom: 30px; }
        .light-pair { display: flex; flex-direction: column; gap: 5px; }
        .f1-light { width: 40px; height: 40px; background-color: rgba(255, 0, 0, 0.2); border-radius: 50%; border: 3px solid #222; transition: all 0.1s ease; }
        .f1-light.on { background-color: #ff0000; box-shadow: 0 0 30px #ff0000, 0 0 10px #ff0000 inset; border-color: #500; }
        .loading-text { color: #fff; font-family: var(--font-display); font-size: 14px; letter-spacing: 2px; animation: blink 1s infinite; margin-bottom: 20px; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        #start-engine-btn { background: transparent; color: #fff; border: 2px solid #fff; padding: 15px 40px; font-family: var(--font-display); font-size: 16px; font-weight: bold; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; transition: all 0.3s ease; box-shadow: 0 0 15px rgba(255,255,255,0.2); }
        #start-engine-btn:hover { background: #fff; color: #000; box-shadow: 0 0 30px rgba(255,255,255,0.6); }
        #bgm-player { position: absolute; top: -9999px; left: -9999px; visibility: hidden; pointer-events: none; }

        .header-container { position: absolute; top: 0; left: 0; width: 100%; padding: 40px 20px 0 20px; display: flex; gap: 15px; z-index: 100; align-items: flex-start; justify-content: space-between; }
        .logo-box { flex: 0 1 auto; width: auto; background: transparent; border: none; display: flex; flex-direction: column; justify-content: flex-start; align-items: flex-start; padding: 0; }
        .f1-logo { width: 60px; height: auto; object-fit: contain; filter: brightness(0) invert(1); margin-bottom: 15px; }
        .circuit-info { text-align: left; margin-top: 0; width: 100%; }
        .circuit-country { font-size: 10px; color: var(--team-accent); font-weight: bold; letter-spacing: 1px; text-transform: uppercase; }
        .circuit-name { font-size: 9px; color: rgba(255,255,255,0.7); font-weight: normal; margin-top: 2px; line-height: 1.2; white-space: nowrap; }
        .status-container { display: flex; flex-direction: row; align-items: center; gap: 6px; margin-top: 15px; }
        .session-step { font-size: 11px; font-weight: bold; color: var(--team-accent); letter-spacing: 1px; }
        .session-name { font-size: 11px; font-weight: bold; color: #fff; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; }

        .radio-box { flex: 0 0 auto; width: 180px; background: var(--team-radio-bg); border: 4px solid rgba(255, 255, 255, 0.1); border-radius: 4px; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.8); margin-left: auto; border: 1px solid rgba(255,255,255,0.2); }
        .radio-content-section { padding: 15px 10px 20px 10px; display: flex; flex-direction: column; gap: 12px; justify-content: center; flex: 1; }
        .radio-top-section { padding: 8px 8px 0px 8px; text-align: right; overflow: hidden; }
        .driver-name { font-size: 13px; font-weight: bold; color: #fff; text-transform: uppercase; letter-spacing: -0.5px; transform: scaleX(1.1); transform-origin: right; display: inline-block; white-space: nowrap; }
        .driver-name span { color: var(--team-accent); }
        .radio-label { display: block; margin-top: 2px; font-size: 8px; font-weight: bold; color: #fff; letter-spacing: 2px; opacity: 0.8; }
        .audio-wave-divider { width: 100%; height: 20px; display: flex; justify-content: space-between; align-items: flex-end; padding: 0 5px; margin: 5px 0; }
        .bar { flex: 1; margin: 0 1px; background-color: var(--team-primary); transform-origin: bottom; height: 3px; border-radius: 0; }
        @keyframes equalizer { 0%, 100% { height: 3px; } 50% { height: var(--eq-height, 10px); } }
        .quote-box { font-family: var(--font-display); font-style: italic; font-weight: 400; font-size: 11px; letter-spacing: -0.5px; line-height: 1.5; color: rgba(255, 255, 255, 0.6); }
        .quote-box::before { content: "‚Äú"; color: rgba(255, 255, 255, 0.6); margin-right: 4px; }
        .quote-box::after { content: "‚Äù"; color: rgba(255, 255, 255, 0.6); margin-left: 4px; }
        .top-msg { text-align: left; }
        .bottom-data { text-align: right; color: var(--team-accent); }
        .amount-container { display: inline-block; text-align: right; }
        .amount-row { display: block; line-height: 1.2; font-size: 11px; font-weight: bold; }
        .amount-goal { font-size: 9px; color: rgba(255,255,255,0.6); margin-top: 2px; font-family: var(--font-display); font-weight: normal; }

        .track-container { 
            flex: 1; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            position: relative; 
            overflow: hidden; 
            min-height: 0; 
            
            /* üì± [Î™®Î∞îÏùº Í∏∞Î≥∏] */
            padding: 190px 20px 60px 20px; 
        }

        /* üíª [Îç∞Ïä§ÌÅ¨ÌÉë/ÌÉúÎ∏îÎ¶ø] */
        @media (min-width: 768px) {
            .track-container {
                padding: 150px 120px 40px 100px; 
            }
        }

        svg.track-svg { 
            width: 100%; 
            height: 100%; 
            
            /* üí° [ÌïµÏã¨] Í∏∞Ï°¥ 800px Ï†úÌïúÏùÑ ÌíÄÍ≥†, Îç∞Ïä§ÌÅ¨ÌÉëÏóêÏÑú Ìõ®Ïî¨ Ïª§ÏßÄÎèÑÎ°ù ÏÑ§Ï†ï */
            max-width: 1400px;  
            
            /* ÎÑàÎ¨¥ ÏúÑÏïÑÎûòÎ°ú Í∏∏Ïñ¥ÏßÄÎäî Í≤ÉÏùÑ Î∞©ÏßÄ (ÌôîÎ©¥ ÎÜíÏù¥Ïùò 80%ÍπåÏßÄÎßå) */
            max-height: 80vh; 
            
            overflow: visible; 
            transition: all 0.5s ease; /* ÌÅ¨Í∏∞ Î≥ÄÌï† Îïå Î∂ÄÎìúÎüΩÍ≤å */
        }
        /* üí° Ìä∏Îûô ÍµµÍ∏∞ Ï°∞Ï†ï (14 -> 10) */
        .track-path-bg { 
            fill: none; 
            stroke: var(--gray-track); 
            stroke-width: var(--dynamic-stroke); 
            stroke-linecap: round; 
            stroke-linejoin: round; 
        }
        .track-path-active { 
            fill: none; 
            stroke: var(--track-active-color); 
            stroke-width: var(--dynamic-stroke); 
            stroke-linecap: round; 
            stroke-linejoin: round; 
            filter: drop-shadow(0 0 10px var(--track-active-color)); 
            transition: stroke-dasharray 0.5s ease, stroke 0.5s ease; 
        }

        .checker-box { stroke: none; }
        .checker-white { fill: #fff; }
        .checker-black { fill: #000; }

        /* üí° [ÏàòÏ†ï] SC ÎßàÏª§: Í≤ÄÏ†ï Î∞∞Í≤Ω + Ï£ºÌô© ÌÖåÎëêÎ¶¨ (Î™ÖÌôïÌïú Íµ¨Î∂Ñ) */
        .sc-marker rect {
            fill: #000000 !important; /* Í≤ÄÏ†ïÏÉâ */
            stroke: #FF8700 !important; /* Ï£ºÌô©ÏÉâ Ïô∏Í≥ΩÏÑ† */
            stroke-width: 2.5px;
            box-shadow: 0 0 15px #FF8700;
        }
        .sc-marker text {
            fill: #FF8700 !important; /* Í∏ÄÏûêÎèÑ Ï£ºÌô©ÏÉâ */
            font-weight: 900;
            font-size: 13px; /* Í∏ÄÏûê ÏÇ¥Ïßù ÌÇ§ÏõÄ */
        }
        /* ÍπúÎπ°ÏûÑ Ïï†ÎãàÎ©îÏù¥ÏÖò Ïú†ÏßÄ */
        .sc-marker {
            animation: sc-blink 0.5s infinite alternate;
            z-index: 2000 !important;
        }

        @keyframes sc-blink {
            from { filter: drop-shadow(0 0 2px #FF8700); }
            to { filter: drop-shadow(0 0 10px #FF8700); }
        }
        .ai-marker { cursor: default; pointer-events: none; }
        .ai-marker circle { fill: #555; stroke: none; transition: fill 0.3s; }
        .ai-marker rect { fill: #222; rx: 4; opacity: 0.9; transition: fill 0.3s, stroke 0.3s; stroke: none; }
        .ai-marker text { fill: #fff; font-weight: 900; font-family: var(--font-display); text-anchor: middle; dominant-baseline: middle; transition: fill 0.3s; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        .ai-marker.hero-marker rect { fill: var(--marker-bg) !important; stroke: none !important; opacity: 1; }
        .ai-marker.hero-marker text { fill: var(--marker-text) !important; font-weight: 900; text-shadow: none; }
        .ai-marker.hero-marker circle { fill: var(--team-accent) !important; r: 5; }
        .ai-marker.hero-marker { z-index: 999; filter: drop-shadow(0 0 8px var(--marker-bg)); }

        .controls { padding: 20px 30px 40px 30px; text-align: center; z-index: 20; position: relative; margin-top: auto; flex-shrink: 0; }
        .box-btn { background-color: transparent; color: var(--team-primary); font-family: var(--font-display); font-size: 18px; font-weight: bold; border: 2px solid var(--team-primary); padding: 18px 50px; border-radius: 4px; text-transform: uppercase; cursor: pointer; box-shadow: none; transition: transform 0.1s ease, box-shadow 0.1s ease, background-color 0.1s; position: relative; width: 100%; max-width: 300px; -webkit-tap-highlight-color: transparent; outline: none; }
        @media (hover: hover) and (pointer: fine) { .box-btn:hover { background-color: var(--team-primary); color: #000; transform: scale(1.02); box-shadow: 0 0 15px var(--team-primary); } }
        .box-btn:active, .box-btn.flash-active { transform: scale(0.96); background-color: var(--team-primary) !important; color: #000 !important; box-shadow: 0 0 15px var(--team-primary) !important; transition: none; }

        /* üí° [ÏàòÏ†ï] Ïä§ÌîºÏª§ ÏïÑÏù¥ÏΩò: ÏôºÏ™Ω -> Ïò§Î•∏Ï™Ω ÎÅùÏúºÎ°ú Ïù¥Îèô */
        .audio-container { 
            position: absolute; 
            bottom: 40px; 
            right: 30px; /* left: 30px ÏóêÏÑú rightÎ°ú Î≥ÄÍ≤Ω */
            z-index: 50; 
        }
        .audio-btn { background: transparent; border: none; padding: 5px; cursor: pointer; opacity: 0.6; transition: opacity 0.3s; display: flex; align-items: center; justify-content: center; }
        .audio-btn:hover { opacity: 1; }
        .audio-icon { width: 24px; height: 24px; fill: #888; }

        .tooltip { position: absolute; bottom: calc(100% + 15px); left: 50%; transform: translateX(-50%) translateY(10px); background: #000; color: #fff; border: 2px solid var(--team-primary); padding: 10px 16px; border-radius: 4px; font-size: 11px; font-family: var(--font-display); white-space: nowrap; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s, transform 0.3s; box-shadow: 0 5px 20px rgba(0,0,0,0.8); }
        .tooltip.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border: 8px solid transparent; border-top-color: var(--team-primary); }
        
        .settings-btn { background: none; border: 1px solid #555; color: #888; padding: 10px 20px; margin-top: 20px; border-radius: 4px; font-size: 11px; cursor: pointer; font-family: var(--font-display); text-transform: uppercase; letter-spacing: 1px; transition: all 0.3s ease; }
        .settings-btn:hover { border-color: #fff; color: #fff; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 5000; justify-content: center; align-items: center; }
        /* 1. Î™®Îã¨ Ïª®ÌÖêÏ∏†: Flex Î∞ïÏä§Î°ú Î≥ÄÍ≤ΩÌïòÏó¨ ÎÇ¥Î∂Ä ÏòÅÏó≠ Î∂ÑÌï† */
        .modal-content { 
            background: var(--team-radio-bg); 
            /* padding: 25px;  <- Í∏∞Ï°¥ Ìå®Îî© ÏÇ≠Ï†ú (ÎÇ¥Î∂Ä ÏöîÏÜåÏóê Í∞ÅÍ∞Å Ï†ÅÏö©) */
            padding: 0; 
            border-radius: 4px; 
            width: 90%; 
            max-width: 400px; 
            border: 1px solid var(--team-accent); 
            
            /* üí° ÌïµÏã¨: ÎÜíÏù¥ Í≥†Ï†ï Î∞è Flex Íµ¨Ï°∞ ÏÑ§Ï†ï */
            max-height: 80vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; /* Ï†ÑÏ≤¥ Ïä§ÌÅ¨Î°§ Î∞©ÏßÄ */
        }

        /* 2. Ìó§Îçî (ÌÉÄÏù¥ÌãÄ): Í≥†Ï†ï */
        .modal-header {
            padding: 25px 25px 10px 25px; /* ÏúÑ, Ï¢åÏö∞ Ìå®Îî© */
            flex-shrink: 0; /* Ï§ÑÏñ¥Îì§ÏßÄ ÏïäÏùå */
        }
        .modal h2 { margin-bottom: 0; } /* ÎßàÏßÑ Ï°∞Ï†ï */

        /* 3. Î≥∏Î¨∏ (ÏûÖÎ†•Ï∞ΩÎì§): ÎÇ®ÏùÄ Í≥µÍ∞Ñ Ï∞®ÏßÄ & Ïä§ÌÅ¨Î°§ Í∞ÄÎä• */
        .modal-body {
            flex: 1; /* ÎÇ®ÏùÄ ÎÜíÏù¥ Î™®Îëê Ï∞®ÏßÄ */
            overflow-y: auto; /* ÎÇ¥Ïö© ÎÑòÏπòÎ©¥ Ïó¨Í∏∞ÏÑúÎßå Ïä§ÌÅ¨Î°§ */
            padding: 10px 25px; /* Ï¢åÏö∞ Ìå®Îî© Ïú†ÏßÄ */
            min-height: 0; /* Flexbox Î≤ÑÍ∑∏ Î∞©ÏßÄ */
        }

        /* 4. Ìë∏ÌÑ∞ (Î≤ÑÌäº): ÌïòÎã® Í≥†Ï†ï */
        .modal-footer {
            padding: 15px 25px 25px 25px; /* ÏïÑÎûò, Ï¢åÏö∞ Ìå®Îî© */
            background: var(--team-radio-bg); /* Î≥∏Î¨∏ ÏúÑÎ°ú Îñ† ÏûàÎäî ÎäêÎÇå */
            border-top: 1px solid rgba(255,255,255,0.1); /* Íµ¨Î∂ÑÏÑ† (ÏÑ†ÌÉùÏÇ¨Ìï≠) */
            flex-shrink: 0; /* Ï§ÑÏñ¥Îì§ÏßÄ ÏïäÏùå */
            z-index: 10;
        }

        /* Ïä§ÌÅ¨Î°§Î∞î ÎîîÏûêÏù∏ (Webkit) - Îã§ÌÅ¨ ÌÖåÎßàÏóê ÎßûÍ≤å */
        .modal-body::-webkit-scrollbar { width: 6px; }
        .modal-body::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
        .modal-body::-webkit-scrollbar-thumb { background: var(--team-primary); border-radius: 3px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 9px; color: rgba(255,255,255,0.7); margin-bottom: 6px; font-family: var(--font-display); text-transform: uppercase; }
        .input-group input, .input-group select { width: 100%; padding: 10px; background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.2); color: #fff; font-family: var(--font-display); font-size: 12px; color-scheme: dark; outline: none; }
        .input-group select option { background: #222; color: #fff; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); opacity: 0.8; cursor: pointer; }
        
        .close-btn { width: 100%; padding: 16px; background: transparent; color: var(--team-accent); border: 2px solid var(--team-accent); margin-top: 15px; font-weight: 900; font-family: var(--font-display); text-transform: uppercase; cursor: pointer; letter-spacing: 2px; transition: background 0.2s, color 0.2s; }
        .close-btn:hover { background: var(--team-accent); color: #000; }
        .recommendation-box { margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.5); border-left: 3px solid var(--team-accent); }
        .rec-title { font-size: 9px; color: #aaa; text-transform: uppercase; margin-bottom: 5px; font-family: var(--font-display); }
        .rec-value { font-size: 14px; color: var(--team-accent); font-weight: bold; font-family: var(--font-display); }
        
        #celebration-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
        .celebration-content { background: #000; border: 2px solid var(--team-primary); border-radius: 12px; width: 85%; max-width: 400px; padding: 40px 20px; text-align: center; box-shadow: none; border: 2px solid var(--team-primary); animation: slideUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .fastest-lap-title { color: var(--team-primary); font-family: var(--font-display); font-size: 12px; letter-spacing: 4px; margin-bottom: 12px; font-weight: 900; }
        .fastest-lap-driver { color: #fff; font-family: var(--font-display); font-size: 26px; font-weight: 900; text-transform: uppercase; margin-bottom: 30px; letter-spacing: -1px; }
        .next-session-btn { background: var(--team-primary); color: #fff; border: none; padding: 16px 30px; font-family: var(--font-display); font-size: 11px; font-weight: 900; border-radius: 4px; cursor: pointer; text-transform: uppercase; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
/* üì± [Ïã†Í∑ú] Î™®Î∞îÏùº Ï†ÑÏö© ÏÉÅÌÉú Ìå®ÎÑê Ïä§ÌÉÄÏùº */
        .status-panel {
            display: none; /* ÌèâÏÜåÏóî Ïà®ÍπÄ */
            width: 100%;
            max-width: 300px;
            margin: 0 auto 15px auto; /* Î≤ÑÌäºÍ≥º Í∞ÑÍ≤© */
            padding: 12px 0;
            background: #000000; /* ÏôÑÏ†Ñ Í≤ÄÏ†ï Î∞∞Í≤Ω */
            font-family: var(--font-display);
            font-size: 14px;
            font-weight: 900;
            text-align: center;
            letter-spacing: 2px;
            border-radius: 4px;
            text-transform: uppercase;
            /* üí° [ÏöîÏ≤≠] Í∏ÄÎ°úÏö∞ Ìö®Í≥º(box-shadow) ÏóÜÏùå -> ÎààÎ∂ÄÏã¨ Î∞©ÏßÄ */
            box-shadow: none; 
        }

        /* ÏÉÅÌÉúÎ≥Ñ ÏÉâÏÉÅ (ÌÖåÎëêÎ¶¨ÏôÄ Í∏ÄÏûêÏÉâÎßå Î≥ÄÍ≤Ω) */
        .status-panel.sc { 
            border: 2px solid #FF8700; 
            color: #FF8700; 
        }
        .status-panel.yellow { 
            border: 2px solid #FFD700; 
            color: #FFD700; 
        }
        .status-panel.green { 
            display: none !important; /* Ï¥àÎ°ùÎ∂àÏù¥Î©¥ Ï¶âÏãú Ïà®ÍπÄ */
        }

        /* PCÏóêÏÑúÎäî Íµ≥Ïù¥ Î≥¥Ïó¨Ï§Ñ ÌïÑÏöî ÏóÜÏúºÎØÄÎ°ú Ïà®ÍπÄ (ÏõêÌïòÏãúÎ©¥ ÏÇ≠Ï†ú Í∞ÄÎä•) */
        @media (min-width: 1025px) {
            .status-panel { display: none !important; }
        }
    </style>
    <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body class="redbull">
<div id="race-status-display">FLAG</div>

<div id="leaderboard">
    <div id="leaderboard-items"></div>
</div>

    <div id="loading-overlay">
        <div class="lights-container">
            <div class="light-pair"><div class="f1-light" id="light-1"></div><div class="f1-light" id="light-1b"></div></div>
            <div class="light-pair"><div class="f1-light" id="light-2"></div><div class="f1-light" id="light-2b"></div></div>
            <div class="light-pair"><div class="f1-light" id="light-3"></div><div class="f1-light" id="light-3b"></div></div>
            <div class="light-pair"><div class="f1-light" id="light-4"></div><div class="f1-light" id="light-4b"></div></div>
            <div class="light-pair"><div class="f1-light" id="light-5"></div><div class="f1-light" id="light-5b"></div></div>
        </div>
        <div class="loading-text">GRID FORMED...</div>
        <button id="start-engine-btn" onclick="activateEngine()">START ENGINE</button>
    </div>

    <div id="bgm-player"></div>

    <div id="celebration-overlay" style="display: none;">
        <div class="celebration-content">
            <div class="fastest-lap-title" id="lap-session-title">[Q1] FASTEST LAP</div>
            <div class="fastest-lap-driver" id="lap-driver-name">ANTONELLI</div>
            <button class="next-session-btn" onclick="closeCelebration()">PUSH FOR NEXT LAP</button>
        </div>
    </div>

    <div class="header-container">
        <div class="logo-box">
            <img src="https://i.imgur.com/jan8CSk.png" alt="F1 Logo" class="f1-logo">
            <div class="circuit-info">
                <div class="circuit-country" id="disp-country">AUSTRALIA</div>
                <div class="circuit-name" id="disp-circuit">Albert Park Circuit</div>
            </div>
            <div class="status-container">
                <div id="session-step" class="session-step">[Q1]</div>
                <div id="session-name" class="session-name">HOTEL</div>
            </div>
        </div>
        <div class="radio-box">
            <div class="radio-top-section">
                <div class="driver-name" id="display-name"><span>VERSTAPPEN</span></div>
                <span class="radio-label">RADIO</span>
            </div>
            <div id="wave-container" class="audio-wave-divider"></div>
            <div class="radio-content-section">
                <div class="quote-box top-msg">BUDGET CHECK.</div>
                <div class="quote-box bottom-data">
                    <div class="amount-container">
                        <div class="amount-row" id="txt-current">CUR ‚Ç©0</div>
                        <div class="amount-row amount-goal" id="txt-goal">TAR ‚Ç©0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="track-container">
        <svg class="track-svg" viewBox="-100 -100 1100 600" preserveAspectRatio="xMidYMid meet">
            <path id="bg-track" class="track-path-bg" />
            <path id="active-track" class="track-path-active" />
            <g id="start-finish-line"></g>
            <g id="ai-cars-layer"></g>
        </svg>
    </div>

    <div class="controls">
        <div id="msg-tooltip" class="tooltip">NOT YET, STAY IN GARAGE</div>
        <button class="box-btn" onclick="addMoney()">BOX BOX</button>
        <br>
        <button class="settings-btn" onclick="openSettings()">PIT STOP</button>
<div class="leaderboard-toggle-container">
            <button id="lb-toggle-btn" onclick="toggleLeaderboard()">
                <span id="lb-icon-open" style="display: none;">+</span> <span id="lb-icon-close">-</span> </button>
        </div>
        <div class="audio-container">
            <button class="audio-btn" onclick="toggleAudio()" aria-label="Toggle Audio">
                <svg id="icon-sound-on" class="audio-icon" viewBox="0 0 24 24">
                    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                </svg>
                <svg id="icon-sound-off" class="audio-icon" viewBox="0 0 24 24" style="display: none;">
                    <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73 4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                </svg>
            </button>
        </div>
    </div>

    <div class="modal" id="settings-modal">
        <div class="modal-content">
            
            <div class="modal-header">
                <h2>Strategy Settings</h2>
            </div>

            <div class="modal-body">
                <div class="input-group">
                    <label>Select Circuit</label>
                    <select id="circuit-select" onchange="updateCircuit()"></select>
                </div>
                <div class="input-group">
                    <label>Constructor</label>
                    <select id="team-select" onchange="updateDriverList(this.value)">
                        <option value="redbull">ORACLE RED BULL RACING</option>
                        <option value="mercedes">MERCEDES-AMG PETRONAS</option>
                        <option value="ferrari">SCUDERIA FERRARI HP</option>
                        <option value="mclaren">MCLAREN F1 TEAM</option>
                        <option value="astonmartin">ASTON MARTIN ARAMCO</option>
                        <option value="alpine">BWT ALPINE F1 TEAM</option>
                        <option value="williams">WILLIAMS RACING</option>
                        <option value="rb">VISA CASH APP RB</option>
                        <option value="sauber">SAUBER / AUDI</option>
                        <option value="haas">MONEYGRAM HAAS F1</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Driver</label>
                    <select id="driver-select" onchange="setDriver(this.value)"></select>
                </div>
                <div style="display:flex; gap:10px;">
                    <div class="input-group" style="flex:1;">
                        <label>Deposit Day (DD)</label>
                        <input type="number" id="savings-day" min="1" max="31" oninput="calculateRecommendation()">
                    </div>
                    <div class="input-group" style="flex:1;">
                        <label>Target Date (Race Day)</label>
                        <input type="date" id="target-date" onchange="calculateRecommendation()">
                    </div>
                </div>
                <div class="input-group"><label>Monthly Amount (‚Ç©)</label><input type="number" id="deposit-unit" oninput="calculateRecommendation()"></div>
                <div class="input-group"><label>Current Total Capital (‚Ç©)</label><input type="number" id="manual-amount" oninput="calculateRecommendation()"></div>
                <div class="input-group"><label>[Q1] HOTEL (‚Ç©) - BASE</label><input type="number" id="q1-goal" oninput="calculateRecommendation()"></div>
                <div class="input-group"><label>[Q2] FLIGHT (‚Ç©) - ENTRY</label><input type="number" id="q2-goal" oninput="calculateRecommendation()"></div>
                <div class="input-group"><label>[Q3] TICKET+ETC (‚Ç©) - RACE</label><input type="number" id="q3-goal" oninput="calculateRecommendation()"></div>
                
                <div class="recommendation-box" id="rec-box" style="display:none;">
                    <div class="rec-title">Race Engineer Strategy</div>
                    <div class="rec-value" id="rec-msg">Calculating...</div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="close-btn" onclick="saveAndCloseSettings()" style="margin-top:0;">PIT LIMITER OFF</button>
            </div>

        </div>
    </div>

    <script>
        const STORAGE_KEY = 'f1_world_tour_plan_v3_aus'; 

        const circuitAssets = {
            'aus': {
                viewBox: "-200 -100 1100 600",
                path: "M 340 398 L 304 394 L 282 362 L 250 357 L 192 360 L 8 331 L -3 316 L 12 293 L 21 260 L -53 185 L -33 96 L -12 53 L 0 0 L 45 -1 L 73 -23 L 124 -44 L 179 -29 L 245 23 L 263 53 L 280 116 L 312 157 L 349 196 L 423 219 L 535 202 L 565 159 L 684 154 L 734 167 L 870 243 L 852 263 L 814 342 L 781 347 L 703 327 L 691 336 L 697 375 L 667 401 Z",
                startLineTransform: "translate(460, 398) rotate(0)" 
            },
            'chn': {
                viewBox: "-400 -100 900 600",
                path: "M -7 -9 L 3 -17 L 25 -30 L 42 -35 L 64 -33 L 86 -20 L 101 -7 L 101 9 L 98 24 L 83 32 L 70 30 L 62 21 L 45 15 L 34 15 L 23 22 L 21 43 L 40 69 L 57 78 L 217 52 L 241 54 L 366 89 L 364 102 L 325 117 L 187 110 L 155 112 L 127 132 L 114 145 L 116 192 L 153 253 L 161 281 L 159 313 L 129 328 L 53 328 L 45 335 L 60 383 L 70 389 L 330 395 L 334 389 L 323 365 L 336 344 L 367 343 L 405 363 L 405 417 L 349 454 L -345 460 L -353 447 L -318 419 L -161 417 L -146 406 Z",
                startLineTransform: "translate(-76, 198) rotate(-72)" 
            },
            'ksa': {
                viewBox: "-1000 -300 1300 700",
                path: "M 0 0 L -170 93 L -179 106 L -179 112 L -174 118 L -173 126 L -179 132 L -200 132 L -223 128 L -238 128 L -339 162 L -349 169 L -350 177 L -356 195 L -363 200 L -387 211 L -401 210 L -415 203 L -430 199 L -448 202 L -470 217 L -479 231 L -487 244 L -503 250 L -534 254 L -547 246 L -563 227 L -573 219 L -592 218 L -607 220 L -637 213 L -652 214 L -825 253 L -840 269 L -838 290 L -823 302 L -803 303 L -777 293 L -728 255 L -694 249 L -643 261 L -618 262 L -600 260 L -590 265 L -580 285 L -560 293 L -511 288 L -467 264 L -420 234 L -398 229 L -358 223 L -323 208 L -299 184 L -268 161 L -225 151 L -176 149 L -156 143 L -148 128 L -139 114 L -101 99 L -77 99 L -8 122 L 36 118 L 141 65 L 159 44 L 207 -23 L 220 -76 L 206 -92 L 190 -93 L 0 0",
                startLineTransform: "translate(0, 0) rotate(151)" 
            },
            'jpn': {
                viewBox: "-900 -150 1200 600",
                path: "M 0 0 L 203 40 L 234 65 L 238 95 L 223 114 L 213 114 L 196 113 L 132 95 L 107 95 L 83 113 L 61 114 L 29 91 L 3 87 L -22 104 L -50 113 L -80 101 L -100 49 L -130 37 L -193 58 L -221 95 L -227 174 L -224 196 L -230 212 L -275 254 L -288 255 L -394 159 L -411 108 L -426 107 L -432 117 L -422 199 L -448 251 L -490 276 L -573 287 L -641 268 L -677 246 L -695 251 L -729 290 L -729 305 L -715 322 L -660 332 L -571 323 L -295 222 L -266 191 L -254 148 L -246 52 L -240 40 L -230 40 L -218 43 L -211 37 L -207 18 L -193 -8 L -167 -21 L -147 -24 L 0 0",
                startLineTransform: "translate(0, 0) rotate(11)" 
            },
            'bhr': {
                viewBox: "-600 -600 1000 700",
                path: "M 0 0 L -486 2 L -497 -5 L -497 -16 L -467 -45 L -459 -58 L -461 -71 L -482 -138 L -484 -152 L -432 -505 L -423 -515 L -410 -518 L -394 -515 L -295 -406 L -278 -393 L -249 -384 L -232 -372 L -224 -356 L -228 -302 L -221 -282 L -109 -202 L -101 -192 L -101 -183 L -111 -173 L -128 -172 L -314 -193 L -338 -194 L -356 -189 L -387 -148 L -384 -139 L -373 -135 L -270 -130 L 79 -133 L 94 -140 L 103 -157 L 105 -184 L 77 -236 L 53 -252 L 26 -259 L -17 -274 L -48 -304 L -60 -351 L -53 -378 L -8 -464 L 15 -479 L 32 -477 L 307 -45 L 311 -30 L 305 -23 L 264 -5 L 251 -1 L 0 0",
                startLineTransform: "translate(0, 0) rotate(180)" 
            },
            'mia': {
                viewBox: "-500 -200 1100 600",
                path: "M 0 0 L 113 67 L 120 79 L 116 85 L 84 111 L 78 123 L 81 161 L 75 184 L 36 209 L -1 219 L -47 213 L -197 126 L -222 120 L -245 123 L -285 149 L -305 153 L -327 142 L -354 114 L -375 108 L -420 121 L -443 142 L -450 175 L -443 190 L -432 196 L -407 193 L -379 193 L -305 212 L -111 207 L 12 251 L 63 252 L 110 246 L 321 168 L 398 114 L 399 105 L 393 101 L 366 79 L 360 57 L 373 38 L 383 34 L 424 33 L 434 27 L 453 -10 L 447 -14 L 437 -14 L 434 -18 L 450 -68 L 443 -78 L -337 -101 L -346 -96 L -346 -82 L -286 -46 L -257 -46 L -180 -77 L -148 -78 L -129 -75 L 0 0",
                startLineTransform: "translate(0, 0) rotate(31)" 
            },
            'can': {
                /* üí° Ïù¥Î™∞Îùº: Í∞ÄÎ°úÎ°ú Í∏¥ ÌòïÌÉúÏóê ÎßûÏ∂∞ Î∑∞Î∞ïÏä§ ÏÑ§Ï†ï */
                viewBox: "-800 -200 1000 500",
                
                /* üí° Í≤ΩÎ°ú Îç∞Ïù¥ÌÑ∞: Ï†úÍ≥µÌï¥Ï£ºÏã† Îç∞Ïù¥ÌÑ∞ Ï†ÅÏö© (Start: 0,0) */
                path: "M 0 0 L 36 3 L 106 20 L 123 17 L 136 2 L 147 0 L 160 7 L 160 18 L 134 76 L 63 127 L 53 128 L 37 118 L 32 118 L -23 143 L -41 162 L -59 169 L -136 151 L -151 154 L -159 163 L -157 181 L -163 196 L -174 202 L -303 186 L -441 131 L -446 127 L -445 100 L -449 93 L -617 27 L -638 25 L -699 31 L -708 24 L -709 7 L -699 4 L -653 9 L -616 6 L -493 -16 L -185 -14 L -178 -9 L -172 0 L -166 2 L 0 0",
                
                /* üí° Ï≤¥Ïª§Í∏∞ ÏúÑÏπò: ÏãúÏûëÏ†ê(0,0) Î∞∞Ïπò & Ï≤´ ÏßÑÌñâ Î∞©Ìñ•(ÎØ∏ÏÑ∏Ìïú Ïö∞ÏÉÅÌñ•)Ïóê ÎßûÏ∂∞ 5ÎèÑ ÌöåÏ†Ñ */
                startLineTransform: "translate(0, 0) rotate(5)" 
            },
            'imo': {
                /* üí° Î™®ÎÇòÏΩî: ÏúÑÏïÑÎûòÎ°ú Ï¢ÅÍ≥† Î≥µÏû°Ìïú ÌòïÌÉúÎ•º Í≥†Î†§Ìïú Î∑∞Î∞ïÏä§ ÏÑ§Ï†ï */
                viewBox: "-600 -200 900 650",
                
                /* üí° Í≤ΩÎ°ú Îç∞Ïù¥ÌÑ∞: Ï†úÍ≥µÌï¥Ï£ºÏã† Îç∞Ïù¥ÌÑ∞ Ï†ÅÏö© (Start: 0,0) */
                path: "M 0 0 L -26 0 L -128 -22 L -153 -25 L -282 -17 L -334 -4 L -342 0 L -351 25 L -358 32 L -401 53 L -411 63 L -489 249 L -490 260 L -480 287 L -481 297 L -572 375 L -578 386 L -579 401 L -569 410 L -557 410 L -397 391 L -373 393 L -292 404 L -283 401 L -272 392 L -249 328 L -249 308 L -272 222 L -269 208 L -246 174 L -236 168 L -225 168 L -208 176 L -192 177 L -6 177 L 8 179 L 16 191 L 23 193 L 139 142 L 226 47 L 244 36 L 303 11 L 314 -1 L 314 -9 L 290 -51 L 280 -55 L 265 -54 L 135 2 L 0 0",
                
                /* üí° Ï≤¥Ïª§Í∏∞ ÏúÑÏπò: ÏãúÏûëÏ†ê(0,0) Î∞∞Ïπò & Ï¢åÏ∏°(-XÏ∂ï)ÏúºÎ°ú Ï∂úÎ∞úÌïòÎØÄÎ°ú 180ÎèÑ ÌöåÏ†Ñ */
                startLineTransform: "translate(0, 0) rotate(180)" 
            },
            'mon': {
                viewBox: "-200 -200 1200 600",
                path: "M 0 0 L 107 -88 L 157 -108 L 177 -117 L 190 -117 L 199 -111 L 208 -91 L 304 -7 L 361 49 L 423 85 L 442 104 L 465 134 L 510 155 L 541 151 L 570 131 L 579 109 L 581 71 L 591 57 L 607 50 L 762 55 L 775 58 L 781 67 L 777 83 L 762 95 L 754 104 L 737 139 L 736 151 L 750 157 L 762 149 L 764 111 L 774 100 L 785 102 L 807 121 L 829 137 L 830 147 L 722 215 L 636 240 L 586 234 L 479 184 L 368 91 L 363 81 L 357 80 L 347 85 L 344 88 L 337 88 L 328 78 L 327 58 L 210 -63 L 186 -74 L 165 -72 L 90 -34 L 84 -27 L 85 -6 L 82 2 L 16 81 L 7 85 L -2 82 L -15 74 L -22 74 L -63 148 L -67 176 L -61 211 L -70 219 L -78 219 L -116 175 L -116 169 L -99 157 L -95 148 L -89 117 L 0 0",
                startLineTransform: "translate(0, 0) rotate(-39)" 
            },
            'esp': {
                viewBox: "-1000 -450 1400 600",
                path: "M 0 0 L -651 0 L -667 -8 L -682 -20 L -679 -61 L -686 -72 L -705 -90 L -776 -113 L -794 -125 L -811 -161 L -809 -202 L -785 -240 L -717 -276 L -682 -282 L -504 -281 L -478 -270 L -466 -249 L -466 -227 L -479 -205 L -525 -177 L -545 -176 L -672 -177 L -692 -171 L -699 -155 L -694 -139 L -580 -67 L -548 -59 L -452 -58 L -430 -69 L -423 -78 L -424 -109 L -420 -123 L -324 -256 L -299 -265 L -263 -262 L -239 -253 L 64 -80 L 78 -80 L 94 -93 L 97 -116 L 83 -154 L 62 -171 L 20 -183 L 1 -196 L -6 -221 L 5 -253 L 27 -262 L 48 -263 L 154 -230 L 164 -219 L 157 -139 L 161 -129 L 183 -126 L 192 -115 L 189 -43 L 174 -21 L 145 -2 L 0 0",
                startLineTransform: "translate(0, 0) rotate(180)" 
            },
            'aut': {
                viewBox: "-650 -450 900 600",
                path: "M -4 -5 L -264 69 L -280 37 L -354 -48 L -396 -123 L -465 -271 L -526 -333 L -581 -387 L -580 -397 L -573 -403 L -467 -407 L -211 -363 L -117 -361 L -104 -353 L -100 -338 L -110 -320 L -150 -283 L -183 -271 L -220 -272 L -334 -287 L -351 -280 L -372 -256 L -371 -224 L -313 -123 L -287 -114 L -258 -120 L -241 -136 L -202 -178 L -182 -186 L -148 -191 L 106 -195 L 131 -191 L 147 -176 L 177 -78 L 174 -61 L 155 -48 L -4 -5",
                startLineTransform: "translate(-4, -5) rotate(164)" 
            },
            'gbr': {
                viewBox: "-700 -500 1000 600",
                path: "M 0 0 L -136 -93 L -145 -113 L -149 -133 L -146 -192 L -150 -209 L -159 -224 L -217 -287 L -221 -306 L -218 -310 L -172 -327 L -165 -338 L -168 -345 L -219 -360 L -257 -359 L -270 -354 L -277 -346 L -451 -113 L -457 -87 L -451 -70 L -433 -63 L -398 -65 L -384 -53 L -378 -35 L -383 -24 L -395 -16 L -415 -15 L -505 -59 L -522 -81 L -538 -113 L -564 -319 L -557 -337 L -536 -358 L -428 -386 L -333 -392 L -314 -399 L -292 -412 L -278 -420 L -264 -422 L -218 -410 L -195 -410 L -182 -417 L -168 -431 L -140 -441 L -119 -435 L -109 -422 L -90 -389 L -70 -373 L -45 -362 L 250 -222 L 263 -201 L 267 -170 L 254 -149 L 232 -140 L 222 -138 L 180 -101 L 119 -40 L 114 -31 L 115 -21 L 129 -8 L 130 1 L 126 12 L 107 28 L 88 38 L 59 39 L 54 35 L 0 0",
                startLineTransform: "translate(0, 0) rotate(214)" 
            },
            'bel': {
                viewBox: "-200 -450 900 600",
                path: "M 0 0 L -114 78 L -122 78 L -129 71 L -90 -17 L -73 -44 L 7 -121 L 23 -139 L 29 -155 L 42 -172 L 76 -182 L 91 -187 L 114 -205 L 179 -254 L 473 -366 L 483 -365 L 496 -358 L 505 -345 L 512 -343 L 522 -344 L 549 -356 L 563 -357 L 574 -351 L 652 -254 L 653 -241 L 642 -225 L 627 -221 L 614 -225 L 606 -232 L 575 -273 L 568 -275 L 555 -274 L 494 -245 L 400 -222 L 382 -212 L 374 -197 L 374 -164 L 385 -140 L 404 -122 L 422 -115 L 533 -82 L 549 -68 L 551 -50 L 547 -36 L 537 -14 L 539 -6 L 547 4 L 619 41 L 627 57 L 624 74 L 594 118 L 578 124 L 551 126 L 528 117 L 496 100 L 452 63 L 392 -27 L 382 -42 L 360 -52 L 282 -82 L 265 -82 L 179 -38 L 79 -19 L 70 -19 L 66 -27 L 68 -44 L 63 -49 L 0 0",
                startLineTransform: "translate(0, 0) rotate(146)" 
            },
            'hun': {
                viewBox: "-400 -520 550 550",
                path: "M 0 0 L -346 -4 L -358 -15 L -357 -24 L -285 -70 L -253 -75 L -252 -75 L -123 -78 L -103 -90 L -101 -108 L -108 -124 L -172 -152 L -183 -165 L -187 -181 L -232 -378 L -231 -415 L -235 -425 L -319 -491 L -324 -519 L -307 -543 L -280 -546 L -167 -533 L -160 -530 L -155 -520 L -155 -504 L -149 -498 L -83 -455 L -71 -455 L -64 -457 L -17 -483 L -5 -483 L 11 -477 L 16 -470 L 53 -401 L 73 -384 L 106 -373 L 140 -366 L 160 -345 L 166 -326 L 154 -123 L 144 -112 L 133 -112 L 72 -124 L 26 -122 L 16 -112 L 14 -89 L 23 -81 L 34 -75 L 120 -74 L 135 -59 L 139 -38 L 134 -16 L 118 -3 L 0 0",
                startLineTransform: "translate(0, 0) rotate(179)" 
            },
            'ned': {
                viewBox: "-250 -550 600 600",
                path: "M 0 0 L -162 0 L -182 -10 L -196 -32 L -188 -55 L -169 -61 L -156 -66 L -79 -65 L -28 -81 L -7 -81 L 9 -71 L 35 -38 L 56 -35 L 68 -46 L 69 -61 L 58 -74 L 9 -130 L -3 -163 L -16 -236 L -29 -269 L -53 -293 L -86 -313 L -115 -347 L -148 -454 L -139 -486 L -117 -503 L -84 -515 L 1 -498 L 59 -490 L 73 -485 L 83 -470 L 98 -425 L 94 -389 L 81 -353 L 60 -347 L 31 -361 L 19 -384 L 8 -407 L -19 -432 L -37 -439 L -61 -427 L -64 -404 L -53 -372 L -22 -298 L 44 -208 L 108 -153 L 113 -140 L 109 -132 L 101 -118 L 107 -101 L 127 -98 L 136 -105 L 262 -184 L 280 -186 L 301 -179 L 311 -163 L 331 -101 L 326 -53 L 306 -20 L 263 1 L 0 0",
                startLineTransform: "translate(0, 0) rotate(180)" 
            },
            'ita': {
                viewBox: "-600 -500 1000 600",
                path: "M 0 0 L -225 10 L -231 4 L -229 -5 L -235 -10 L -274 7 L -350 15 L -398 0 L -441 -47 L -458 -77 L -485 -235 L -491 -240 L -502 -244 L -506 -251 L -547 -357 L -544 -368 L -536 -380 L -520 -383 L -437 -398 L -427 -391 L -356 -286 L -171 -116 L -161 -113 L -135 -118 L -117 -113 L -103 -94 L -94 -90 L 265 -89 L 284 -75 L 290 -60 L 271 -28 L 217 0 L 0 0",
                startLineTransform: "translate(0, 0) rotate(177)" 
            },
            'aze': {
                viewBox: "-900 -350 1200 500",
                path: "M 0 0 L 134 1 L 139 -5 L 142 -16 L 137 -154 L 134 -158 L 129 -162 L -237 -160 L -243 -157 L -245 -151 L -245 -56 L -249 -53 L -315 -51 L -391 -40 L -400 -32 L -398 -23 L -401 -15 L -526 19 L -540 19 L -552 26 L -557 24 L -548 -53 L -552 -61 L -561 -66 L -561 -72 L -565 -78 L -582 -86 L -589 -91 L -590 -112 L -598 -120 L -679 -120 L -752 -111 L -765 -108 L -805 -59 L -822 -40 L -829 -32 L -852 48 L -859 53 L -865 64 L -862 69 L -851 78 L -773 172 L -759 185 L -751 184 L -739 176 L -716 149 L -691 129 L -599 98 L -588 92 L -583 82 L -558 44 L -546 40 L -392 -2 L -378 -3 L 0 0",
                startLineTransform: "translate(0, 0) rotate(0)" 
            },
            'sin': {
                viewBox: "-850 -250 950 550",
                path: "M 0 0 L -15 -128 L -19 -176 L -26 -187 L -39 -190 L -53 -186 L -66 -189 L -76 -200 L -82 -215 L -96 -219 L -112 -215 L -117 -206 L -120 -187 L -122 -177 L -124 -147 L -115 -116 L -101 -84 L -95 -64 L -90 -14 L -95 -2 L -111 3 L -317 -12 L -339 -19 L -506 -109 L -522 -104 L -550 -65 L -566 -30 L -574 -16 L -580 -16 L -630 -73 L -646 -80 L -676 -67 L -686 -54 L -772 107 L -776 128 L -772 144 L -760 161 L -728 175 L -719 176 L -718 182 L -715 214 L -707 230 L -666 260 L -647 289 L -636 293 L -625 289 L -618 272 L -591 83 L -564 11 L -561 9 L -459 99 L -448 100 L -407 104 L -405 110 L -402 140 L -390 152 L -276 160 L -267 156 L -259 115 L -253 111 L -193 117 L -189 123 L -186 149 L -179 161 L -28 170 L -19 165 L 14 117 L 16 110 L 0 0",
                startLineTransform: "translate(0, 0) rotate(-97)" 
            },
            'usa': {
                viewBox: "-200 -480 1100 700",
                path: "M 0 0 L 241 191 L 258 194 L 265 186 L 263 171 L 238 104 L 239 73 L 252 48 L 332 -1 L 349 -14 L 366 -55 L 370 -58 L 399 -71 L 412 -80 L 421 -123 L 428 -133 L 458 -155 L 471 -157 L 534 -134 L 543 -133 L 582 -171 L 602 -180 L 624 -175 L 636 -162 L 643 -157 L 740 -176 L 859 -331 L 857 -338 L 850 -339 L 589 -261 L 511 -249 L 278 -220 L 273 -210 L 277 -204 L 326 -148 L 332 -124 L 328 -119 L 285 -120 L 280 -124 L 273 -154 L 249 -174 L 220 -175 L 218 -169 L 260 -93 L 267 -73 L 252 -36 L 246 -30 L 202 -11 L 192 -11 L 147 -27 L 136 -39 L 87 -113 L 75 -118 L -48 -67 L -55 -57 L -51 -46 L 0 0",
                startLineTransform: "translate(0, 0) rotate(38)" 
            },
            'mex': {
                viewBox: "-200 -130 900 600",
                path: "M 0 0 L 213 32 L 575 74 L 580 81 L 576 119 L 579 126 L 602 138 L 602 149 L 553 255 L 445 427 L 445 440 L 450 446 L 467 458 L 467 463 L 421 497 L 409 490 L 407 481 L 427 335 L 419 329 L 386 308 L 380 301 L 367 270 L 353 261 L 279 250 L 272 240 L 261 203 L 251 194 L 191 162 L 2 135 L -7 130 L -14 55 L -19 43 L -29 45 L -37 65 L -42 65 L -56 54 L -68 54 L -90 50 L -100 39 L -63 -5 L -46 -9 L 0 0",
                startLineTransform: "translate(0, 0) rotate(9)" 
            },
            'bra': {
                viewBox: "-300 -200 900 600",
                path: "M 0 0 L -185 104 L -204 123 L -209 145 L -200 159 L -184 167 L -161 177 L -153 189 L -154 202 L -162 220 L -163 270 L -148 309 L -108 336 L -47 351 L -32 350 L 388 342 L 414 325 L 418 307 L 400 214 L 382 195 L 357 180 L 138 96 L 111 77 L 103 51 L 105 0 L 116 -14 L 165 -44 L 214 -60 L 234 -53 L 239 -39 L 226 -9 L 228 20 L 245 33 L 265 34 L 283 22 L 319 -43 L 377 -78 L 395 -73 L 402 -61 L 401 -53 L 357 18 L 355 49 L 365 89 L 388 107 L 528 150 L 538 145 L 545 127 L 552 47 L 515 -24 L 451 -91 L 415 -103 L 383 -110 L 196 -100 L 165 -93 L 141 -83 L 0 0",
                startLineTransform: "translate(0, 0) rotate(151)" 
            },
            'las': {
                viewBox: "-800 -130 950 550",
                path: "M 0 0 L -36 -45 L -107 -100 L -118 -100 L -129 -92 L -132 -81 L -125 -65 L -92 -21 L -88 -1 L -101 35 L -128 45 L -471 45 L -482 39 L -487 28 L -487 -57 L -508 -89 L -555 -106 L -568 -106 L -572 -103 L -570 -91 L -576 -82 L -590 -78 L -614 -91 L -626 -93 L -637 -85 L -640 -71 L -642 74 L -660 102 L -677 117 L -762 154 L -791 190 L -799 242 L -793 255 L -784 256 L -774 251 L -763 258 L -558 365 L -451 385 L -8 392 L 4 385 L 7 372 L 0 365 L 4 356 L 23 341 L 30 325 L 25 45 L 27 28 L 0 0",
                startLineTransform: "translate(0, 0) rotate(231)" 
            },
            'qat': {
                viewBox: "-350 -550 850 550",
                path: "M 0 0 L -244 -3 L -270 -19 L -276 -51 L -267 -63 L -174 -116 L -168 -146 L -175 -163 L -254 -210 L -265 -227 L -330 -413 L -326 -430 L -316 -442 L -260 -459 L -246 -454 L -230 -442 L -185 -319 L -169 -312 L -158 -320 L -138 -491 L -117 -512 L -83 -509 L -69 -492 L -48 -421 L -6 -379 L 2 -364 L 2 -342 L -20 -269 L -11 -252 L 16 -243 L 32 -249 L 40 -253 L 114 -297 L 141 -345 L 195 -468 L 215 -483 L 231 -486 L 298 -487 L 312 -479 L 315 -471 L 357 -392 L 357 -383 L 258 -259 L 254 -235 L 264 -213 L 380 -42 L 380 -27 L 359 -4 L 0 0",
                startLineTransform: "translate(0, 0) rotate(179)" 
            },
            'abu': {
                viewBox: "-550 -200 1200 600",
                path: "M 0 0 L -1 231 L 6 242 L 18 248 L 127 233 L 151 219 L 166 181 L 195 147 L 228 136 L 257 139 L 321 165 L 337 170 L 530 170 L 539 157 L 536 148 L -56 -142 L -62 -138 L -62 -110 L -67 -103 L -105 -104 L -158 -92 L -206 -66 L -361 87 L -452 217 L -450 239 L -427 262 L -395 265 L -367 250 L -357 237 L -340 121 L -330 104 L -293 60 L -277 53 L -209 51 L -204 61 L -206 110 L -200 121 L -146 131 L -129 119 L -121 93 L -123 -26 L -113 -42 L -92 -53 L -30 -74 L -7 -73 L 0 -67 L 0 0",
                startLineTransform: "translate(0, 0) rotate(90)" 
            }
        };

        const circuitsData = [
            // 2030 ÏãúÏ¶å ÏòàÏÉÅ Ï∫òÎ¶∞Îçî (ÏùºÏöîÏùº Í≤∞Ïäπ Í∏∞Ï§Ä)
            { id: 'aus', name: 'Albert Park Circuit', country: 'Australia', month: 3, day: 10, h: 2800000, f: 1900000, t: 850000 },
            { id: 'ksa', name: 'Jeddah Corniche Circuit', country: 'Saudi Arabia', month: 3, day: 24, h: 3200000, f: 2100000, t: 900000 },
            { id: 'jpn', name: 'Suzuka International', country: 'Japan', month: 4, day: 7, h: 1800000, f: 700000, t: 750000 },
            { id: 'chn', name: 'Shanghai Int. Circuit', country: 'China', month: 4, day: 21, h: 2200000, f: 600000, t: 850000 },
            { id: 'mia', name: 'Miami Int. Autodrome', country: 'USA (Miami)', month: 5, day: 5, h: 6500000, f: 2800000, t: 2500000 },
            { id: 'imo', name: 'Imola Circuit', country: 'Italy (Imola)', month: 5, day: 19, h: 2500000, f: 2100000, t: 900000 },
            { id: 'mon', name: 'Circuit de Monaco', country: 'Monaco', month: 5, day: 26, h: 8000000, f: 2200000, t: 1500000 },
            { id: 'can', name: 'Circuit Gilles Villeneuve', country: 'Canada', month: 6, day: 9, h: 3000000, f: 2600000, t: 950000 },
            { id: 'esp', name: 'Circuit de Barcelona', country: 'Spain', month: 6, day: 23, h: 2400000, f: 2000000, t: 800000 },
            { id: 'aut', name: 'Red Bull Ring', country: 'Austria', month: 6, day: 30, h: 2200000, f: 2100000, t: 850000 },
            { id: 'gbr', name: 'Silverstone Circuit', country: 'Great Britain', month: 7, day: 7, h: 3500000, f: 2300000, t: 1200000 },
            { id: 'hun', name: 'Hungaroring', country: 'Hungary', month: 7, day: 21, h: 1800000, f: 1900000, t: 650000 },
            { id: 'bel', name: 'Spa-Francorchamps', country: 'Belgium', month: 7, day: 28, h: 2300000, f: 2000000, t: 800000 },
            { id: 'ned', name: 'Zandvoort Circuit', country: 'Netherlands', month: 8, day: 25, h: 2800000, f: 2100000, t: 900000 },
            { id: 'ita', name: 'Monza Circuit', country: 'Italy (Monza)', month: 9, day: 1, h: 2600000, f: 2000000, t: 950000 },
            { id: 'aze', name: 'Baku City Circuit', country: 'Azerbaijan', month: 9, day: 15, h: 2100000, f: 1800000, t: 700000 },
            { id: 'sin', name: 'Marina Bay Street Circuit', country: 'Singapore', month: 10, day: 4, h: 3500000, f: 1500000, t: 900000 },
            { id: 'usa', name: 'Circuit of The Americas', country: 'USA (Austin)', month: 10, day: 20, h: 3800000, f: 2500000, t: 1100000 },
            { id: 'mex', name: 'Aut√≥dromo H. Rodr√≠guez', country: 'Mexico', month: 10, day: 27, h: 2200000, f: 2400000, t: 750000 },
            { id: 'bra', name: 'Interlagos Circuit', country: 'Brazil', month: 11, day: 3, h: 2300000, f: 2900000, t: 700000 },
            { id: 'las', name: 'Las Vegas Strip Circuit', country: 'USA (Las Vegas)', month: 11, day: 23, h: 7000000, f: 2400000, t: 3000000 },
            { id: 'qat', name: 'Lusail Int. Circuit', country: 'Qatar', month: 12, day: 1, h: 3500000, f: 2000000, t: 900000 },
            { id: 'abu', name: 'Yas Marina Circuit', country: 'Abu Dhabi', month: 12, day: 8, h: 5000000, f: 2100000, t: 1500000 }
        ];

        const teamsDB = {
            redbull: { name: 'Red Bull Racing', drivers: ['VERSTAPPEN', 'HADJAR'] },
            mercedes: { name: 'Mercedes-AMG', drivers: ['RUSSELL', 'ANTONELLI'] },
            ferrari: { name: 'Ferrari HP', drivers: ['LECLERC', 'HAMILTON'] },
            mclaren: { name: 'McLaren F1', drivers: ['NORRIS', 'PIASTRI'] },
            astonmartin: { name: 'Aston Martin', drivers: ['ALONSO', 'STROLL'] },
            alpine: { name: 'BWT Alpine F1 Team', drivers: ['GASLY', 'COLAPINTO'] }, // üö® ÏïåÌïÄ: Í∞ÄÏä¨Î¶¨/ÏΩúÎùºÌïÄÌÜ†
            williams: { name: 'Williams Racing', drivers: ['ALBON', 'SAINZ'] },
            rb: { name: 'Visa Cash App RB', drivers: ['LAWSON', 'LINDBLAD'] },
            sauber: { name: 'Audi F1 Team', drivers: ['HULKENBERG', 'BORTOLETO'] }, // üö® ÏïÑÏö∞ÎîîÎ°ú Î≥ÄÍ≤Ω
            haas: { name: 'TGR HAAS F1 TEAM', drivers: ['OCON', 'BEARMAN'] }, // üö® ÌïòÏä§: Ïò§ÏΩò/Î≤†Ïñ¥Îßå
            cadillac: { name: 'Cadillac F1 Team', drivers: ['BOTTAS', 'PEREZ'] } // üö® Ï∫êÎîúÎùΩ Ï∂îÍ∞Ä
        };

const driverGroups = {
            // üëë Ïã†Í≥Ñ: Î≤†Î•¥Ïä§ÌÉÄÌéú, ÎÖ∏Î¶¨Ïä§ (Ïö∞Ïäπ ÌõÑÎ≥¥)
            top: ['VER', 'NOR', 'PIA', 'RUS', 'LEC', 'HAM'], 
            // ‚öîÔ∏è Ï§ëÏÉÅÏúÑÍ∂å: Ìè¨ÎîîÏõÄ Í≤ΩÏüÅ (ÏúåÎ¶¨ÏóÑÏä§, ÏïÑÏö∞Îîî Îñ°ÏÉÅ Î∞òÏòÅ)
            mid: ['SAI', 'ALB', 'ANT', 'HUL', 'ALO', 'BOT', 'PER', 'GAS'], 
            // üõ°Ô∏è Î£®ÌÇ§ Î∞è ÌïòÏúÑÍ∂å
            btm: ['STR', 'OCO', 'LAW', 'HAD', 'LIN', 'BOR', 'COL', 'BEA'] 
        };

const driverColors = {
            // 1. Red Bull (Deep Blue)
            'VER': '#3671C6', 'HAD': '#3671C6', 
            // 2. Mercedes (Teal)
            'ANT': '#00D2BE', 'RUS': '#00D2BE', 
            // 3. Ferrari (Red)
            'LEC': '#FF2800', 'HAM': '#FF2800', 
            // 4. McLaren (Papaya Orange)
            'NOR': '#FF8000', 'PIA': '#FF8000', 
            // 5. Aston Martin (Lime)
            'ALO': '#CEDC00', 'STR': '#CEDC00', 
            // 6. Alpine (Pink - Í∞ÄÏä¨Î¶¨ & ÏΩúÎùºÌïÄÌÜ†)
            'GAS': '#FD4BC7', 'COL': '#FD4BC7', 
            // 7. Williams (Light Blue - ÏïåÎ≥∏ & ÏÇ¨Ïù∏Ï∏†)
            'ALB': '#00A0DE', 'SAI': '#00A0DE', 
            // 8. RB (Blue/White - Î°úÏÜê & Î¶∞ÎìúÎ∏îÎùºÎìú)
            'LAW': '#3671C6', 'LIN': '#3671C6', 
            // 9. Audi/Sauber (Neon Green - ÌõåÏºÑÎ≤ÑÍ∑∏ & Î≥¥Î•¥ÌÜ®Î†àÌÜ†)
            'HUL': '#00E042', 'BOR': '#00E042', 
            // 10. Haas (Red/White - Ïò§ÏΩò & Î≤†Ïñ¥Îßå)
            'OCO': '#E6002B', 'BEA': '#E6002B',
            // 11. Cadillac (Gold/Yellow - Î≥¥ÌÉÄÏä§ & ÌéòÎ†àÏ¶à) üö® Ïã†Í∑ú!
            'BOT': '#F1B315', 'PER': '#F1B315' 
        };

        const REF_WIDTH = 1200; 

let g_rowHeight = 21;

        let state = { 
            currentAmount: 0, team: 'redbull', driver: 'VERSTAPPEN', 
            q1: 2500000, q2: 3500000, q3: 700000, 
            lastSession: 'Q1', savingsDay: 25, depositUnit: 100000, 
            lastDepositDate: '', targetDate: '2026-03-08',
            circuitId: 'aus', pathStartOffset: 0,
            scaleFactor: 1,
            speedFactor: 1 
        };

        let visualProgress = 0, animId = null;
        let trackSpeedProfile = [];
        let raceStarted = false; 
        let bgmPlayer;
        let isMuted = false;
        let aiDrivers = [];
        let stableRanking = [];
        let raceStatus = 'GREEN'; 
        let stoppedCarId = null;  
        let safetyCar = {
            active: false,
            progress: 0,
            element: null,
            speed: 0
        };
        let eventTimer = 0;        

        const driverList = [
            // [God Tier] Î≤†Î•¥Ïä§ÌÉÄÌéú vs ÎÖ∏Î¶¨Ïä§ (ÎèôÍ∏â ÏµúÍ∞ï: 1.29)
            { id: 'VER', speed: 1.29 }, 
            { id: 'NOR', speed: 1.29 }, 

            // [Top Tier] Ïö∞Ïäπ Í≤ΩÏüÅÍ∂å (1.23 ~ 1.26)
            { id: 'PIA', speed: 1.26 }, 
            { id: 'RUS', speed: 1.25 }, 
            { id: 'LEC', speed: 1.24 }, 
            { id: 'HAM', speed: 1.23 }, 

            // [High Mid] ÏÉÅÏúÑÍ∂å ÎèÑÏïΩ (1.18 ~ 1.21)
            { id: 'SAI', speed: 1.21 }, 
            { id: 'ALB', speed: 1.20 }, 
            { id: 'HUL', speed: 1.18 }, 
            { id: 'ANT', speed: 1.18 }, 

            // [Mid] ÌóàÎ¶¨ ÎùºÏù∏ (1.14 ~ 1.16)
            { id: 'ALO', speed: 1.16 }, 
            { id: 'BOT', speed: 1.14 }, 
            { id: 'PER', speed: 1.14 }, 

            // [Low Mid] Ï§ëÌïòÏúÑÍ∂å (1.08 ~ 1.10)
            { id: 'GAS', speed: 1.10 }, 
            { id: 'STR', speed: 1.09 }, 
            { id: 'OCO', speed: 1.08 }, 
            { id: 'LAW', speed: 1.08 }, 

            // [Rookies] ÌïòÏúÑÍ∂å (ÏµúÏÜå 1.01 Ïù¥ÏÉÅ Î≥¥Ïû•)
            { id: 'HAD', speed: 1.05 }, // Î†àÎìúÎ∂à Ï∞®Îπ®
            { id: 'LIN', speed: 1.03 }, 
            { id: 'COL', speed: 1.02 }, 
            { id: 'BOR', speed: 1.01 }, 
            { id: 'BEA', speed: 1.01 }  
        ];

        function calculateScaleFactor(viewBoxStr) {
            const parts = viewBoxStr.split(' ').map(Number);
            const width = parts[2]; 
            const rawRatio = width / REF_WIDTH;
            state.speedFactor = Math.max(rawRatio, 0.85);
            state.scaleFactor = Math.max(rawRatio, 0.9);
            const newStroke = 10 * state.scaleFactor;
            document.documentElement.style.setProperty('--dynamic-stroke', `${newStroke}px`);
        }

// üìè [Ïã†Í∑ú] ÌôîÎ©¥ ÎÜíÏù¥Ïóê Îî∞Îùº Î¶¨ÎçîÎ≥¥Îìú ÎÜíÏù¥ÏôÄ Ìè∞Ìä∏Î•º ÏûêÎèô Ï°∞Ï†àÌïòÎäî Ìï®Ïàò
        function adjustLeaderboardLayout() {
            const container = document.getElementById('leaderboard-items');
            if (!container) return;

            const totalDrivers = aiDrivers.length || 20;
            
            // 1. Í∞ÄÏö© ÎÜíÏù¥ Í≥ÑÏÇ∞ (Ï†ÑÏ≤¥ ÌôîÎ©¥ - ÏÉÅÎã® Ïó¨Î∞± 240px - ÌïòÎã® Î≤ÑÌäº Ïó¨Î∞± 120px)
            const availableHeight = window.innerHeight - 360; 
            
            // 2. Ïù¥ÏÉÅÏ†ÅÏù∏ ÎÜíÏù¥ (ÎìúÎùºÏù¥Î≤Ñ Ïàò * Í∏∞Î≥∏ 21px)
            const idealHeight = totalDrivers * 21;

            // 3. ÏïïÏ∂ï ÎπÑÏú® Í≥ÑÏÇ∞
            let scaleRatio = 1;
            if (availableHeight < idealHeight) {
                scaleRatio = availableHeight / idealHeight;
            }

            // 4. ÏÉàÎ°úÏö¥ Ìñâ ÎÜíÏù¥ Í≤∞Ï†ï (ÏµúÏÜå 12pxÍπåÏßÄÎßå Ï§ÑÏñ¥Îì§Í≤å Ï†úÌïú)
            g_rowHeight = Math.max(12, 21 * scaleRatio);
            
            // 5. Ìè∞Ìä∏ ÌÅ¨Í∏∞ÎèÑ ÎπÑÏú®Ïóê ÎßûÏ∂∞ Ï§ÑÏûÑ (Í∏∞Î≥∏ 13px -> ÎπÑÏú® Ï†ÅÏö©)
            const newFontSize = Math.max(8, 10 * scaleRatio); 
            const newPosSize = Math.max(7, 9 * scaleRatio);

            // 6. Ïª®ÌÖåÏù¥ÎÑà Ï†ÑÏ≤¥ ÎÜíÏù¥ Ï†ÅÏö©
            container.style.height = (totalDrivers * g_rowHeight) + 'px';

            // 7. Ïä§ÌÉÄÏùº ÏùºÍ¥Ñ Ï†ÅÏö© (Í∏∞Ï°¥ RowÎì§Ïóê Ï¶âÏãú Î∞òÏòÅ)
            const rows = document.querySelectorAll('.lb-row');
            rows.forEach((row, index) => {
                row.style.height = (g_rowHeight - 1) + 'px'; // 1px Í∞ÑÍ≤©
                row.style.transform = `translateY(${index * g_rowHeight}px)`;
                
                // Ìè∞Ìä∏ ÌÅ¨Í∏∞ Î≥ÄÍ≤Ω
                const pos = row.querySelector('.lb-pos');
                const name = row.querySelector('.lb-name');
                if(pos) { pos.style.fontSize = newPosSize + 'px'; pos.style.lineHeight = g_rowHeight + 'px'; }
                if(name) { name.style.fontSize = newFontSize + 'px'; name.style.lineHeight = g_rowHeight + 'px'; }
            });
        }

function init() {
            // 1. üì± Î™®Î∞îÏùº/ÏûëÏùÄ ÌôîÎ©¥ Ï¥àÍ∏∞Ìôî Î°úÏßÅ
            // ÌôîÎ©¥Ïù¥ Ï¢ÅÏúºÎ©¥ Î¶¨ÎçîÎ≥¥ÎìúÎ•º Í∞ÄÎ¶¨Í≥†, Î≤ÑÌäº ÏïÑÏù¥ÏΩò ÏÉÅÌÉúÎ•º ÎèôÍ∏∞ÌôîÌï©ÎãàÎã§.
            if (window.innerWidth <= 1024) {
                const lb = document.getElementById('leaderboard');
                const btn = document.getElementById('lb-toggle-btn');
                const openIcon = document.getElementById('lb-icon-open');
                const closeIcon = document.getElementById('lb-icon-close');
                
                if(lb) lb.classList.add('hidden');
                if(btn) btn.classList.remove('active');
                if(openIcon) openIcon.style.display = 'block';
                if(closeIcon) closeIcon.style.display = 'none';
            }

            // 2. üìè [Ïã†Í∑ú] Ï∞Ω ÌÅ¨Í∏∞ Î≥ÄÍ≤Ω Í∞êÏßÄ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
            // Î∏åÎùºÏö∞Ï†Ä ÌÅ¨Í∏∞Î•º Ï°∞Ï†àÌï† ÎïåÎßàÎã§ Î¶¨ÎçîÎ≥¥Îìú ÎÜíÏù¥Î•º Îã§Ïãú Í≥ÑÏÇ∞Ìï©ÎãàÎã§.
            window.addEventListener('resize', () => {
                if (typeof adjustLeaderboardLayout === 'function') {
                    adjustLeaderboardLayout();
                }
                if (typeof updateLeaderboard === 'function') {
                    updateLeaderboard(); // ÏúÑÏπò Ïû¨Ï†ïÎ†¨
                }
            });

            // 3. üéµ Ïò§ÎîîÏò§ ÎπÑÏ£ºÏñºÎùºÏù¥Ï†Ä(EQ) Î∞î ÏÉùÏÑ±
            const container = document.getElementById('wave-container');
            if (container) {
                container.innerHTML = '';
                for(let i = 0; i < 30; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'bar';
                    const curve = Math.sin((i / 29) * Math.PI); 
                    const maxEnvelope = (14 * curve) + 4; 
                    const randomHeight = maxEnvelope * (0.6 + Math.random() * 0.4);
                    bar.style.setProperty('--eq-height', `${randomHeight}px`);
                    bar.style.animation = `equalizer ${0.2 + Math.random() * 0.3}s infinite ease-in-out`;
                    bar.style.animationDelay = `${Math.random() * -1}s`;
                    container.appendChild(bar);
                }
            }

            // 4. üíæ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Î∞è Í∏∞Î≥∏ ÏÑ§Ï†ï
            loadData(); 
            initCircuitSelect(); 
            updateCircuit(); 
            updateTeamSelectUI(); 
            requestAnimationFrame(animateAIDrivers); // Ïï†ÎãàÎ©îÏù¥ÏÖò Î£®ÌîÑ ÏãúÏûë

            // 5. üèÅ Ìä∏Îûô Î∞è Î¶¨ÎçîÎ≥¥Îìú ÏßÄÏó∞ Ï¥àÍ∏∞Ìôî (Îç∞Ïù¥ÌÑ∞ Î°úÎî© ÎåÄÍ∏∞)
            setTimeout(() => {
                const track = document.getElementById('bg-track');
                if(track) {
                   const asset = circuitAssets[state.circuitId] || circuitAssets['aus']; 
                   state.pathStartOffset = findPathOffset(track, asset.startLineTransform);
                   generateTrackSpeedProfile();
                }
                
                // (1) AI ÎìúÎùºÏù¥Î≤Ñ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
                initAIDrivers(); 
                
                // (2) Î¶¨ÎçîÎ≥¥Îìú ÏÉùÏÑ± Î∞è ÌÅ¨Í∏∞ Ï°∞Ï†à
                if (typeof initLeaderboard === 'function') {
                    initLeaderboard(); // ÎÇ¥Ïö©Î¨º Ï±ÑÏö∞Í∏∞
                    
                    // üö® [ÌïµÏã¨] ÏÉùÏÑ± ÏßÅÌõÑ ÌôîÎ©¥ ÌÅ¨Í∏∞Ïóê ÎßûÏ∂∞ Ìïú Î≤à ÏïïÏ∂ïÌï¥Ï§çÎãàÎã§.
                    if (typeof adjustLeaderboardLayout === 'function') {
                        adjustLeaderboardLayout(); 
                    }
                }

                updateDashboard(); 
            }, 50);
        }

        function initCircuitSelect() {
            const select = document.getElementById('circuit-select');
            select.innerHTML = '';
            circuitsData.forEach((c, index) => {
                const option = document.createElement('option');
                option.value = c.id;
                option.text = `[Rd.${index+1}] ${c.country} - ${c.name}`;
                if(c.id === state.circuitId) option.selected = true;
                select.appendChild(option);
            });
        }

        function updateCircuit() {
            const select = document.getElementById('circuit-select');
            const circuitId = select.value || state.circuitId;
            const data = circuitsData.find(c => c.id === circuitId);
            if(!data) return;

            // 1. ÏÑúÌÇ∑ Ï†ïÎ≥¥ Î∞è ÏòàÏÇ∞/ÎÇ†Ïßú ÎèôÍ∏∞Ìôî
            state.circuitId = circuitId;
            state.q1 = data.h; 
            state.q2 = data.f; 
            state.q3 = data.t; 
            
            document.getElementById('q1-goal').value = state.q1;
            document.getElementById('q2-goal').value = state.q2;
            document.getElementById('q3-goal').value = state.q3;

            const year = 2030;
            const month = String(data.month).padStart(2, '0');
            const day = String(data.day).padStart(2, '0');
            state.targetDate = `${year}-${month}-${day}`;
            document.getElementById('target-date').value = state.targetDate;

            // ============================================================
            // üö® [Ï∂îÍ∞Ä] Î†àÏù¥Ïä§ ÏÉÅÌÉú Í∞ïÏ†ú Ï¥àÍ∏∞Ìôî (Green Flag Î¶¨ÏÖã)
            // ============================================================
            raceStatus = 'GREEN';       // ÏÉÅÌÉú ÎÖπÏÉâÏúºÎ°ú
            stoppedCarId = null;        // ÏÇ¨Í≥† Ï∞®Îüâ Í∏∞Î°ù ÏÇ≠Ï†ú
            safetyCar.active = false;   // SC ÎπÑÌôúÏÑ±Ìôî
            eventTimer = 0;             // Ïù¥Î≤§Ìä∏ ÌÉÄÏù¥Î®∏ Î¶¨ÏÖã

            // ÌîåÎûòÍ∑∏ UI Ï¶âÏãú Ïà®ÍπÄ
            const statusDisplay = document.getElementById('race-status-display');
            statusDisplay.style.opacity = '0'; 
            statusDisplay.className = ''; 

            // Î™®Î∞îÏùº Ìå®ÎÑêÎèÑ Ïà®ÍπÄ
            const mobilePanel = document.getElementById('mobile-status-panel');
            if (mobilePanel) mobilePanel.style.display = 'none';
            // ============================================================

            // 2. Ìä∏Îûô ÏóêÏÖã Î°úÎî© (Í∏∞Ï°¥ Î°úÏßÅ)
            const asset = circuitAssets[circuitId] || circuitAssets['aus'];
            const svgElement = document.querySelector('.track-svg');
            svgElement.setAttribute('viewBox', asset.viewBox);
            calculateScaleFactor(asset.viewBox);
            document.getElementById('bg-track').setAttribute('d', asset.path);
            document.getElementById('active-track').setAttribute('d', asset.path);

            const checker = document.getElementById('start-finish-line');
            checker.setAttribute('transform', asset.startLineTransform);
            checker.innerHTML = `
                <rect x="-8" y="-3" width="4" height="3" class="checker-black"/><rect x="-4" y="-3" width="4" height="3" class="checker-white"/><rect x="0" y="-3" width="4" height="3" class="checker-black"/><rect x="4" y="-3" width="4" height="3" class="checker-white"/>
                <rect x="-8" y="0" width="4" height="3" class="checker-white"/><rect x="-4" y="0" width="4" height="3" class="checker-black"/><rect x="0" y="0" width="4" height="3" class="checker-white"/><rect x="4" y="0" width="4" height="3" class="checker-black"/>
            `;

            setTimeout(() => {
                const track = document.getElementById('bg-track');
                state.pathStartOffset = findPathOffset(track, asset.startLineTransform);
                generateTrackSpeedProfile();
                
                // Ïó¨Í∏∞ÏÑú AIÎ•º Îã§Ïãú Í∑∏Î¶¥ Îïå SC ÏöîÏÜåÎèÑ Ï¥àÍ∏∞ÌôîÎêú ÏÉÅÌÉúÎ°ú Í∑∏Î†§ÏßëÎãàÎã§.
                initAIDrivers(); 
                updateDashboard(); 
            }, 50);
        }

        function findPathOffset(pathElement, transformStr) {
            const match = transformStr.match(/translate\(\s*(-?[\d.]+)\s*,\s*(-?[\d.]+)\s*\)/);
            if (!match) return 0;
            const targetX = parseFloat(match[1]), targetY = parseFloat(match[2]);
            const totalLen = pathElement.getTotalLength();
            let minDist = Infinity, bestRatio = 0;
            
            // üí° [ÏàòÏ†ï] Ï†ïÎ∞ÄÎèÑ Ìñ•ÏÉÅ: 1000 -> 5000 Îã®Í≥ÑÎ°ú Ï™ºÍ∞úÏÑú Í∞ÄÏû• Í∞ÄÍπåÏö¥ Ï†êÏùÑ Ï∞æÏùå
            // Ïù¥Î†áÍ≤å ÌïòÎ©¥ ÏãúÏûëÏ†ê Ïò§Ï∞®Í∞Ä ÌîΩÏÖÄ Îã®ÏúÑ Ïù¥ÌïòÎ°ú Ï§ÑÏñ¥Îì≠ÎãàÎã§.
            const steps = 5000; 
            
            for(let i=0; i <= steps; i++) {
                const len = (i / steps) * totalLen;
                const pt = pathElement.getPointAtLength(len);
                const dist = Math.sqrt(Math.pow(pt.x - targetX, 2) + Math.pow(pt.y - targetY, 2));
                if (dist < minDist) { minDist = dist; bestRatio = i / steps; }
            }
            return bestRatio;
        }

function toggleLeaderboard() {
            const lb = document.getElementById('leaderboard');
            const btn = document.getElementById('lb-toggle-btn');
            const openIcon = document.getElementById('lb-icon-open');
            const closeIcon = document.getElementById('lb-icon-close');
            
            lb.classList.toggle('hidden');
            
            const isHidden = lb.classList.contains('hidden');
            openIcon.style.display = isHidden ? 'block' : 'none';
            closeIcon.style.display = isHidden ? 'none' : 'block';
            
            // Î≤ÑÌäº ÌôúÏÑ± ÏÉÅÌÉú Ïä§ÌÉÄÏùº (Ïó¥Î¶º=ÌôúÏÑ±)
            if (!isHidden) btn.classList.add('active');
            else btn.classList.remove('active');
        }

        function initAIDrivers() {
            const layer = document.getElementById('ai-cars-layer');
            if (!layer) return;
            
            layer.innerHTML = ''; 
            aiDrivers = [];
            
            const shuffle = (a) => a.sort(() => Math.random() - 0.5);
            const topShuffled = shuffle([...driverGroups.top]);
            const midShuffled = shuffle([...driverGroups.mid]);
            const btmShuffled = shuffle([...driverGroups.btm]);
            const combinedIds = [...topShuffled, ...midShuffled, ...btmShuffled];
            
            let gridStartPos = state.pathStartOffset - 0.02;
            
            if (gridStartPos < 0) gridStartPos += 1; 

            combinedIds.forEach((id, index) => {
                const dInfo = driverList.find(d => d.id === id) || { speed: 1.0 };
                const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                g.setAttribute("class", "ai-marker");
                g.innerHTML = `<rect x="-20" y="-30" width="40" height="20"/><text x="0" y="-16" style="font-size:14px;">${id}</text><circle r="4"/>`;
                layer.appendChild(g);

                const row = Math.floor(index / 2);
                const stagger = (index % 2 === 1) ? 0.004 : 0; 
                
                let initialProgress = gridStartPos - (row * 0.015) - stagger;
                if (initialProgress < 0) initialProgress += 1;

                aiDrivers.push({ 
                    id: id, 
                    element: g, 
                    baseSpeed: dInfo.speed, 
                    progress: initialProgress, 
                    actualSpeed: 0, 
                    totalLaps: 0,
                    condition: 1.0, 
                    randomFactor: Math.random() * 100,
                    focus: 1.0,
                    battleState: 'normal',
                    battleTimer: 0,        
                    cooldown: 0            
                });
            });

            const scGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
            scGroup.setAttribute("class", "ai-marker sc-marker");
            scGroup.style.display = 'none'; 
            scGroup.innerHTML = `<rect x="-20" y="-30" width="40" height="20"/><text x="0" y="-16" style="font-size:12px;">SC</text>`;
            layer.appendChild(scGroup);

            safetyCar.element = scGroup;

            updateRaceScenario();
            if (typeof initLeaderboard === 'function') initLeaderboard();
        }

        function updateRaceScenario() {
            const heroId = getDriverShortId(state.driver);
            aiDrivers.forEach(ai => {
                const isHero = (ai.id === heroId);
                ai.element.classList.toggle('hero-marker', isHero);
                if(isHero) document.getElementById('ai-cars-layer').appendChild(ai.element);
            });
        }

        function getDriverShortId(n) { 
            if (n === 'LINDBLAD') return 'LIN';
            if (n === 'HADJAR') return 'HAD';
            if (n === 'COLAPINTO') return 'COL';
            return n.substring(0,3).toUpperCase(); 
        }

        function generateTrackSpeedProfile() {
            const track = document.getElementById('bg-track');
            const len = track.getTotalLength();
            trackSpeedProfile = []; 
            for(let i=0; i<1000; i++) {
                const pt1 = track.getPointAtLength(((i-5+1000)%1000)/1000*len);
                const pt2 = track.getPointAtLength((i/1000)*len);
                const pt3 = track.getPointAtLength(((i+5)%1000)/1000*len);
                
                const angle1 = Math.atan2(pt2.y - pt1.y, pt2.x - pt1.x);
                const angle2 = Math.atan2(pt3.y - pt2.y, pt3.x - pt2.x);
                let diff = Math.abs(angle1 - angle2);
                if (diff > Math.PI) diff = 2 * Math.PI - diff; 

                let trackFactor;
                if (diff < 0.12) trackFactor = 2.0;      
                else if (diff < 0.25) trackFactor = 1.4; 
                else if (diff < 0.45) trackFactor = 0.7; 
                else trackFactor = 0.35;                 
                
                trackSpeedProfile.push(trackFactor);
            }
        }

        let leaderboardRows = {}; 

        function initLeaderboard() {
            const container = document.getElementById('leaderboard-items');
            if (!container) return; 

            container.innerHTML = ''; 
            leaderboardRows = {}; 

            // üö® [ÏàòÏ†ï ÌïµÏã¨] Ïª®ÌÖåÏù¥ÎÑà ÎÜíÏù¥ Í∞ïÏ†ú ÏßÄÏ†ï (Ïú†Î†π ÏÉÅÏûê Î¨∏Ï†ú Ìï¥Í≤∞)
            // ÎìúÎùºÏù¥Î≤Ñ Ïàò(aiDrivers.length) * (Ìñâ ÎÜíÏù¥ 21px) ÎßåÌÅº ÎÜíÏù¥Î•º Ïû°ÏïÑÏ§çÎãàÎã§.
            container.style.height = (aiDrivers.length * 21) + 'px';
            container.style.position = 'relative'; // ÏûêÏãùÏöîÏÜå(absolute)Ïùò Í∏∞Ï§ÄÏ†ê ÏÑ§Ï†ï
            container.style.width = '100%';        // ÎÑàÎπÑ ÍΩâ Ï±ÑÏö∞Í∏∞

            aiDrivers.forEach((ai, index) => {
                const row = document.createElement('div');
                row.className = 'lb-row';
                
                // Ïï†ÎãàÎ©îÏù¥ÏÖòÏùÑ ÏúÑÌïú Ï¥àÍ∏∞ ÏúÑÏπò Ïû°Í∏∞
                row.style.transform = `translateY(${index * 21}px)`;

                const color = driverColors[ai.id] || '#888';
                const isMyDriver = (ai.id === getDriverShortId(state.driver));
                const textStyle = isMyDriver ? 'color: #FFEC00;' : 'color: #ffffff;';
                
                row.innerHTML = `
                    <div class="lb-pos" style="${textStyle}">${index + 1}</div>
                    <div class="lb-color-strip" style="background-color: ${color}; box-shadow: 0 0 4px ${color};"></div>
                    <div class="lb-name" style="${textStyle}">${ai.id}</div>
                `;

                container.appendChild(row);

                leaderboardRows[ai.id] = { 
                    element: row, 
                    posElement: row.querySelector('.lb-pos') 
                };
            });
        }

        function updateLeaderboard() {
            const sortedDrivers = [...aiDrivers].sort((a, b) => {
                const scoreA = (a.totalLaps * 10000) + a.progress;
                const scoreB = (b.totalLaps * 10000) + b.progress;
                return scoreB - scoreA; 
            });

            sortedDrivers.forEach((driver, index) => {
                const rowObj = leaderboardRows[driver.id];
                
                if (rowObj && rowObj.element) {
                    // üö® [ÏàòÏ†ï] Í≥†Ï†ïÍ∞í 21px ÎåÄÏã† Í≥ÑÏÇ∞Îêú g_rowHeight ÏÇ¨Ïö©
                    rowObj.element.style.transform = `translateY(${index * g_rowHeight}px)`;
                    
                    if (rowObj.posElement) {
                        const currentRank = String(index + 1);
                        if (rowObj.posElement.innerText !== currentRank) {
                            rowObj.posElement.innerText = currentRank;
                            
                            const isMyDriver = (driver.id === getDriverShortId(state.driver));
                            rowObj.posElement.style.color = '#fff';
                            setTimeout(() => {
                                rowObj.posElement.style.color = isMyDriver ? '#FFEC00' : '#ffffff';
                            }, 200);
                        }
                    }
                    
                    rowObj.element.style.zIndex = (index === 0) ? '100' : '10';
                }
            });
            
            stableRanking = sortedDrivers.map(d => d.id);
        }

        function triggerRaceIncident() {
            const victimIndex = Math.floor(Math.random() * aiDrivers.length);
            const victim = aiDrivers[victimIndex];
            
            if (stoppedCarId !== null) return;
            stoppedCarId = victim.id;
            
            const isSC = Math.random() > 0.4; 

            if (isSC) {
                raceStatus = 'SC';
                eventTimer = 3000; 
                updateStatusUI('SAFETY CAR', 'status-sc');
                spawnSafetyCar(); 
            } else {
                raceStatus = 'YELLOW';
                eventTimer = 600; 
                updateStatusUI('YELLOW FLAG', 'status-yellow');
            }
        }

        function spawnSafetyCar() {
            // 1. ÌòÑÏû¨ 1Îì±(Leader) Ï∞æÍ∏∞
            const leader = [...aiDrivers].sort((a, b) => (b.totalLaps + b.progress) - (a.totalLaps + a.progress))[0];
            
            safetyCar.active = true;
            safetyCar.speed = 0.8; // SC Ï¥àÍ∏∞ ÏÜçÎèÑ

            // 2. [ÌïµÏã¨] 1Îì± Ïïû Í≥µÍ∞Ñ Ïä§Ï∫î (Cluster Detection)
            // Í∏∞Î≥∏Ï†ÅÏúºÎ°ú 1Îì±Î≥¥Îã§ 4% ÏïûÏÑ† ÏúÑÏπòÎ•º Î™©ÌëúÎ°ú Ìï©ÎãàÎã§.
            let bestSpawnOffset = 0.04; 
            
            // 1Îì± Ï†ÑÎ∞© 15% Íµ¨Í∞Ñ(0.15) ÎÇ¥Ïóê Îã§Î•∏ Ï∞®(Î∞±ÎßàÏª§)Í∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏Ìï©ÎãàÎã§.
            const scanRange = 0.15; 
            
            // ÏãúÍ∞ÅÏ†ÅÏúºÎ°ú 1Îì± ÏïûÏóê ÏûàÎäî Î™®Îì† Ïû•Ïï†Î¨º(Ï∞®Îüâ)ÏùÑ Í∞êÏßÄ
            let obstacleFarthestOffset = 0;
            let hasObstacle = false;

            aiDrivers.forEach(ai => {
                if (ai.id === leader.id) return; // 1Îì± Î≥∏Ïù∏ÏùÄ Ï†úÏô∏

                // 1Îì±Í≥ºÏùò Í±∞Î¶¨ Í≥ÑÏÇ∞ (Ìä∏Îûô Ìïú Î∞îÌÄ¥ ÎèÑÎäî Í≤É Í≥†Î†§)
                let dist = ai.progress - leader.progress;
                if (dist < 0) dist += 1; 

                // Ïû•Ïï†Î¨ºÏù¥ Ïä§Ï∫î Î≤îÏúÑ ÎÇ¥Ïóê ÏûàÎã§Î©¥
                if (dist > 0 && dist < scanRange) {
                    hasObstacle = true;
                    // Í∞ÄÏû• Î©ÄÎ¶¨ ÏûàÎäî Ïû•Ïï†Î¨º ÏúÑÏπò Í∏∞Î°ù
                    if (dist > obstacleFarthestOffset) {
                        obstacleFarthestOffset = dist;
                    }
                }
            });

            // 3. ÏúÑÏπò Î≥¥Ï†ï
            if (hasObstacle) {
                // Î∞±ÎßàÏª§Í∞Ä ÏûàÎã§Î©¥, Í∑∏ Î∞±ÎßàÏª§Îì§Î≥¥Îã§ Ï°∞Í∏à Îçî(0.04) ÏïûÏóêÏÑú ÏÜåÌôò -> "Î∞±ÎßàÏª§Îäî Îí§Î°ú Î≥¥ÎÇ¥Í≥† SCÍ∞Ä Îß® Ïïû"
                bestSpawnOffset = obstacleFarthestOffset + 0.04;
            }

            // 4. ÏµúÏ¢Ö ÏúÑÏπò Ï†ÅÏö©
            safetyCar.progress = leader.progress + bestSpawnOffset;
            
            // Ìä∏Îûô Î≤îÏúÑ(0~1) Ï¥àÍ≥º Ïãú Î≥¥Ï†ï
            if (safetyCar.progress >= 1) safetyCar.progress -= 1;
            
            safetyCar.element.style.display = 'block';
        }

/* üí° [Ï†ÑÏ≤¥ ÏàòÏ†ï] animateAIDrivers: SC Ï¥àÎ∞ÄÏ∞© + Yellow ÏÇ¨Í≥†Ï∞®Îüâ Ï∂îÏõî ÌóàÏö© */
function animateAIDrivers() {
    const track = document.getElementById('bg-track');
    if(!track) { requestAnimationFrame(animateAIDrivers); return; }
    
    const len = track.getTotalLength();
    const now = Date.now();

    // ÏàúÏúÑ ÏÇ∞Ï†ï
    const battleRank = [...aiDrivers].sort((a, b) => (b.totalLaps + b.progress) - (a.totalLaps + a.progress));

    // 1. ÎûúÎç§ ÏÇ¨Í≥† Î∞úÏÉù (Î†àÏù¥Ïä§ ÏãúÏûë ÌõÑ, ÏïàÏ†ïÌôîÎê† ÎïåÍπåÏßÄ ÎåÄÍ∏∞)
    if (raceStarted && raceStatus === 'GREEN') {
        const leader = battleRank[0];
        
        // üí° [ÏàòÏ†ï] Ï¥àÎ∞ò Í¥ëÌÅ¥Î¶≠ ÏÇ¨Í≥† Î∞©ÏßÄ Î°úÏßÅ
        if (leader && leader.totalLaps >= 1) {
            if (Math.random() < 0.00025) triggerRaceIncident();
        }
    }

    // 2. Ïù¥Î≤§Ìä∏ ÌÉÄÏù¥Î®∏
    if (raceStatus !== 'GREEN') {
        eventTimer--;
        if (raceStatus === 'SC' && eventTimer === 180) {
            raceStatus = 'SC_ENDING';
            updateStatusUI('SC ENDING', 'status-sc');
        }
        if ((raceStatus === 'SC_ENDING' || raceStatus === 'YELLOW') && eventTimer <= 0) {
            resumeRace();
        }
    }

    // 3. SC Î°úÏßÅ
    if (safetyCar.active) {
        if (raceStatus === 'SC_ENDING') {
            safetyCar.element.style.display = 'none';
            safetyCar.active = false; 
        } else {
            safetyCar.progress += 0.8 * 0.00026 * state.speedFactor;
            if (safetyCar.progress >= 1) safetyCar.progress -= 1;

            const pt = track.getPointAtLength(len * safetyCar.progress);
            safetyCar.element.setAttribute('transform', `translate(${pt.x}, ${pt.y}) scale(${state.scaleFactor})`);
        }
    }

    // 4. AI ÎìúÎùºÏù¥Î≤Ñ Î£®ÌîÑ
    aiDrivers.forEach(ai => {
        if (raceStarted) {
            // ÏÇ¨Í≥† Ï∞®Îüâ
            if (ai.id === stoppedCarId) {
                ai.actualSpeed *= 0.9;
                if (ai.actualSpeed < 0.01) ai.actualSpeed = 0;
                ai.element.classList.add('stopped');
                const pt = track.getPointAtLength(len * ai.progress);
                ai.element.setAttribute('transform', `translate(${pt.x}, ${pt.y}) scale(${state.scaleFactor})`);
                return; 
            } else {
                ai.element.classList.remove('stopped');
            }

            // ÏÉÅÌÉú ÌÉÄÏù¥Î®∏
            if (!ai.battleState) { ai.battleState = 'normal'; ai.battleTimer = 0; ai.cooldown = 0; }
            if (!ai.conditionState) { ai.conditionState = 'normal'; ai.conditionTimer = 0; }
            if (ai.battleTimer > 0) ai.battleTimer--;
            if (ai.cooldown > 0) ai.cooldown--;
            if (ai.conditionTimer > 0) ai.conditionTimer--;
            if (ai.battleState !== 'normal' && ai.battleTimer <= 0) { ai.battleState = 'normal'; ai.cooldown = 200; }
            if (ai.conditionState !== 'normal' && ai.conditionTimer <= 0) ai.conditionState = 'normal';

            // Ìä∏Îûô ÌòïÏÉÅ ÏÜçÎèÑ
            const currentIndex = Math.floor(ai.progress * 1000) % 1000;
            const lookAheadIndex = (currentIndex + 20) % 1000;
            const normalTrackFactor = (trackSpeedProfile[currentIndex] * 0.6) + (trackSpeedProfile[lookAheadIndex] * 0.4);

            let targetSpeed = ai.baseSpeed;
            let currentLerpRate = 0.05;

            // =========================
            // üö• ÏÉÅÌô©Î≥Ñ Ï£ºÌñâ ÏïåÍ≥†Î¶¨Ï¶ò
            // =========================

            if (raceStatus === 'GREEN') {
                // [GREEN] ÏùºÎ∞ò Ï£ºÌñâ (Í∏∞Ï°¥ Ïú†ÏßÄ)
                let conditionBoost = 1.0;
                if (ai.conditionState === 'super') conditionBoost = 1.35;
                else if (ai.conditionState === 'slump') conditionBoost = 0.75;
                else if (ai.conditionState === 'normal' && ai.battleState === 'normal') {
                    const isPlayer = (ai.id === getDriverShortId(state.driver));
                    const eventChance = isPlayer ? 0.0008 : 0.0005; 
                    if (Math.random() < eventChance) {
                        if (Math.random() < (isPlayer ? 0.9 : 0.5)) { ai.conditionState = 'super'; ai.conditionTimer = 300; }
                        else { ai.conditionState = 'slump'; ai.conditionTimer = 240; }
                    }
                }

                let battleBoost = 1.0;
                if (ai.battleState === 'boost') battleBoost = 1.15;
                else if (ai.battleState === 'lag') battleBoost = 0.90;
                else if (ai.battleState === 'normal' && ai.cooldown <= 0) {
                    const myIdx = battleRank.findIndex(r => r.id === ai.id);
                    if (myIdx > 0) {
                        const ahead = battleRank[myIdx - 1];
                        const dist = (ahead.totalLaps + ahead.progress) - (ai.totalLaps + ai.progress);
                        if (dist > 0 && dist < 0.02) {
                            const isPlayer = (ai.id === getDriverShortId(state.driver));
                            if (Math.random() < (isPlayer ? 0.7 : 0.4)) { ai.battleState = 'boost'; ai.battleTimer = 150; }
                            else { ai.battleState = 'lag'; ai.battleTimer = 100; }
                        }
                    }
                }

                let calculatedSpeed = ai.baseSpeed * normalTrackFactor * battleBoost * conditionBoost;
                
                const myIdx = battleRank.findIndex(r => r.id === ai.id);
                if (myIdx > 0) {
                    const ahead = battleRank[myIdx - 1];
                    const dist = (ahead.totalLaps + ahead.progress) - (ai.totalLaps + ai.progress);
                    if (ai.battleState === 'boost') { targetSpeed = calculatedSpeed; } 
                    else if (dist < 0.005 && ai.actualSpeed > ahead.actualSpeed) { targetSpeed = ahead.actualSpeed; currentLerpRate = 0.2; } 
                    else { targetSpeed = calculatedSpeed; }
                } else { targetSpeed = calculatedSpeed; }

} else if (raceStatus === 'YELLOW') {
                // üü° [YELLOW] Ï†úÌïú ÏÜçÎèÑ ÎÇ¥ Ï£ºÌñâ + ÏïûÏ∞® Ï∂îÍ≤© ÌóàÏö© + Ï∂îÏõî Ï†àÎåÄ Í∏àÏßÄ
                
                // 1. Í∏∞Î≥∏ ÏÜçÎèÑ Ï†úÌïú ÏÉÅÌñ• (0.75 -> 0.9)
                // ÏΩîÎÑàÏóêÏÑú ÎÑàÎ¨¥ ÎäêÎ¶¨ÏßÄ ÏïäÍ≤å, ÌèâÏÜåÏùò 90% ÏàòÏ§ÄÏúºÎ°ú Îã¨Î¶ΩÎãàÎã§.
                // Îã§Îßå ÏßÅÏÑ†Ï£ºÎ°úÏóêÏÑúÎäî ÌíÄÏïÖÏÖÄÏùÑ Î™ª Î∞üÎäî ÎäêÎÇåÏù¥ Îê©ÎãàÎã§.
                let limitSpeed = ai.baseSpeed * normalTrackFactor * 0.9;
                targetSpeed = limitSpeed;

                // 2. ÏïûÏ∞® Í∞êÏßÄ (ÏÇ¨Í≥†Ï∞® Ï†úÏô∏)
                let minDistY = 100;
                let carAhead = null;
                
                aiDrivers.forEach(other => {
                    if (other.id !== ai.id && other.id !== stoppedCarId) { 
                        let d = other.progress - ai.progress;
                        if (d < 0) d += 1; 

                        if (d < minDistY) {
                            minDistY = d;
                            carAhead = other;
                        }
                    }
                });

                // 3. Í∞ÑÍ≤© Ï¢ÅÌûàÍ∏∞ Î∞è Ï∂îÏõî Î∞©ÏßÄ Î°úÏßÅ
                if (carAhead) {
                    // üß≤ [ÌïµÏã¨ Î≥ÄÍ≤Ω] : Î¨¥Ï°∞Í±¥ ÏÜçÎèÑÎ•º ÎßûÏ∂îÎäî Í≤å ÏïÑÎãàÎùº,
                    // 'ÏïàÏ†Ñ Í±∞Î¶¨(0.02)' Î∞ñÏù¥ÎùºÎ©¥ Ï†úÌïú ÏÜçÎèÑ(limitSpeed)Î°ú Í≥ÑÏÜç Îã¨Î†§ÏÑú ÏïûÏ∞®Î•º Îî∞ÎùºÏû°ÏäµÎãàÎã§.
                    const safeDistance = 0.02; // ÏïûÏ∞®ÏôÄÏùò ÏµúÏÜå Ïú†ÏßÄ Í±∞Î¶¨

                    if (minDistY <= safeDistance) {
                        // üö´ ÏïàÏ†Ñ Í±∞Î¶¨ ÏßÑÏûÖ Ïãú: ÏïûÏ∞® ÏÜçÎèÑÏóê ÎèôÍ∏∞Ìôî (Ï∂îÏõî Í∏àÏßÄ)
                        if (targetSpeed > carAhead.actualSpeed) {
                            targetSpeed = carAhead.actualSpeed;
                            
                            // ÎÑàÎ¨¥ Îî± Î∂ôÏúºÎ©¥(0.01 ÎØ∏Îßå) ÏÇ¥Ïßù Î∏åÎ†àÏù¥ÌÅ¨
                            if (minDistY < 0.01) targetSpeed *= 0.9; 
                        }
                        currentLerpRate = 0.3; // Î∞òÏùë ÏÜçÎèÑ Îπ†Î¶Ñ
                    } else {
                        // üöÄ ÏïàÏ†Ñ Í±∞Î¶¨ Î∞ñÏûÑ: Í∑∏ÎÉ• ÎÇ¥ ÏÜçÎèÑ(limitSpeed)ÎåÄÎ°ú Îã¨Î†§ÏÑú Í∞ÑÍ≤©ÏùÑ Ï¢ÅÌûò
                        // Î≥ÑÎèÑ Í∞êÏÜç Î°úÏßÅ ÏóÜÏùå
                        currentLerpRate = 0.1;
                    }
                }

            } else if (raceStatus === 'SC' || raceStatus === 'SC_ENDING') {
                // üöë [SC Î™®Îìú] ÏÇ¨Í≥†Ï∞® Î¨¥Ïãú + Î∞±ÎßàÏª§ ÎπÑÏºúÏ£ºÍ∏∞ Î°úÏßÅ Ï∂îÍ∞Ä
                
                let minDist = 100; 
                let objectAhead = null; 
                
                // 1. SC Í∞êÏßÄ
                if (safetyCar.active) {
                    let d = safetyCar.progress - ai.progress;
                    if (d < 0) d += 1; 
                    if (d < minDist) {
                        minDist = d;
                        objectAhead = { type: 'SC', speed: 0.8 }; 
                    }
                }

                // 2. ÏïûÏ∞® Í∞êÏßÄ (ÏÇ¨Í≥†Ï∞® Ï†úÏô∏)
                aiDrivers.forEach(other => {
                    if (other.id !== ai.id && other.id !== stoppedCarId) {
                        let d = other.progress - ai.progress;
                        if (d < 0) d += 1; 
                        if (d < minDist) {
                            minDist = d;
                            objectAhead = { type: 'CAR', speed: other.actualSpeed };
                        }
                    }
                });

                // 3. ÏÜçÎèÑ Í≤∞Ï†ï Î°úÏßÅ
                if (objectAhead) {
                    const isSC = (objectAhead.type === 'SC');
                    
                    // [Ïã†Í∑ú] ÎÇ¥Í∞Ä 1Îì±Ïù¥ ÏïÑÎãåÎç∞(Î∞±ÎßàÏª§Ïù∏Îç∞) Î∞îÎ°ú ÏïûÏù¥ SCÎùºÎ©¥?
                    // -> 1Îì±Í≥º SC ÏÇ¨Ïù¥Ïóê ÎÅºÏñ¥ÏûàÎäî ÏÉÅÌô©Ïù¥ÎØÄÎ°ú, ÏÜçÎèÑÎ•º Ïò¨Î†§ÏÑú SCÎ•º Ï∂îÏõî(Ghost Pass)Ìï¥Î≤ÑÎ¶¨Í±∞ÎÇò Í∞ÑÍ≤©ÏùÑ Ï¢ÅÌûò
                    // Ïó¨Í∏∞ÏÑúÎäî SCÏôÄ ÎÑàÎ¨¥ Í∞ÄÍπåÏö∞Î©¥ Í∞êÏÜçÌïòÎêò, 1Îì±Î≥¥Îã§Îäî Îπ®Î¶¨ Îã¨Î¶¨Í≤å ÏÑ§Ï†ï
                    
                    if (minDist < 0.002) { 
                        targetSpeed = objectAhead.speed * 0.5; 
                        currentLerpRate = 0.5; 
                    } else if (minDist < 0.006) {
                        targetSpeed = objectAhead.speed; 
                        currentLerpRate = 0.3; 
                    } else {
                        // SC ÏÉÅÌô©ÏóêÏÑúÏùò Í∏∞Î≥∏ Ï£ºÌñâ ÏÜçÎèÑ
                        targetSpeed = 1.8; 
                        if (isSC && minDist < 0.15) {
                            // SC Îí§Ïóê Î∂ôÏóàÏùÑ Îïå ÏÜçÎèÑ ÎßûÏ∂§
                            targetSpeed = 0.9; 
                        }
                        currentLerpRate = 0.08;
                    }
                } else {
                    // ÏïûÏóê ÏïÑÎ¨¥Í≤ÉÎèÑ ÏóÜÏúºÎ©¥ (SC ÏóîÎî© ÏãúÏ†ê Îì±)
                    if (raceStatus === 'SC_ENDING') {
                        targetSpeed = ai.baseSpeed * normalTrackFactor * 1.3;
                        currentLerpRate = 0.05;
                    } else {
                        targetSpeed = 0.8;
                        currentLerpRate = 0.1;
                    }
                }
            }

            // üåü [ÏàòÏ†ï] Ï£ºÏù∏Í≥µ Î≥¥Ï†ïÏπò Ï°∞Ï†ï
            // Í∏∞Ï°¥ 1.02(2%) -> 1.0035(0.35%)Î°ú ÌïòÌñ•
            // Ïù¥Ï†ú Îò•Ï∞®Î°ú Ïö∞ÏäπÌïòÎ†§Î©¥ 'Ïö¥(Î∞îÏù¥Ïò§Î¶¨Îì¨)'Í≥º 'Ï†ÑÎûµ'Ïù¥ ÏôÑÎ≤ΩÌï¥Ïïº Ìï©ÎãàÎã§.
            if (ai.id === getDriverShortId(state.driver)) {
                targetSpeed *= 1.0035; 
            }
            
            // Î¨ºÎ¶¨ Ï†ÅÏö©
            ai.actualSpeed += (targetSpeed - ai.actualSpeed) * currentLerpRate;
            ai.progress += ai.actualSpeed * 0.00026 * state.speedFactor;
            
            if (ai.progress >= 1) {
                ai.progress -= 1;
                ai.totalLaps += 1;
            }
        } 
        
        // Î†åÎçîÎßÅ
        const pt = track.getPointAtLength(len * ai.progress);
        const jitterPower = (raceStatus === 'GREEN') ? 2.0 : 0.0;
        const jitterX = (Math.sin(now/200 + ai.randomFactor) * jitterPower); 
        const jitterY = (Math.cos(now/200 + ai.randomFactor) * jitterPower);
        ai.element.setAttribute('transform', `translate(${pt.x + jitterX}, ${pt.y + jitterY}) scale(${state.scaleFactor})`);
    });

    if(raceStarted) updateLeaderboard();
    requestAnimationFrame(animateAIDrivers);
}

        function resumeRace() {
            raceStatus = 'GREEN';
            stoppedCarId = null;
            safetyCar.active = false;
            safetyCar.element.style.display = 'none'; 
            
            updateStatusUI('GREEN FLAG', 'status-green');
            setTimeout(() => {
                if(raceStatus === 'GREEN') document.getElementById('race-status-display').style.opacity = '0';
            }, 2000);
        }

        /* üí° [ÏàòÏ†ï] ÏÉÅÎã® ÌëúÏãúÍ∏∞ + Î™®Î∞îÏùº Ìå®ÎÑê ÎèôÏãú Ï†úÏñ¥ */
        function updateStatusUI(text, cssClass) {
            // 1. Í∏∞Ï°¥ ÏÉÅÎã® ÌëúÏãúÍ∏∞ (PC/Î™®Î∞îÏùº Í≥µÌÜµ)
            const el = document.getElementById('race-status-display');
            el.innerText = text;
            el.className = ''; 
            el.classList.add(cssClass);
            el.style.opacity = '1';

            // 2. [Ïã†Í∑ú] Î™®Î∞îÏùº ÌïòÎã® Ìå®ÎÑê Ï†úÏñ¥
            const mobilePanel = document.getElementById('mobile-status-panel');
            if (mobilePanel) {
                // Í∏∞Ï°¥ ÌÅ¥ÎûòÏä§ Ï¥àÍ∏∞Ìôî
                mobilePanel.className = 'status-panel';
                
                if (text.includes('GREEN')) {
                    // Í∑∏Î¶∞ ÌîåÎûòÍ∑∏Î©¥ Ï¶âÏãú Ïà®ÍπÄ
                    mobilePanel.style.display = 'none';
                } else {
                    // ÏÇ¨Í≥† ÏÉÅÌô©Ïù¥Î©¥ ÌëúÏãú
                    mobilePanel.innerText = text;
                    mobilePanel.style.display = 'block';
                    
                    // ÏÉâÏÉÅ ÌÅ¥ÎûòÏä§ Ï†ÅÏö©
                    if (cssClass.includes('sc')) mobilePanel.classList.add('sc');
                    else if (cssClass.includes('yellow')) mobilePanel.classList.add('yellow');
                }
            }
        }

        function toggleAudio() {
            isMuted = !isMuted;
            const onIcon = document.getElementById('icon-sound-on'), offIcon = document.getElementById('icon-sound-off');
            if (bgmPlayer && bgmPlayer.setVolume) bgmPlayer.setVolume(isMuted ? 0 : 70);
            onIcon.style.display = isMuted ? 'none' : 'block';
            offIcon.style.display = isMuted ? 'block' : 'none';
        }

        function activateEngine() {
            document.getElementById('start-engine-btn').style.display = 'none';
            if (bgmPlayer && bgmPlayer.playVideo) { bgmPlayer.setVolume(70); bgmPlayer.playVideo(); }
            startRaceSequence();
        }

        function startRaceSequence() {
            let lightCount = 1;
            function turnOnNextLight() {
                if (lightCount <= 5) {
                    document.getElementById(`light-${lightCount}`).classList.add('on');
                    document.getElementById(`light-${lightCount}b`).classList.add('on');
                    lightCount++; setTimeout(turnOnNextLight, 800);
                } else {
                    setTimeout(() => {
                        document.querySelectorAll('.f1-light').forEach(l => l.classList.remove('on'));
                        raceStarted = true;
                        document.getElementById('loading-overlay').style.opacity = '0';
                        setTimeout(() => document.getElementById('loading-overlay').style.display = 'none', 300);
                    }, 1000);
                }
            }
            turnOnNextLight();
        }

        function addMoney() {
            const btn = document.querySelector('.box-btn');
            btn.classList.add('flash-active');
            setTimeout(() => btn.classList.remove('flash-active'), 150);
            
            const today = new Date();
            const todayStr = today.toDateString(); 

            // 1. ÏûÖÍ∏à ÏßÄÏ†ïÏùº(DD) Ï≤¥ÌÅ¨ (ÏÑúÏàò ÌëúÍ∏∞ Î°úÏßÅ Ï∂îÍ∞Ä)
            if (today.getDate() !== state.savingsDay) { 
                const d = state.savingsDay;
                
                // üí° ÎÇ†Ïßú Îí§Ïóê Î∂ôÎäî Ï†ëÎØ∏ÏÇ¨(Suffix) Í≥ÑÏÇ∞
                // 1, 21, 31 -> st
                // 2, 22 -> nd
                // 3, 23 -> rd
                // ÎÇòÎ®∏ÏßÄ(11, 12, 13 Ìè¨Ìï®) -> th
                const j = d % 10, k = d % 100;
                let suffix = "th";
                if (j === 1 && k !== 11) suffix = "st";
                else if (j === 2 && k !== 12) suffix = "nd";
                else if (j === 3 && k !== 13) suffix = "rd";

                showTooltip(`NOT YET, BOX ON THE ${d}${suffix}`); 
                return; 
            }

            // 2. Ï§ëÎ≥µ ÏûÖÍ∏à Î∞©ÏßÄ
            if (state.lastDepositDate === todayStr) {
                showTooltip("ALREADY BOXED! SAVE TIRES.");
                return;
            }

            // 3. Î™©Ìëú Í∏àÏï° Ï¥àÍ≥º Î∞©ÏßÄ
            const totalGoal = state.q1 + state.q2 + state.q3;
            if (state.currentAmount >= totalGoal) { 
                showTooltip("MAX POWER REACHED"); 
                return; 
            }

            // 4. ÏûÖÍ∏à Ïã§Ìñâ
            state.currentAmount += state.depositUnit;
            if(state.currentAmount > totalGoal) state.currentAmount = totalGoal;
            
            // 5. Ïò§Îäò ÎÇ†ÏßúÎ•º 'ÎßàÏßÄÎßâ ÏûÖÍ∏àÏùº'Î°ú Í∏∞Î°ù
            state.lastDepositDate = todayStr;
            
            // 6. ÏÑ∏ÏÖò Î≥ÄÍ≤Ω Î∞è Ï†ÄÏû• Î°úÏßÅ
            let checkS = state.currentAmount >= totalGoal ? 'FINISH' : state.currentAmount >= (state.q1 + state.q2) ? 'Q3' : state.currentAmount >= state.q1 ? 'Q2' : 'Q1';
            if (checkS !== state.lastSession && checkS !== 'Q1') triggerCelebration(state.lastSession);
            state.lastSession = checkS;
            
            saveData(); 
            updateDashboard();
        }

        function updateDashboard() {
            // 1. ÌôîÎ©¥ ÌëúÏãú Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ (ÌåÄ, ÎìúÎùºÏù¥Î≤Ñ, ÏÑúÌÇ∑)
            document.body.className = state.team;
            document.getElementById('display-name').innerHTML = `<span>${state.driver}</span>`;
            
            const data = circuitsData.find(c => c.id === state.circuitId);
            if(data) {
                document.getElementById('disp-country').innerText = data.country;
                document.getElementById('disp-circuit').innerText = data.name;
            }

            // 2. üö® ÌïµÏã¨: 3-Lap ÏãúÏä§ÌÖú Í≥ÑÏÇ∞ Î°úÏßÅ
            const totalGoal = state.q1 + state.q2 + state.q3;
            let targetP = 0;
            let step = "[Q1]";
            let name = "HOTEL";

            // [Lap 1] Q1 Íµ¨Í∞Ñ: 0Ïõê ~ Q1 Î™©ÌëúÏï°
            if (state.currentAmount < state.q1) { 
                // Q1 Î™©ÌëúÏï° ÎåÄÎπÑ ÌòÑÏû¨ Îã¨ÏÑ±Î•† (0% ~ 100%)
                targetP = state.currentAmount / state.q1;
                step = "[Q1]";
                name = "HOTEL";
            
            // [Lap 2] Q2 Íµ¨Í∞Ñ: Q1 Îã¨ÏÑ± ÌõÑ ~ Q2 Î™©ÌëúÏï°
            } else if (state.currentAmount < (state.q1 + state.q2)) { 
                // Q1ÏùÄ Ïù¥ÎØ∏ Îã§ Ï±ÑÏõ†Í≥†, Q2 Î™©ÌëúÏï° ÎåÄÎπÑ ÌòÑÏû¨ ÏßÑÌñâÎ•† Í≥ÑÏÇ∞
                // (ÌòÑÏû¨Í∏àÏï° - Q1ÏôÑÎ£åÍ∏àÏï°) / Q2Î™©ÌëúÏï°
                targetP = (state.currentAmount - state.q1) / state.q2;
                step = "[Q2]";
                name = "FLIGHT";
            
            // [Lap 3] Q3 Íµ¨Í∞Ñ: Q2 Îã¨ÏÑ± ÌõÑ ~ ÏµúÏ¢Ö Î™©ÌëúÏï°
            } else if (state.currentAmount < totalGoal) { 
                // Q2ÍπåÏßÄ Îã§ Ï±ÑÏõ†Í≥†, Q3 Î™©ÌëúÏï° ÎåÄÎπÑ ÌòÑÏû¨ ÏßÑÌñâÎ•† Í≥ÑÏÇ∞
                targetP = (state.currentAmount - (state.q1 + state.q2)) / state.q3;
                step = "[Q3]";
                name = "TICKET";
            
            // [FINISH] Î™©Ìëú Îã¨ÏÑ±!
            } else { 
                targetP = 1; // ÍΩâ Ï±ÑÏõÄ
                step = "POLE";
                name = "POSITION";
            }

            // 3. Í≥ÑÏÇ∞Îêú ÏßÑÌñâÎ•†(0.0 ~ 1.0)ÏùÑ Ìä∏ÎûôÏóê Î∞òÏòÅ
            // (ÏÑ∏ÏÖòÏù¥ Î∞îÎÄî ÎïåÎßàÎã§ Ìä∏ÎûôÏù¥ ÎπÑÏõåÏ°åÎã§Í∞Ä Îã§Ïãú Ï∞®Ïò§Î•¥Îäî Ìö®Í≥ºÍ∞Ä ÎÇ©ÎãàÎã§)
            syncTrackFill(Math.max(0, Math.min(1, targetP)));

            // 4. ÌÖçÏä§Ìä∏ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('session-step').innerText = step;
            document.getElementById('session-name').innerText = name;
            document.getElementById('txt-current').innerText = `CUR ‚Ç©${state.currentAmount.toLocaleString()}`;
            
            // ÎùºÎîîÏò§ TAR(Target)Îäî 'Ï†ÑÏ≤¥ Ï¥ùÏï°'ÏùÑ Î≥¥Ïó¨Ï£ºÏñ¥ ÌÅ∞ Î™©ÌëúÎ•º ÏÉÅÍ∏∞ÏãúÌÇµÎãàÎã§.
            document.getElementById('txt-goal').innerText = `TAR ‚Ç©${totalGoal.toLocaleString()}`;

            // 5. ÏÑ§Ï†ï Î™®Îã¨Ïùò ÏûÖÎ†• ÌïÑÎìú Í∞í ÎèôÍ∏∞Ìôî
            document.getElementById('savings-day').value = state.savingsDay;
            document.getElementById('deposit-unit').value = state.depositUnit;
            document.getElementById('manual-amount').value = state.currentAmount;
            document.getElementById('q1-goal').value = state.q1;
            document.getElementById('q2-goal').value = state.q2;
            document.getElementById('q3-goal').value = state.q3;
            document.getElementById('target-date').value = state.targetDate;
        }

        function syncTrackFill(target) {
            if (animId) cancelAnimationFrame(animId);
            const activeTrack = document.getElementById('active-track');
            const totalLength = activeTrack.getTotalLength();
            
            // üí° [ÏàòÏ†ï] Ïò§ÌîÑÏÖã Í≥ÑÏÇ∞ Î∞©Ïãù Î≥ÄÍ≤Ω
            // (1 - offset) Î∞©Ïãù ÎåÄÏã†, ÏùåÏàò Ïò§ÌîÑÏÖã(-offset)ÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ 
            // SVG Ìå®ÌÑ¥Ïùò ÏãúÏûëÏ†êÏùÑ Ïä§ÌÉÄÌåÖ ÎùºÏù∏Ïóê Ï†ïÌôïÌûà Í≥†Ï†ïÌï©ÎãàÎã§.
            const baseOffset = -1 * (totalLength * state.pathStartOffset);

            function frame() {
                visualProgress += (target - visualProgress) * 0.08;
                
                // üí° [ÏàòÏ†ï] Îπà Í≥µÍ∞Ñ(Gap) Ïó¨Ïú†Î∂Ñ ÌôïÎ≥¥
                // Îí∑Î∂ÄÎ∂ÑÏù∏ 'Îπà Í≥µÍ∞Ñ'ÏùÑ Ìä∏Îûô Ï†ÑÏ≤¥ Í∏∏Ïù¥Î≥¥Îã§ 10% Îçî Í∏∏Í≤å Ïû°ÏïÑÏÑú(1.1),
                // ÏßÑÌñâ Î∞îÍ∞Ä 0%Ïùº ÎïåÎÇò 100%Ïùº Îïå ÏûîÏÉÅÏù¥ Í≤πÏ≥ê Î≥¥Ïù¥Îäî ÌòÑÏÉÅÏùÑ Î∞©ÏßÄÌï©ÎãàÎã§.
                activeTrack.style.strokeDasharray = `${totalLength * visualProgress} ${totalLength * 1.1}`;
                activeTrack.style.strokeDashoffset = baseOffset;
                
                if (Math.abs(target - visualProgress) > 0.001) animId = requestAnimationFrame(frame);
            }
            frame();
        }

        function triggerCelebration(sessionName) {
            document.getElementById('celebration-overlay').style.display = 'flex';
            document.getElementById('lap-session-title').innerText = `[${sessionName}] FASTEST LAP`;
            document.getElementById('lap-driver-name').innerText = state.driver;
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        }

        function onYouTubeIframeAPIReady() {
            bgmPlayer = new YT.Player('bgm-player', { height: '0', width: '0', videoId: 'YhX_Woa3kVA', playerVars: { 'autoplay': 0, 'controls': 0, 'loop': 1, 'playlist': 'YhX_Woa3kVA' } });
        }

        function getDriverShortId(n) { return n.substring(0,3).toUpperCase(); }
        function showTooltip(m) { const t = document.getElementById('msg-tooltip'); t.innerText = m; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }
        function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; updateTeamSelectUI(); calculateRecommendation(); }
        function closeCelebration() { document.getElementById('celebration-overlay').style.display = 'none'; }
        function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
        function loadData() { const s = localStorage.getItem(STORAGE_KEY); if (s) state = { ...state, ...JSON.parse(s) }; }
        function shuffleArray(a) { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; }

        function calculateRecommendation() {
            const savingsDay = parseInt(document.getElementById('savings-day').value) || 1;
            const targetDateStr = document.getElementById('target-date').value;
            const curAmt = parseInt(document.getElementById('manual-amount').value) || 0;
            const totalGoal = (parseInt(document.getElementById('q1-goal').value) || 0) + (parseInt(document.getElementById('q2-goal').value) || 0) + (parseInt(document.getElementById('q3-goal').value) || 0);
            const remaining = totalGoal - curAmt;
            const targetDate = new Date(targetDateStr);
            const today = new Date();
            let count = 0, temp = new Date(today);
            if (temp.getDate() > savingsDay) temp.setMonth(temp.getMonth() + 1);
            temp.setDate(savingsDay);
            while (temp <= targetDate) { count++; temp.setMonth(temp.getMonth() + 1); }
            document.getElementById('rec-box').style.display = 'block';
            document.getElementById('rec-msg').innerText = count > 0 ? `REC: ‚Ç©${Math.ceil(remaining/count).toLocaleString()} / month (${count} stops)` : "FULL DEPOSIT NEEDED";
        }

        function saveAndCloseSettings() {
            // 1. ÌòÑÏû¨ ÏûÖÎ†•Îêú Í∞íÎì§ÏùÑ stateÏóê Ï†ÄÏû•
            state.team = document.getElementById('team-select').value;
            state.driver = document.getElementById('driver-select').value;
            
            // Ï£ºÏùò: state.circuitIdÎäî ÎìúÎ°≠Îã§Ïö¥ Î≥ÄÍ≤Ω Ïãú updateCircuit()Ïóê ÏùòÌï¥ Ïù¥ÎØ∏ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§.
            // Ïó¨Í∏∞ÏÑú Îã§Ïãú updateCircuit()ÏùÑ Ìò∏Ï∂úÌïòÎ©¥ Î†àÏù¥Ïä§Í∞Ä Î¶¨ÏÖãÎêòÎØÄÎ°ú Ìò∏Ï∂úÌïòÏßÄ ÏïäÏäµÎãàÎã§.

            state.savingsDay = Number(document.getElementById('savings-day').value);
            state.depositUnit = Number(document.getElementById('deposit-unit').value);
            state.currentAmount = Number(document.getElementById('manual-amount').value);
            
            state.q1 = Number(document.getElementById('q1-goal').value);
            state.q2 = Number(document.getElementById('q2-goal').value);
            state.q3 = Number(document.getElementById('q3-goal').value);
            state.targetDate = document.getElementById('target-date').value;

            // 2. Îç∞Ïù¥ÌÑ∞ ÏòÅÍµ¨ Ï†ÄÏû•
            saveData();

            // 3. üö® ÌïµÏã¨: Ìä∏Îûô Ï¥àÍ∏∞Ìôî ÏóÜÏù¥ ÌôîÎ©¥/ÏãúÎÇòÎ¶¨Ïò§Îßå Í∞±Ïã†
            // Ïù¥Î†áÍ≤å ÌïòÎ©¥ ÏÑúÌÇ∑ÏùÑ Î∞îÍæ∏ÏßÄ ÏïäÍ≥† ÏÑ†ÏàòÎßå Î∞îÍø®ÏùÑ Îïå, 
            // Î†àÏù¥Ïä§ ÏßÑÌñâ ÏÉÅÌô©(ÏúÑÏπò, Îû© Ïàò)ÏùÄ Í∑∏ÎåÄÎ°ú Ïú†ÏßÄÎêú Ï±Ñ ÎÇ¥ Ï∞®Îüâ(ÏÉâÏÉÅ/Ïù¥Î¶Ñ)Îßå Î∞îÎÄùÎãàÎã§.
            updateDashboard();      // ÏÉÅÎã® Ï†ïÎ≥¥/ÏòàÏÇ∞ Í∞±Ïã†
            updateRaceScenario();   // ÎÇ¥ Ï∞®Îüâ ÎßàÏª§(Hero)Îßå ÏÉàÎ°ú ÏßÄÏ†ï

            // 4. Î™®Îã¨ Îã´Í∏∞
            document.getElementById('settings-modal').style.display = 'none';
        }

        function updateDriverList(teamKey) {
            const driverSelect = document.getElementById('driver-select');
            driverSelect.innerHTML = '';
            teamsDB[teamKey].drivers.forEach(d => {
                const opt = document.createElement('option'); opt.value = d; opt.text = d;
                driverSelect.appendChild(opt);
            });
            document.body.className = teamKey;
        }

        function updateTeamSelectUI() {
            document.getElementById('team-select').value = state.team;
            updateDriverList(state.team);
            document.getElementById('driver-select').value = state.driver;
        }

        init();

        function setDriver(val) { 
            state.driver = val; 
            updateRaceScenario(); 
        }
    </script>
</body>
</html>
