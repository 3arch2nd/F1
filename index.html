<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#121212">
    <title>Race to World Tour</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Michroma&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --bg-color: #121212;
            --text-color: #ffffff;
            --font-display: 'Michroma', sans-serif;
            --gray-track: rgba(255, 255, 255, 0.4);
            --f1-purple: #B624FF;
            --team-bg: #060025;
            --team-radio-bg: rgba(6, 0, 37, 0.95);
            --team-primary: #3671C6;
            --team-accent: #FF1E00;
            --track-active-color: var(--f1-purple);
            --marker-bg: #3671C6;
            --marker-text: #ffffff;
            --dynamic-stroke: 10px;
        }

/* 1. ğŸ“Š ë¦¬ë”ë³´ë“œ ì»¨í…Œì´ë„ˆ (ë„ˆë¹„ ì¡°ì •) */
        #leaderboard {
            position: absolute;
            top: 240px;  
            left: 20px;
            
            /* ğŸ’¡ [ìˆ˜ì •] ë„ˆë¹„ ì¶•ì†Œ: 160px -> 105px */
            /* ê¸€ìì™€ ì ë‹¹í•œ ì—¬ë°±ë§Œ ë‚¨ê¸°ê³  ë¶ˆí•„ìš”í•œ ê³µë°± ì œê±° */
            width: 105px; 
            
            z-index: 900;
            display: flex;
            flex-direction: column;
            gap: 3px;
            pointer-events: none; 
            
            /* ë†’ì´ ê³„ì‚° ìœ ì§€ */
            max-height: calc(100vh - 330px);
            overflow: hidden; 
            
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;
            transform-origin: left center;
        }

        /* ğŸ’¡ [ìˆ˜ì •] ìˆ¨ê¹€ ìƒíƒœ ì´ë™ ê±°ë¦¬ ì¡°ì • */
        /* ë„ˆë¹„ê°€ ì¤„ì—ˆìœ¼ë¯€ë¡œ, ì™¼ìª½ìœ¼ë¡œ ìˆ¨ê¸¸ ë•Œ ë„ˆë¬´ ë©€ë¦¬ ë³´ë‚´ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤. */
        /* ê¸°ì¡´ -180px -> -125pxë¡œ ë³€ê²½ (ë„ˆë¹„ + ì•½ê°„ì˜ ì—¬ìœ ) */
        #leaderboard.hidden {
            transform: translateX(-125px) !important;
            opacity: 0;
        }
        /* ğŸš¨ ì¤‘ìš”: ê¸°ì¡´ì— ìˆë˜ @media display: none ì½”ë“œë¥¼ ì—¬ê¸°ì„œ ì‚­ì œí•˜ê±°ë‚˜ ë®ì–´ì”ë‹ˆë‹¤. */
        /* ì´ì œ ëª¨ë°”ì¼ì—ì„œë„ display: noneì´ ë˜ì§€ ì•Šê³ , ë‹¨ì§€ .hidden í´ë˜ìŠ¤ë¡œ ìœ„ì¹˜ë§Œ ì´ë™í•©ë‹ˆë‹¤. */
        @media (max-width: 767px) {
            #leaderboard { display: flex; } /* ê°•ì œë¡œ ë³´ì´ê²Œ ì„¤ì • (ìœ„ì¹˜ ì´ë™ìœ¼ë¡œ ì œì–´) */
        }


        /* 2. ğŸ”˜ í† ê¸€ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ (ìœ„ì¹˜ ê³ ì •) */
        .leaderboard-toggle-container {
            position: absolute;
            bottom: 40px; /* ì˜¤ë””ì˜¤ ë²„íŠ¼ê³¼ ë†’ì´ ë§ì¶¤ */
            left: 30px;
            z-index: 950;
        }

        /* 3. ğŸ”˜ í† ê¸€ ë²„íŠ¼ ë””ìì¸ (Outline Style - ìˆ˜ì •ë¨) */
        #lb-toggle-btn {
            /* ğŸ’¡ [ìˆ˜ì •] ë°°ê²½ íˆ¬ëª… + í…Œë‘ë¦¬ ê°•ì¡° */
            background-color: rgba(0, 0, 0, 0.3); /* ë°°ê²½ ê±°ì˜ íˆ¬ëª… (ê°€ë…ì„± ìœ„í•´ ì•„ì£¼ ì‚´ì§ ì–´ë‘¡ê²Œ) */
            border: 2px solid var(--team-primary); /* í…Œë‘ë¦¬ì— íŒ€ ì»¬ëŸ¬ ì ìš© */
            color: var(--team-primary); /* ì•„ì´ì½˜(+ -)ë„ íŒ€ ì»¬ëŸ¬ */
            
            width: 44px;
            height: 44px;
            border-radius: 50%;
            
            font-family: var(--font-display);
            font-size: 24px;
            font-weight: 400;
            
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            
            /* ê·¸ë¦¼ì & ì• ë‹ˆë©”ì´ì…˜ */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            transition: all 0.2s ease;
            padding: 0;
            padding-bottom: 4px;
            line-height: 1;
            
            /* ëª¨ë°”ì¼ íƒ­ ì‹œ íŒŒë€ ë°•ìŠ¤ ì œê±° */
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }

        /* ğŸ’¡ [ìˆ˜ì •] í˜¸ë²„ íš¨ê³¼ëŠ” PC(ë§ˆìš°ìŠ¤)ì—ì„œë§Œ ì ìš© -> ëª¨ë°”ì¼ í˜¸ë²„ ë©ˆì¶¤ í•´ê²° */
        @media (hover: hover) and (pointer: fine) {
            #lb-toggle-btn:hover {
                background-color: var(--team-primary); /* ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ìƒ‰ ì±„ì›€ */
                color: #fff; /* ì•„ì´ì½˜ í°ìƒ‰ */
                transform: scale(1.1);
                box-shadow: 0 0 15px var(--team-primary);
                border-color: var(--team-primary);
            }
        }

        /* í´ë¦­(í™œì„±) íš¨ê³¼ - ëª¨ë°”ì¼/PC ê³µí†µ (box-btnê³¼ ë™ì¼í•œ ë©”ì»¤ë‹ˆì¦˜) */
        #lb-toggle-btn:active {
            background-color: var(--team-primary) !important;
            color: #fff !important;
            transform: scale(0.90); /* í´ë¦­ ì‹œ ê¾¹ ëˆŒë¦¬ëŠ” ëŠë‚Œ */
            box-shadow: 0 0 10px var(--team-primary);
            transition: none; /* ì¦‰ê° ë°˜ì‘ */
        }

        /* 3. ğŸ“ í–‰(Row) ìŠ¤íƒ€ì¼ (ìœ ì§€) */
        .lb-row {
            display: flex;
            align-items: center;
            height: 32px;
            background: rgba(0, 0, 0, 0.88);
            border-radius: 4px;
            overflow: hidden;
            transition: transform 0.4s;
            position: absolute;
            width: 100%;
            box-shadow: 0 4px 8px rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .lb-pos { width: 32px; text-align: center; font-size: 13px; font-weight: 900; color: #ffffff !important; font-family: var(--font-display); text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .lb-color-strip { width: 6px; height: 100%; }
        .lb-name { flex: 1; font-size: 13px; font-weight: bold; color: #ffffff; font-family: var(--font-display); padding-left: 10px; letter-spacing: 0.5px; white-space: nowrap; }

        /* 4. ğŸ“± ë°˜ì‘í˜• ì´ˆê¸° ìƒíƒœ ì„¤ì • */
        /* PC: ê¸°ë³¸ ë³´ì„ (ìˆ¨ê¹€ í´ë˜ìŠ¤ ì—†ìŒ) */
        /* ëª¨ë°”ì¼/ì‘ì€ í™”ë©´: ê¸°ë³¸ ìˆ¨ê¹€ (JSì—ì„œ ì²˜ë¦¬í•˜ê±°ë‚˜ CSSë¡œ ì´ˆê¸° ìœ„ì¹˜ ì§€ì •) */
        @media (max-width: 768px) {
            /* ëª¨ë°”ì¼ì—ì„œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê²¨ì§„ ìƒíƒœë¡œ ì‹œì‘ */
            /* JS init()ì—ì„œ í´ë˜ìŠ¤ë¥¼ ì¶”ê°€í•  ì˜ˆì • */
        }

        /* ğŸ’¡ [ìˆ˜ì •] ê¸€ìê°€ ê¸¸ì–´ë„ ì ˆëŒ€ ì¤„ë°”ê¿ˆ ì•ˆ ë˜ê²Œ ì„¤ì • & ì¤‘ì•™ ì •ë ¬ ëŠë‚Œ */
        #race-status-display {
            position: absolute;
            top: 195px;
            left: 15px;
            width: auto;
            min-width: 120px;
            padding: 0 12px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 11px;
            font-family: var(--font-display);
            border-radius: 4px;
            z-index: 901;
            opacity: 0;
            transition: opacity 0.3s;
            letter-spacing: 1px;
            white-space: nowrap; /* ğŸš¨ í•µì‹¬: ì¤„ë°”ê¿ˆ ì ˆëŒ€ ê¸ˆì§€ */
            box-sizing: border-box;
        }

        /* ìƒíƒœë³„ ìŠ¤íƒ€ì¼ */
        .status-sc { background-color: #FF8700; color: #000; box-shadow: 0 0 10px #FF8700; }
        .status-yellow { background-color: #FFD700; color: #000; box-shadow: 0 0 10px #FFD700; }
        .status-green { background-color: #00D632; color: #fff; box-shadow: 0 0 10px #00D632; }

        /* ê³ ì¥ë‚œ ì°¨ëŸ‰ ìŠ¤íƒ€ì¼ (ê¹œë¹¡ì„) */
        .ai-marker.stopped rect { fill: #333 !important; stroke: #FF0000 !important; stroke-width: 2px; }
        .ai-marker.stopped text { fill: #FF0000 !important; }

        /* í–‰ ë†’ì´ ë° í°íŠ¸ ì¶•ì†Œ */
        .lb-row {
            display: flex;
            align-items: center;
            height: 20px; /* 24px -> 20pxë¡œ ì¶•ì†Œ */
            background: rgba(0, 0, 0, 0.8);
            border-radius: 2px;
            overflow: hidden;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: absolute;
            width: 100%;
        }

        .lb-pos {
            width: 22px; /* ë„ˆë¹„ ì¶•ì†Œ */
            text-align: center;
            font-size: 9px; /* í°íŠ¸ ì¶•ì†Œ */
            font-weight: bold;
            color: #ffffff !important;
            font-family: var(--font-display);
        }

        .lb-color-strip {
            width: 3px; /* 4px -> 3px */
            height: 100%;
        }

        .lb-name {
            flex: 1;
            font-size: 10px; /* 12px -> 10px */
            font-weight: bold;
            color: #ffffff;
            font-family: var(--font-display);
            letter-spacing: 0px;
            padding-left: 5px;
        }

        /* Team Styles */
        body.redbull { --team-bg: #060025; --team-radio-bg: rgba(6, 0, 37, 0.95); --team-primary: #3671C6; --team-accent: #FCD116; --track-active-color: var(--f1-purple); --marker-bg: #FFEC00; --marker-text: #000000; }
        body.redbull .driver-name span, body.redbull #txt-current { color: #3671C6 !important; text-shadow: 0 0 2px rgba(0, 0, 0, 0.5); }
        body.redbull #txt-goal { color: rgba(255, 255, 255, 0.6); }
        body.redbull .radio-label { color: #ffffff !important; }
        body.redbull .box-btn { color: #FF1E00; border-color: #FF1E00; }
        @media (hover: hover) and (pointer: fine) { body.redbull .box-btn:hover { background-color: #FF1E00; color: #fff; box-shadow: 0 0 20px rgba(255, 30, 0, 0.6); } }
        body.redbull .box-btn:active, body.redbull .box-btn.flash-active { background-color: #FF1E00 !important; color: #fff !important; box-shadow: 0 0 20px rgba(255, 30, 0, 0.8) !important; }

        body.mercedes { --team-bg: #121212; --team-radio-bg: rgba(20, 20, 20, 0.95); --team-primary: #00D2BE; --team-accent: #00D2BE; --track-active-color: var(--f1-purple); --marker-bg: #00D2BE; --marker-text: #000000; }
        body.ferrari { --team-bg: #1A0000; --team-radio-bg: rgba(40, 0, 0, 0.95); --team-primary: #FF2800; --team-accent: #FFF200; --track-active-color: var(--f1-purple); --marker-bg: #FF2800; --marker-text: #ffffff; }
        body.mclaren { --team-bg: #151515; --team-radio-bg: rgba(21, 21, 21, 0.95); --team-primary: #FF8000; --team-accent: #FF8000; --track-active-color: var(--f1-purple); --marker-bg: #FF8000; --marker-text: #000000; }
        body.mclaren .box-btn { color: #FF8000; border-color: #FF8000; }
        @media (hover: hover) and (pointer: fine) { body.mclaren .box-btn:hover { background-color: #FF8000; color: #000000; box-shadow: 0 0 20px rgba(255, 128, 0, 0.6); } }
        body.mclaren .box-btn:active, body.mclaren .box-btn.flash-active { background-color: #FF8000 !important; color: #000000 !important; box-shadow: 0 0 20px rgba(255, 128, 0, 0.8) !important; }
        
        body.astonmartin { --team-bg: #002420; --team-primary: #CEDC00; --team-accent: #CEDC00; }
        body.alpine { --team-bg: #00102A; --team-primary: #0090FF; --team-accent: #FD4BC7; }
        body.williams { --team-bg: #040015; --team-primary: #00A0DE; --team-accent: #FFFFFF; }
        body.rb { --team-bg: #040814; --team-primary: #3671C6; --team-accent: #00D632; }
        body.sauber { --team-bg: #1C1C1C; --team-primary: #C0C0C0; --team-accent: #FF0000; }
        body.haas { --team-bg: #000000; --team-primary: #E6002B; --team-accent: #FFFFFF; }
body.cadillac { 
            --team-bg: #0A0A0A; 
            --team-primary: #F1B315; 
            --team-accent: #FFFFFF; 
            --marker-bg: #F1B315; /* ë§ˆì»¤ ë°°ê²½: ê³¨ë“œ */
            --marker-text: #000000; /* ë§ˆì»¤ ê¸€ì: ê²€ì • */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: var(--team-bg); color: var(--text-color); font-family: var(--font-display); height: 100vh; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; transition: background 0.5s ease; }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.3s ease-out; }
        .lights-container { display: flex; gap: 15px; padding: 20px; background: #111; border-radius: 10px; border: 2px solid #333; margin-bottom: 30px; }
        .light-pair { display: flex; flex-direction: column; gap: 5px; }
        .f1-light { width: 40px; height: 40px; background-color: rgba(255, 0, 0, 0.2); border-radius: 50%; border: 3px solid #222; transition: all 0.1s ease; }
        .f1-light.on { background-color: #ff0000; box-shadow: 0 0 30px #ff0000, 0 0 10px #ff0000 inset; border-color: #500; }
        .loading-text { color: #fff; font-family: var(--font-display); font-size: 14px; letter-spacing: 2px; animation: blink 1s infinite; margin-bottom: 20px; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        #start-engine-btn { background: transparent; color: #fff; border: 2px solid #fff; padding: 15px 40px; font-family: var(--font-display); font-size: 16px; font-weight: bold; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; transition: all 0.3s ease; box-shadow: 0 0 15px rgba(255,255,255,0.2); }
        #start-engine-btn:hover { background: #fff; color: #000; box-shadow: 0 0 30px rgba(255,255,255,0.6); }
        #bgm-player { position: absolute; top: -9999px; left: -9999px; visibility: hidden; pointer-events: none; }

        .header-container { position: absolute; top: 0; left: 0; width: 100%; padding: 40px 20px 0 20px; display: flex; gap: 15px; z-index: 100; align-items: flex-start; justify-content: space-between; }
        .logo-box { flex: 0 1 auto; width: auto; background: transparent; border: none; display: flex; flex-direction: column; justify-content: flex-start; align-items: flex-start; padding: 0; }
        .f1-logo { width: 60px; height: auto; object-fit: contain; filter: brightness(0) invert(1); margin-bottom: 15px; }
        .circuit-info { text-align: left; margin-top: 0; width: 100%; }
        .circuit-country { font-size: 10px; color: var(--team-accent); font-weight: bold; letter-spacing: 1px; text-transform: uppercase; }
        .circuit-name { font-size: 9px; color: rgba(255,255,255,0.7); font-weight: normal; margin-top: 2px; line-height: 1.2; white-space: nowrap; }
        .status-container { display: flex; flex-direction: row; align-items: center; gap: 6px; margin-top: 15px; }
        .session-step { font-size: 11px; font-weight: bold; color: var(--team-accent); letter-spacing: 1px; }
        .session-name { font-size: 11px; font-weight: bold; color: #fff; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; }

        .radio-box { flex: 0 0 auto; width: 180px; background: var(--team-radio-bg); border: 4px solid rgba(255, 255, 255, 0.1); border-radius: 4px; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.8); margin-left: auto; border: 1px solid rgba(255,255,255,0.2); }
        .radio-content-section { padding: 15px 10px 20px 10px; display: flex; flex-direction: column; gap: 12px; justify-content: center; flex: 1; }
        .radio-top-section { padding: 8px 8px 0px 8px; text-align: right; overflow: hidden; }
        .driver-name { font-size: 13px; font-weight: bold; color: #fff; text-transform: uppercase; letter-spacing: -0.5px; transform: scaleX(1.1); transform-origin: right; display: inline-block; white-space: nowrap; }
        .driver-name span { color: var(--team-accent); }
        .radio-label { display: block; margin-top: 2px; font-size: 8px; font-weight: bold; color: #fff; letter-spacing: 2px; opacity: 0.8; }
        .audio-wave-divider { width: 100%; height: 20px; display: flex; justify-content: space-between; align-items: flex-end; padding: 0 5px; margin: 5px 0; }
        .bar { flex: 1; margin: 0 1px; background-color: var(--team-primary); transform-origin: bottom; height: 3px; border-radius: 0; }
        @keyframes equalizer { 0%, 100% { height: 3px; } 50% { height: var(--eq-height, 10px); } }
        .quote-box { font-family: var(--font-display); font-style: italic; font-weight: 400; font-size: 11px; letter-spacing: -0.5px; line-height: 1.5; color: rgba(255, 255, 255, 0.6); }
        .quote-box::before { content: "â€œ"; color: rgba(255, 255, 255, 0.6); margin-right: 4px; }
        .quote-box::after { content: "â€"; color: rgba(255, 255, 255, 0.6); margin-left: 4px; }
        .top-msg { text-align: left; }
        .bottom-data { text-align: right; color: var(--team-accent); }
        .amount-container { display: inline-block; text-align: right; }
        .amount-row { display: block; line-height: 1.2; font-size: 11px; font-weight: bold; }
        .amount-goal { font-size: 9px; color: rgba(255,255,255,0.6); margin-top: 2px; font-family: var(--font-display); font-weight: normal; }

        .track-container { 
            flex: 1; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            position: relative; 
            overflow: hidden; 
            min-height: 0; 
            
            /* ğŸ“± [ëª¨ë°”ì¼ ê¸°ë³¸] */
            padding: 190px 20px 60px 20px; 
        }

        /* ğŸ’» [ë°ìŠ¤í¬íƒ‘/íƒœë¸”ë¦¿] */
        @media (min-width: 768px) {
            .track-container {
                padding: 150px 120px 40px 100px; 
            }
        }

        svg.track-svg { 
            width: 100%; 
            height: 100%; 
            
            /* ğŸ’¡ [í•µì‹¬] ê¸°ì¡´ 800px ì œí•œì„ í’€ê³ , ë°ìŠ¤í¬íƒ‘ì—ì„œ í›¨ì”¬ ì»¤ì§€ë„ë¡ ì„¤ì • */
            max-width: 1400px;  
            
            /* ë„ˆë¬´ ìœ„ì•„ë˜ë¡œ ê¸¸ì–´ì§€ëŠ” ê²ƒì„ ë°©ì§€ (í™”ë©´ ë†’ì´ì˜ 80%ê¹Œì§€ë§Œ) */
            max-height: 80vh; 
            
            overflow: visible; 
            transition: all 0.5s ease; /* í¬ê¸° ë³€í•  ë•Œ ë¶€ë“œëŸ½ê²Œ */
        }
        /* ğŸ’¡ íŠ¸ë™ êµµê¸° ì¡°ì • (14 -> 10) */
        .track-path-bg { 
            fill: none; 
            stroke: var(--gray-track); 
            stroke-width: var(--dynamic-stroke); 
            stroke-linecap: round; 
            stroke-linejoin: round; 
        }
        .track-path-active { 
            fill: none; 
            stroke: var(--track-active-color); 
            stroke-width: var(--dynamic-stroke); 
            stroke-linecap: round; 
            stroke-linejoin: round; 
            filter: drop-shadow(0 0 10px var(--track-active-color)); 
            transition: stroke-dasharray 0.5s ease, stroke 0.5s ease; 
        }

        .checker-box { stroke: none; }
        .checker-white { fill: #fff; }
        .checker-black { fill: #000; }

        /* ğŸ’¡ [ìˆ˜ì •] SC ë§ˆì»¤: ê²€ì • ë°°ê²½ + ì£¼í™© í…Œë‘ë¦¬ (ëª…í™•í•œ êµ¬ë¶„) */
        .sc-marker rect {
            fill: #000000 !important; /* ê²€ì •ìƒ‰ */
            stroke: #FF8700 !important; /* ì£¼í™©ìƒ‰ ì™¸ê³½ì„  */
            stroke-width: 2.5px;
            box-shadow: 0 0 15px #FF8700;
        }
        .sc-marker text {
            fill: #FF8700 !important; /* ê¸€ìë„ ì£¼í™©ìƒ‰ */
            font-weight: 900;
            font-size: 13px; /* ê¸€ì ì‚´ì§ í‚¤ì›€ */
        }
        /* ê¹œë¹¡ì„ ì• ë‹ˆë©”ì´ì…˜ ìœ ì§€ */
        .sc-marker {
            animation: sc-blink 0.5s infinite alternate;
            z-index: 2000 !important;
        }

        @keyframes sc-blink {
            from { filter: drop-shadow(0 0 2px #FF8700); }
            to { filter: drop-shadow(0 0 10px #FF8700); }
        }
        .ai-marker { cursor: default; pointer-events: none; }
        .ai-marker circle { fill: #555; stroke: none; transition: fill 0.3s; }
        .ai-marker rect { fill: #222; rx: 4; opacity: 0.9; transition: fill 0.3s, stroke 0.3s; stroke: none; }
        .ai-marker text { fill: #fff; font-weight: 900; font-family: var(--font-display); text-anchor: middle; dominant-baseline: middle; transition: fill 0.3s; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        .ai-marker.hero-marker rect { fill: var(--marker-bg) !important; stroke: none !important; opacity: 1; }
        .ai-marker.hero-marker text { fill: var(--marker-text) !important; font-weight: 900; text-shadow: none; }
        .ai-marker.hero-marker circle { fill: var(--team-accent) !important; r: 5; }
        .ai-marker.hero-marker { z-index: 999; filter: drop-shadow(0 0 8px var(--marker-bg)); }

        .controls { padding: 20px 30px 40px 30px; text-align: center; z-index: 20; position: relative; margin-top: auto; flex-shrink: 0; }
        .box-btn { background-color: transparent; color: var(--team-primary); font-family: var(--font-display); font-size: 18px; font-weight: bold; border: 2px solid var(--team-primary); padding: 18px 50px; border-radius: 4px; text-transform: uppercase; cursor: pointer; box-shadow: none; transition: transform 0.1s ease, box-shadow 0.1s ease, background-color 0.1s; position: relative; width: 100%; max-width: 300px; -webkit-tap-highlight-color: transparent; outline: none; }
        @media (hover: hover) and (pointer: fine) { .box-btn:hover { background-color: var(--team-primary); color: #000; transform: scale(1.02); box-shadow: 0 0 15px var(--team-primary); } }
        .box-btn:active, .box-btn.flash-active { transform: scale(0.96); background-color: var(--team-primary) !important; color: #000 !important; box-shadow: 0 0 15px var(--team-primary) !important; transition: none; }

        /* ğŸ’¡ [ìˆ˜ì •] ì˜¤ë””ì˜¤ ì»¨í…Œì´ë„ˆ: ë²„íŠ¼ ë‘ ê°œë¥¼ ê°€ë¡œë¡œ ì •ë ¬ */
        .audio-container { 
            position: absolute; 
            bottom: 40px; 
            right: 30px; 
            z-index: 50; 
            display: flex;       /* ê°€ë¡œ ë°°ì¹˜ */
            gap: 15px;           /* ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
            align-items: center;
        }

        .audio-btn { 
            background: transparent; 
            border: none; 
            padding: 5px; 
            cursor: pointer; 
            opacity: 0.6; 
            transition: all 0.3s; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        
        .audio-btn:hover { opacity: 1; transform: scale(1.1); }
        .audio-icon { width: 24px; height: 24px; fill: #888; }
        
        /* í™œì„±í™” ìƒíƒœì¼ ë•Œ ì•„ì´ì½˜ ìƒ‰ìƒ ë³€ê²½ (ì„ íƒì‚¬í•­) */
        .audio-btn.active .audio-icon { fill: #fff; }
        
        /* êº¼ì§„ ìƒíƒœ(Off) í‘œì‹œ */
        .audio-icon.off { opacity: 0.5; }


        .tooltip { position: absolute; bottom: calc(100% + 15px); left: 50%; transform: translateX(-50%) translateY(10px); background: #000; color: #fff; border: 2px solid var(--team-primary); padding: 10px 16px; border-radius: 4px; font-size: 11px; font-family: var(--font-display); white-space: nowrap; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s, transform 0.3s; box-shadow: 0 5px 20px rgba(0,0,0,0.8); }
        .tooltip.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border: 8px solid transparent; border-top-color: var(--team-primary); }
        
        .settings-btn { background: none; border: 1px solid #555; color: #888; padding: 10px 20px; margin-top: 20px; border-radius: 4px; font-size: 11px; cursor: pointer; font-family: var(--font-display); text-transform: uppercase; letter-spacing: 1px; transition: all 0.3s ease; }
        .settings-btn:hover { border-color: #fff; color: #fff; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 5000; justify-content: center; align-items: center; }
        /* 1. ëª¨ë‹¬ ì»¨í…ì¸ : Flex ë°•ìŠ¤ë¡œ ë³€ê²½í•˜ì—¬ ë‚´ë¶€ ì˜ì—­ ë¶„í•  */
        .modal-content { 
            background: var(--team-radio-bg); 
            /* padding: 25px;  <- ê¸°ì¡´ íŒ¨ë”© ì‚­ì œ (ë‚´ë¶€ ìš”ì†Œì— ê°ê° ì ìš©) */
            padding: 0; 
            border-radius: 4px; 
            width: 90%; 
            max-width: 400px; 
            border: 1px solid var(--team-accent); 
            
            /* ğŸ’¡ í•µì‹¬: ë†’ì´ ê³ ì • ë° Flex êµ¬ì¡° ì„¤ì • */
            max-height: 80vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; /* ì „ì²´ ìŠ¤í¬ë¡¤ ë°©ì§€ */
        }

        /* 2. í—¤ë” (íƒ€ì´í‹€): ê³ ì • */
        .modal-header {
            padding: 25px 25px 10px 25px; /* ìœ„, ì¢Œìš° íŒ¨ë”© */
            flex-shrink: 0; /* ì¤„ì–´ë“¤ì§€ ì•ŠìŒ */
        }
        .modal h2 { margin-bottom: 0; } /* ë§ˆì§„ ì¡°ì • */

        /* 3. ë³¸ë¬¸ (ì…ë ¥ì°½ë“¤): ë‚¨ì€ ê³µê°„ ì°¨ì§€ & ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
        .modal-body {
            flex: 1; /* ë‚¨ì€ ë†’ì´ ëª¨ë‘ ì°¨ì§€ */
            overflow-y: auto; /* ë‚´ìš© ë„˜ì¹˜ë©´ ì—¬ê¸°ì„œë§Œ ìŠ¤í¬ë¡¤ */
            padding: 10px 25px; /* ì¢Œìš° íŒ¨ë”© ìœ ì§€ */
            min-height: 0; /* Flexbox ë²„ê·¸ ë°©ì§€ */
        }

        /* 4. í‘¸í„° (ë²„íŠ¼): í•˜ë‹¨ ê³ ì • */
        .modal-footer {
            padding: 15px 25px 25px 25px; /* ì•„ë˜, ì¢Œìš° íŒ¨ë”© */
            background: var(--team-radio-bg); /* ë³¸ë¬¸ ìœ„ë¡œ ë–  ìˆëŠ” ëŠë‚Œ */
            border-top: 1px solid rgba(255,255,255,0.1); /* êµ¬ë¶„ì„  (ì„ íƒì‚¬í•­) */
            flex-shrink: 0; /* ì¤„ì–´ë“¤ì§€ ì•ŠìŒ */
            z-index: 10;
        }

        /* ìŠ¤í¬ë¡¤ë°” ë””ìì¸ (Webkit) - ë‹¤í¬ í…Œë§ˆì— ë§ê²Œ */
        .modal-body::-webkit-scrollbar { width: 6px; }
        .modal-body::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
        .modal-body::-webkit-scrollbar-thumb { background: var(--team-primary); border-radius: 3px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 9px; color: rgba(255,255,255,0.7); margin-bottom: 6px; font-family: var(--font-display); text-transform: uppercase; }
        .input-group input, .input-group select { width: 100%; padding: 10px; background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.2); color: #fff; font-family: var(--font-display); font-size: 12px; color-scheme: dark; outline: none; }
        .input-group select option { background: #222; color: #fff; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); opacity: 0.8; cursor: pointer; }
        
        .close-btn { width: 100%; padding: 16px; background: transparent; color: var(--team-accent); border: 2px solid var(--team-accent); margin-top: 15px; font-weight: 900; font-family: var(--font-display); text-transform: uppercase; cursor: pointer; letter-spacing: 2px; transition: background 0.2s, color 0.2s; }
        .close-btn:hover { background: var(--team-accent); color: #000; }
        .recommendation-box { margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.5); border-left: 3px solid var(--team-accent); }
        .rec-title { font-size: 9px; color: #aaa; text-transform: uppercase; margin-bottom: 5px; font-family: var(--font-display); }
        .rec-value { font-size: 14px; color: var(--team-accent); font-weight: bold; font-family: var(--font-display); }
        
        #celebration-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
        .celebration-content { background: #000; border: 2px solid var(--team-primary); border-radius: 12px; width: 85%; max-width: 400px; padding: 40px 20px; text-align: center; box-shadow: none; border: 2px solid var(--team-primary); animation: slideUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .fastest-lap-title { color: var(--team-primary); font-family: var(--font-display); font-size: 12px; letter-spacing: 4px; margin-bottom: 12px; font-weight: 900; }
        .fastest-lap-driver { color: #fff; font-family: var(--font-display); font-size: 26px; font-weight: 900; text-transform: uppercase; margin-bottom: 30px; letter-spacing: -1px; }
        .next-session-btn { background: var(--team-primary); color: #fff; border: none; padding: 16px 30px; font-family: var(--font-display); font-size: 11px; font-weight: 900; border-radius: 4px; cursor: pointer; text-transform: uppercase; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
/* ğŸ“± [ì‹ ê·œ] ëª¨ë°”ì¼ ì „ìš© ìƒíƒœ íŒ¨ë„ ìŠ¤íƒ€ì¼ */
        .status-panel {
            display: none; /* í‰ì†Œì—” ìˆ¨ê¹€ */
            width: 100%;
            max-width: 300px;
            margin: 0 auto 15px auto; /* ë²„íŠ¼ê³¼ ê°„ê²© */
            padding: 12px 0;
            background: #000000; /* ì™„ì „ ê²€ì • ë°°ê²½ */
            font-family: var(--font-display);
            font-size: 14px;
            font-weight: 900;
            text-align: center;
            letter-spacing: 2px;
            border-radius: 4px;
            text-transform: uppercase;
            /* ğŸ’¡ [ìš”ì²­] ê¸€ë¡œìš° íš¨ê³¼(box-shadow) ì—†ìŒ -> ëˆˆë¶€ì‹¬ ë°©ì§€ */
            box-shadow: none; 
        }

        /* ìƒíƒœë³„ ìƒ‰ìƒ (í…Œë‘ë¦¬ì™€ ê¸€ììƒ‰ë§Œ ë³€ê²½) */
        .status-panel.sc { 
            border: 2px solid #FF8700; 
            color: #FF8700; 
        }
        .status-panel.yellow { 
            border: 2px solid #FFD700; 
            color: #FFD700; 
        }
        .status-panel.green { 
            display: none !important; /* ì´ˆë¡ë¶ˆì´ë©´ ì¦‰ì‹œ ìˆ¨ê¹€ */
        }

        /* PCì—ì„œëŠ” êµ³ì´ ë³´ì—¬ì¤„ í•„ìš” ì—†ìœ¼ë¯€ë¡œ ìˆ¨ê¹€ (ì›í•˜ì‹œë©´ ì‚­ì œ ê°€ëŠ¥) */
        @media (min-width: 1025px) {
            .status-panel { display: none !important; }
        }

/* ğŸ“± [ì‹ ê·œ] ëª¨ë°”ì¼ ì „ìš©: ë“œë¼ì´ë²„ ì´ë¦„í‘œ 1.5ë°° í™•ëŒ€ */
        @media (max-width: 768px) {
            
            /* 1. ê²€ì • ë°°ê²½ ë°•ìŠ¤ (rect) í™•ëŒ€ */
            .ai-marker rect {
                transform: scale(1.5); /* 1.5ë°° ì»¤ì§ */
                /* ë°•ìŠ¤ì˜ ì¤‘ì‹¬ì (0, -20)ì„ ê¸°ì¤€ìœ¼ë¡œ ì»¤ì§€ê²Œ ì„¤ì •í•˜ì—¬ ìœ„ì¹˜ ì´íƒˆ ë°©ì§€ */
                transform-origin: 0px -20px; 
            }

            /* 2. í…ìŠ¤íŠ¸ (text) í™•ëŒ€ ë° ìœ„ì¹˜ ë³´ì • */
            .ai-marker text {
                /* JS ì¸ë¼ì¸ ìŠ¤íƒ€ì¼(14px)ì„ ë¬´ì‹œí•˜ê³  21pxë¡œ ì ìš© (!important) */
                font-size: 21px !important; 
                /* ê¸€ìê°€ ì»¤ì§€ë©´ì„œ ì‚´ì§ ë‚´ë ¤ê°€ëŠ” í˜„ìƒì„ ìœ„ë¡œ ì˜¬ë ¤ì„œ ë³´ì • */
                transform: translateY(-5px); 
            }
            
            /* (ì„ íƒ) SC ë§ˆì»¤ë„ ê°™ì´ í‚¤ìš°ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì½”ë“œ í¬í•¨ (ì´ë¯¸ ìœ„ í´ë˜ìŠ¤ë¡œ ì ìš©ë˜ì§€ë§Œ ëª…ì‹œì  ì¡°ì • í•„ìš”ì‹œ ì‚¬ìš©) */
            /* .sc-marker text { font-size: 18px !important; } */
        }

    </style>
</head>
<body class="redbull">
<div id="race-status-display">FLAG</div>

<div id="leaderboard">
    <div id="leaderboard-items"></div>
</div>

    <div id="loading-overlay">
        <div class="lights-container">
            <div class="light-pair"><div class="f1-light" id="light-1"></div><div class="f1-light" id="light-1b"></div></div>
            <div class="light-pair"><div class="f1-light" id="light-2"></div><div class="f1-light" id="light-2b"></div></div>
            <div class="light-pair"><div class="f1-light" id="light-3"></div><div class="f1-light" id="light-3b"></div></div>
            <div class="light-pair"><div class="f1-light" id="light-4"></div><div class="f1-light" id="light-4b"></div></div>
            <div class="light-pair"><div class="f1-light" id="light-5"></div><div class="f1-light" id="light-5b"></div></div>
        </div>
        <div class="loading-text">GRID FORMED...</div>
        <button id="start-engine-btn" onclick="activateEngine()">START ENGINE</button>
    </div>

    <div id="bgm-player"></div>
<div id="engine-player"></div>

    <div id="celebration-overlay" style="display: none;">
        <div class="celebration-content">
            <div class="fastest-lap-title" id="lap-session-title">[Q1] FASTEST LAP</div>
            <div class="fastest-lap-driver" id="lap-driver-name">ANTONELLI</div>
            <button class="next-session-btn" onclick="closeCelebration()">PUSH FOR NEXT LAP</button>
        </div>
    </div>

    <div class="header-container">
        <div class="logo-box">
            <img src="https://i.imgur.com/jan8CSk.png" alt="F1 Logo" class="f1-logo">
            <div class="circuit-info">
                <div class="circuit-country" id="disp-country">AUSTRALIA</div>
                <div class="circuit-name" id="disp-circuit">Albert Park Circuit</div>
            </div>
            <div class="status-container">
                <div id="session-step" class="session-step">[Q1]</div>
                <div id="session-name" class="session-name">HOTEL</div>
            </div>
        </div>
        <div class="radio-box">
            <div class="radio-top-section">
                <div class="driver-name" id="display-name"><span>VERSTAPPEN</span></div>
                <span class="radio-label">RADIO</span>
            </div>
            <div id="wave-container" class="audio-wave-divider"></div>
            <div class="radio-content-section">
                <div class="quote-box top-msg">BUDGET CHECK.</div>
                <div class="quote-box bottom-data">
                    <div class="amount-container">
                        <div class="amount-row" id="txt-current">CUR â‚©0</div>
                        <div class="amount-row amount-goal" id="txt-goal">TAR â‚©0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="track-container">
        <svg class="track-svg" viewBox="-100 -100 1100 600" preserveAspectRatio="xMidYMid meet">
            <path id="bg-track" class="track-path-bg" />
            <path id="active-track" class="track-path-active" />
            <g id="start-finish-line"></g>
            <g id="ai-cars-layer"></g>
        </svg>
    </div>

    <div class="controls">
        <div id="msg-tooltip" class="tooltip">NOT YET, STAY IN GARAGE</div>
        <button class="box-btn" onclick="addMoney()">BOX BOX</button>
        <br>
        <button class="settings-btn" onclick="openSettings()">PIT STOP</button>
<div class="leaderboard-toggle-container">
            <button id="lb-toggle-btn" onclick="toggleLeaderboard()">
                <span id="lb-icon-open" style="display: none;">+</span> <span id="lb-icon-close">-</span> </button>
        </div>
<div class="audio-container">
            <button id="btn-sfx" class="audio-btn active" onclick="toggleSFX()" aria-label="Toggle SFX">
                <svg id="icon-sfx-on" class="audio-icon" viewBox="0 0 24 24">
                    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                </svg>
                <svg id="icon-sfx-off" class="audio-icon off" viewBox="0 0 24 24" style="display: none;">
                    <path d="M7 9v6h4l5 5V4l-5 5H7z"/>
                </svg>
            </button>

            <button id="btn-bgm" class="audio-btn active" onclick="toggleBGM()" aria-label="Toggle BGM">
                <svg id="icon-bgm-on" class="audio-icon" viewBox="0 0 24 24">
                    <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                </svg>
                <svg id="icon-bgm-off" class="audio-icon off" viewBox="0 0 24 24" style="display: none;">
                    <path d="M4.27 3L3 4.27l9 9v.28c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4v-1.73L19.73 21 21 19.73 4.27 3zM14 7h4V3h-6v5.18l2 2z"/>
                </svg>
            </button>
        </div>
    </div>

    <div class="modal" id="settings-modal">
        <div class="modal-content">
            
            <div class="modal-header">
                <h2>Strategy Settings</h2>
            </div>

            <div class="modal-body">
                <div class="input-group">
                    <label>Select Circuit</label>
                    <select id="circuit-select" onchange="updateCircuit()"></select>
                </div>
                <div class="input-group">
                    <label>Constructor</label>
                    <select id="team-select" onchange="updateDriverList(this.value)">
                        <option value="redbull">ORACLE RED BULL RACING</option>
                        <option value="mercedes">MERCEDES-AMG PETRONAS</option>
                        <option value="ferrari">SCUDERIA FERRARI HP</option>
                        <option value="mclaren">MCLAREN F1 TEAM</option>
                        <option value="astonmartin">ASTON MARTIN ARAMCO</option>
                        <option value="alpine">BWT ALPINE F1 TEAM</option>
                        <option value="williams">WILLIAMS RACING</option>
                        <option value="rb">VISA CASH APP RB</option>
                        <option value="sauber">SAUBER / AUDI</option>
                        <option value="haas">MONEYGRAM HAAS F1</option>
                        <option value="cadillac">CADILLAC F1 TEAM</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Driver</label>
                    <select id="driver-select" onchange="setDriver(this.value)"></select>
                </div>
                <div style="display:flex; gap:10px;">
                    <div class="input-group" style="flex:1;">
                        <label>Deposit Day (DD)</label>
                        <input type="number" id="savings-day" min="1" max="31" oninput="calculateRecommendation()">
                    </div>
                    <div class="input-group" style="flex:1;">
                        <label>Target Date (Race Day)</label>
                        <input type="date" id="target-date" onchange="calculateRecommendation()">
                    </div>
                </div>
                <div class="input-group"><label>Monthly Amount (â‚©)</label><input type="number" id="deposit-unit" oninput="calculateRecommendation()"></div>
                <div class="input-group"><label>Current Total Capital (â‚©)</label><input type="number" id="manual-amount" oninput="calculateRecommendation()"></div>
                <div class="input-group"><label>[Q1] HOTEL (â‚©) - BASE</label><input type="number" id="q1-goal" oninput="calculateRecommendation()"></div>
                <div class="input-group"><label>[Q2] FLIGHT (â‚©) - ENTRY</label><input type="number" id="q2-goal" oninput="calculateRecommendation()"></div>
                <div class="input-group"><label>[Q3] TICKET+ETC (â‚©) - RACE</label><input type="number" id="q3-goal" oninput="calculateRecommendation()"></div>
                
                <div class="recommendation-box" id="rec-box" style="display:none;">
                    <div class="rec-title">Race Engineer Strategy</div>
                    <div class="rec-value" id="rec-msg">Calculating...</div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="close-btn" onclick="saveAndCloseSettings()" style="margin-top:0;">PIT LIMITER OFF</button>
            </div>

        </div>
    </div>

    <script>
        const STORAGE_KEY = 'f1_world_tour_plan_v3_aus'; 

        // ==========================================
        // ğŸµ ì˜¤ë””ì˜¤ ì „ì—­ ë³€ìˆ˜ (ì¤‘ë³µ ì„ ì–¸ ì œê±°ë¨)
        // ==========================================
        let isSfxMuted = false; // íš¨ê³¼ìŒ (ê¸°ë³¸ ì¼œì§)
        let isBgmMuted = false; // ë°°ê²½ìŒ (ê¸°ë³¸ ì¼œì§)
        
        let audioCtx;     // Web Audio API ì»¨í…ìŠ¤íŠ¸
        let bgmPlayer;    // ìœ íŠœë¸Œ BGM í”Œë ˆì´ì–´
        let enginePlayer; // ìœ íŠœë¸Œ ì—”ì§„ ì‚¬ìš´ë“œ í”Œë ˆì´ì–´

        // ==========================================
        // ğŸ”Š SFX (íš¨ê³¼ìŒ) ì œì–´ í•¨ìˆ˜
        // ==========================================
        function toggleSFX() {
            isSfxMuted = !isSfxMuted;
            
            // UI ì—…ë°ì´íŠ¸
            const onIcon = document.getElementById('icon-sfx-on');
            const offIcon = document.getElementById('icon-sfx-off');
            const btn = document.getElementById('btn-sfx');

            if(onIcon) onIcon.style.display = isSfxMuted ? 'none' : 'block';
            if(offIcon) offIcon.style.display = isSfxMuted ? 'block' : 'none';
            if(btn) btn.classList.toggle('active', !isSfxMuted);

            // ì—”ì§„ ì†Œë¦¬ ì¦‰ì‹œ ë°˜ì˜ (ì¬ìƒ ì¤‘ì´ë¼ë©´)
            if (enginePlayer && enginePlayer.setVolume) {
                enginePlayer.setVolume(isSfxMuted ? 0 : 50);
            }
        }

        // ==========================================
        // ğŸµ BGM (ë°°ê²½ìŒì•…) ì œì–´ í•¨ìˆ˜
        // ==========================================
        function toggleBGM() {
            isBgmMuted = !isBgmMuted;

            // UI ì—…ë°ì´íŠ¸
            const onIcon = document.getElementById('icon-bgm-on');
            const offIcon = document.getElementById('icon-bgm-off');
            const btn = document.getElementById('btn-bgm');

            if(onIcon) onIcon.style.display = isBgmMuted ? 'none' : 'block';
            if(offIcon) offIcon.style.display = isBgmMuted ? 'block' : 'none';
            if(btn) btn.classList.toggle('active', !isBgmMuted);

            // ë°°ê²½ìŒ ì¦‰ì‹œ ë°˜ì˜
            if (bgmPlayer && bgmPlayer.setVolume) {
                bgmPlayer.setVolume(isBgmMuted ? 0 : 70);
            }
        }

        // ==========================================
        // ğŸ¹ ë¹„í”„ìŒ ì¬ìƒ (Web Audio API) - í•„í„° ì ìš© ë²„ì „
        // ==========================================
        function playBeep() {
            // SFXê°€ êº¼ì ¸ìˆìœ¼ë©´ ì†Œë¦¬ ì•ˆ ëƒ„
            if (isSfxMuted) return;

            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            const filterNode = audioCtx.createBiquadFilter();

            // íŒŒí˜• ë° ì£¼íŒŒìˆ˜ ì„¤ì • (ë¬´ê²Œê° ìˆëŠ” 400Hz ì‚¬ê°íŒŒ)
            oscillator.type = 'square'; 
            oscillator.frequency.setValueAtTime(500, audioCtx.currentTime); 

            // í•„í„° ì„¤ì • (ë¶€ë“œëŸ¬ìš´ íƒ€ê²©ê°)
            filterNode.type = 'lowpass';
            filterNode.frequency.setValueAtTime(600, audioCtx.currentTime);

            const now = audioCtx.currentTime;
            
            // ë³¼ë¥¨ ì—”ë²¨ë¡œí”„ (ë¶€ë“œëŸ½ê²Œ ì‹œì‘í•´ì„œ ëš ëŠê¸°ì§€ ì•Šê²Œ)
            gainNode.gain.setValueAtTime(0, now); 
            gainNode.gain.linearRampToValueAtTime(0.15, now + 0.02); 
            gainNode.gain.setValueAtTime(0.15, now + 0.12);          
            gainNode.gain.linearRampToValueAtTime(0, now + 0.15);   

            // ì—°ê²° ë° ì¬ìƒ
            oscillator.connect(filterNode);
            filterNode.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.start(now);
            oscillator.stop(now + 0.15);
        }

// ==========================================
        // ğŸš€ ì—”ì§„ ìŠ¤íƒ€íŠ¸ ë²„íŠ¼ ë¡œì§ (ìˆ˜ì •ë¨: ë¬´ì¡°ê±´ ì¶œë°œ ëª¨ë“œ)
        // ==========================================
        function activateEngine() {
            // 1. ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ê¹¨ìš°ê¸°
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();

            // ë²„íŠ¼ ì¦‰ì‹œ ìˆ¨ê¹€
            document.getElementById('start-engine-btn').style.display = 'none';
            
            // 2. ì˜¤ë””ì˜¤ ì¬ìƒ ì‹œë„ (ì‹¤íŒ¨í•´ë„ ë ˆì´ìŠ¤ëŠ” ë©ˆì¶”ì§€ ì•ŠìŒ!)
            // í”Œë ˆì´ì–´ê°€ ì¤€ë¹„ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê³  ì‹¤í–‰, ì•ˆ ëìœ¼ë©´ ì¡°ìš©íˆ ë„˜ì–´ê°
            try {
                if (bgmPlayer && typeof bgmPlayer.playVideo === 'function') { 
                    bgmPlayer.setVolume(isBgmMuted ? 0 : 70); 
                    bgmPlayer.playVideo(); 
                }
            } catch(e) { console.log("BGM not ready yet"); }
            
            try {
                if (enginePlayer && typeof enginePlayer.playVideo === 'function') {
                    enginePlayer.setVolume(0); 
                    enginePlayer.playVideo();  
                }
            } catch(e) { console.log("Engine not ready yet"); }
            
            // 3. ğŸ ë ˆì´ìŠ¤ ì‹œí€€ìŠ¤ ê°•ì œ ì‹œì‘ (ê°€ì¥ ì¤‘ìš”!)
            startRaceSequence();
        }

        // ==========================================
        // ğŸš¦ ë ˆì´ìŠ¤ ì¶œë°œ ì‹œí€€ìŠ¤ (ìˆ˜ì •ë¨)
        // ==========================================
        function startRaceSequence() {
            let lightCount = 1;

            function turnOnNextLight() {
                if (lightCount <= 5) {
                    playBeep(); // ë¹„í”„ìŒ ì¬ìƒ

                    const light = document.getElementById(`light-${lightCount}b`);
                    if(light) light.classList.add('on');

                    lightCount++;
                    setTimeout(turnOnNextLight, 1000); // 1ì´ˆ ê°„ê²©
                } else {
                    // 5ê°œ ë‹¤ ì¼œì§ -> ëœë¤ ë”œë ˆì´ í›„ ì¶œë°œ
                    const randomDelay = Math.floor(Math.random() * 1500) + 200;

                    setTimeout(() => {
                        // 1. ë¶ˆ ë„ê¸°
                        document.querySelectorAll('.f1-light').forEach(l => l.classList.remove('on'));
                        
                        // 2. ğŸ’¡ [í•µì‹¬ ìˆ˜ì •] ì´ë¯¸ ì¬ìƒ ì¤‘ì¸ ì—”ì§„ ì†Œë¦¬ì˜ 'ë³¼ë¥¨'ë§Œ í‚¤ì›€
                        if (enginePlayer && enginePlayer.setVolume) { 
                            if (!isSfxMuted) enginePlayer.setVolume(30); // ì†Œë¦¬ ON
                            // SFXê°€ Mute ìƒíƒœë¼ë©´ ë³¼ë¥¨ 0 ìœ ì§€
                        }

                        // 3. ë ˆì´ìŠ¤ ì‹œì‘ í”Œë˜ê·¸
                        raceStarted = true;

                        // 4. ë¡œë”© í™”ë©´ ì œê±°
                        const overlay = document.getElementById('loading-overlay');
                        overlay.style.opacity = '0';
                        setTimeout(() => { overlay.style.display = 'none'; }, 300);

                    }, randomDelay);
                }
            }
            turnOnNextLight();
        }

        // ==========================================
        // ğŸ“º ìœ íŠœë¸Œ API í•„ìˆ˜ í•¨ìˆ˜
        // ==========================================
        function onYouTubeIframeAPIReady() {
            // BGM í”Œë ˆì´ì–´
            bgmPlayer = new YT.Player('bgm-player', { 
                height: '0', width: '0', 
                videoId: 'YhX_Woa3kVA', 
                playerVars: { 'autoplay': 0, 'controls': 0, 'loop': 1, 'playlist': 'YhX_Woa3kVA' } 
            });

            // ì—”ì§„ ì‚¬ìš´ë“œ í”Œë ˆì´ì–´
            enginePlayer = new YT.Player('engine-player', { 
                height: '0', width: '0', 
                videoId: '2O_n4EQsMrM', 
                playerVars: { 'autoplay': 0, 'controls': 0, 'loop': 1, 'playlist': '2O_n4EQsMrM' } 
            });
        }

        // ==========================================
        // ğŸ ì—¬ê¸°ì„œë¶€í„°ëŠ” ê¸°ì¡´ ë¡œì§ (ë°ì´í„°, ë§µ, ìë™ì°¨ ë“±)
        // ==========================================
        
        // (ì•„ë˜ ì½”ë“œëŠ” ê·¸ëŒ€ë¡œ ë‘ì‹œë©´ ë©ë‹ˆë‹¤. ì¤‘ë³µ ì„ ì–¸ë§Œ ì£¼ì˜í•˜ì„¸ìš”.)
        
        const circuitAssets = {
            'aus': {
                viewBox: "-200 -100 1100 600",
                path: "M 340 398 L 304 394 L 282 362 L 250 357 L 192 360 L 8 331 L -3 316 L 12 293 L 21 260 L -53 185 L -33 96 L -12 53 L 0 0 L 45 -1 L 73 -23 L 124 -44 L 179 -29 L 245 23 L 263 53 L 280 116 L 312 157 L 349 196 L 423 219 L 535 202 L 565 159 L 684 154 L 734 167 L 870 243 L 852 263 L 814 342 L 781 347 L 703 327 L 691 336 L 697 375 L 667 401 Z",
                startLineTransform: "translate(460, 398) rotate(0)" 
            },
            'chn': {
                viewBox: "-400 -100 900 600",
                path: "M -7 -9 L 3 -17 L 25 -30 L 42 -35 L 64 -33 L 86 -20 L 101 -7 L 101 9 L 98 24 L 83 32 L 70 30 L 62 21 L 45 15 L 34 15 L 23 22 L 21 43 L 40 69 L 57 78 L 217 52 L 241 54 L 366 89 L 364 102 L 325 117 L 187 110 L 155 112 L 127 132 L 114 145 L 116 192 L 153 253 L 161 281 L 159 313 L 129 328 L 53 328 L 45 335 L 60 383 L 70 389 L 330 395 L 334 389 L 323 365 L 336 344 L 367 343 L 405 363 L 405 417 L 349 454 L -345 460 L -353 447 L -318 419 L -161 417 L -146 406 Z",
                startLineTransform: "translate(-76, 198) rotate(-72)" 
            },
            'ksa': {
                viewBox: "-1000 -300 1300 700",
                path: "M 0 0 L -170 93 L -179 106 L -179 112 L -174 118 L -173 126 L -179 132 L -200 132 L -223 128 L -238 128 L -339 162 L -349 169 L -350 177 L -356 195 L -363 200 L -387 211 L -401 210 L -415 203 L -430 199 L -448 202 L -470 217 L -479 231 L -487 244 L -503 250 L -534 254 L -547 246 L -563 227 L -573 219 L -592 218 L -607 220 L -637 213 L -652 214 L -825 253 L -840 269 L -838 290 L -823 302 L -803 303 L -777 293 L -728 255 L -694 249 L -643 261 L -618 262 L -600 260 L -590 265 L -580 285 L -560 293 L -511 288 L -467 264 L -420 234 L -398 229 L -358 223 L -323 208 L -299 184 L -268 161 L -225 151 L -176 149 L -156 143 L -148 128 L -139 114 L -101 99 L -77 99 L -8 122 L 36 118 L 141 65 L 159 44 L 207 -23 L 220 -76 L 206 -92 L 190 -93 L 0 0",
                startLineTransform: "translate(0, 0) rotate(151)" 
            },
            'jpn': {
                viewBox: "-900 -150 1200 600",
                path: "M 0 0 L 203 40 L 234 65 L 238 95 L 223 114 L 213 114 L 196 113 L 132 95 L 107 95 L 83 113 L 61 114 L 29 91 L 3 87 L -22 104 L -50 113 L -80 101 L -100 49 L -130 37 L -193 58 L -221 95 L -227 174 L -224 196 L -230 212 L -275 254 L -288 255 L -394 159 L -411 108 L -426 107 L -432 117 L -422 199 L -448 251 L -490 276 L -573 287 L -641 268 L -677 246 L -695 251 L -729 290 L -729 305 L -715 322 L -660 332 L -571 323 L -295 222 L -266 191 L -254 148 L -246 52 L -240 40 L -230 40 L -218 43 L -211 37 L -207 18 L -193 -8 L -167 -21 L -147 -24 L 0 0",
                startLineTransform: "translate(0, 0) rotate(11)" 
            },
            'bhr': {
                viewBox: "-600 -600 1000 700",
                path: "M 0 0 L -486 2 L -497 -5 L -497 -16 L -467 -45 L -459 -58 L -461 -71 L -482 -138 L -484 -152 L -432 -505 L -423 -515 L -410 -518 L -394 -515 L -295 -406 L -278 -393 L -249 -384 L -232 -372 L -224 -356 L -228 -302 L -221 -282 L -109 -202 L -101 -192 L -101 -183 L -111 -173 L -128 -172 L -314 -193 L -338 -194 L -356 -189 L -387 -148 L -384 -139 L -373 -135 L -270 -130 L 79 -133 L 94 -140 L 103 -157 L 105 -184 L 77 -236 L 53 -252 L 26 -259 L -17 -274 L -48 -304 L -60 -351 L -53 -378 L -8 -464 L 15 -479 L 32 -477 L 307 -45 L 311 -30 L 305 -23 L 264 -5 L 251 -1 L 0 0",
                startLineTransform: "translate(0, 0) rotate(180)" 
            },
            'mia': {
                viewBox: "-500 -200 1100 600",
                path: "M 0 0 L 113 67 L 120 79 L 116 85 L 84 111 L 78 123 L 81 161 L 75 184 L 36 209 L -1 219 L -47 213 L -197 126 L -222 120 L -245 123 L -285 149 L -305 153 L -327 142 L -354 114 L -375 108 L -420 121 L -443 142 L -450 175 L -443 190 L -432 196 L -407 193 L -379 193 L -305 212 L -111 207 L 12 251 L 63 252 L 110 246 L 321 168 L 398 114 L 399 105 L 393 101 L 366 79 L 360 57 L 373 38 L 383 34 L 424 33 L 434 27 L 453 -10 L 447 -14 L 437 -14 L 434 -18 L 450 -68 L 443 -78 L -337 -101 L -346 -96 L -346 -82 L -286 -46 L -257 -46 L -180 -77 L -148 -78 L -129 -75 L 0 0",
                startLineTransform: "translate(0, 0) rotate(31)" 
            },
            'can': {
                viewBox: "-800 -200 1000 500",
                path: "M 0 0 L 36 3 L 106 20 L 123 17 L 136 2 L 147 0 L 160 7 L 160 18 L 134 76 L 63 127 L 53 128 L 37 118 L 32 118 L -23 143 L -41 162 L -59 169 L -136 151 L -151 154 L -159 163 L -157 181 L -163 196 L -174 202 L -303 186 L -441 131 L -446 127 L -445 100 L -449 93 L -617 27 L -638 25 L -699 31 L -708 24 L -709 7 L -699 4 L -653 9 L -616 6 L -493 -16 L -185 -14 L -178 -9 L -172 0 L -166 2 L 0 0",
                startLineTransform: "translate(0, 0) rotate(5)" 
            },
            'imo': {
                viewBox: "-600 -200 900 650",
                path: "M 0 0 L -26 0 L -128 -22 L -153 -25 L -282 -17 L -334 -4 L -342 0 L -351 25 L -358 32 L -401 53 L -411 63 L -489 249 L -490 260 L -480 287 L -481 297 L -572 375 L -578 386 L -579 401 L -569 410 L -557 410 L -397 391 L -373 393 L -292 404 L -283 401 L -272 392 L -249 328 L -249 308 L -272 222 L -269 208 L -246 174 L -236 168 L -225 168 L -208 176 L -192 177 L -6 177 L 8 179 L 16 191 L 23 193 L 139 142 L 226 47 L 244 36 L 303 11 L 314 -1 L 314 -9 L 290 -51 L 280 -55 L 265 -54 L 135 2 L 0 0",
                startLineTransform: "translate(0, 0) rotate(180)" 
            },
            'mon': {
                viewBox: "-200 -200 1200 600",
                path: "M 0 0 L 107 -88 L 157 -108 L 177 -117 L 190 -117 L 199 -111 L 208 -91 L 304 -7 L 361 49 L 423 85 L 442 104 L 465 134 L 510 155 L 541 151 L 570 131 L 579 109 L 581 71 L 591 57 L 607 50 L 762 55 L 775 58 L 781 67 L 777 83 L 762 95 L 754 104 L 737 139 L 736 151 L 750 157 L 762 149 L 764 111 L 774 100 L 785 102 L 807 121 L 829 137 L 830 147 L 722 215 L 636 240 L 586 234 L 479 184 L 368 91 L 363 81 L 357 80 L 347 85 L 344 88 L 337 88 L 328 78 L 327 58 L 210 -63 L 186 -74 L 165 -72 L 90 -34 L 84 -27 L 85 -6 L 82 2 L 16 81 L 7 85 L -2 82 L -15 74 L -22 74 L -63 148 L -67 176 L -61 211 L -70 219 L -78 219 L -116 175 L -116 169 L -99 157 L -95 148 L -89 117 L 0 0",
                startLineTransform: "translate(0, 0) rotate(-39)" 
            },
            'esp': {
                viewBox: "-1000 -450 1400 600",
                path: "M 0 0 L -651 0 L -667 -8 L -682 -20 L -679 -61 L -686 -72 L -705 -90 L -776 -113 L -794 -125 L -811 -161 L -809 -202 L -785 -240 L -717 -276 L -682 -282 L -504 -281 L -478 -270 L -466 -249 L -466 -227 L -479 -205 L -525 -177 L -545 -176 L -672 -177 L -692 -171 L -699 -155 L -694 -139 L -580 -67 L -548 -59 L -452 -58 L -430 -69 L -423 -78 L -424 -109 L -420 -123 L -324 -256 L -299 -265 L -263 -262 L -239 -253 L 64 -80 L 78 -80 L 94 -93 L 97 -116 L 83 -154 L 62 -171 L 20 -183 L 1 -196 L -6 -221 L 5 -253 L 27 -262 L 48 -263 L 154 -230 L 164 -219 L 157 -139 L 161 -129 L 183 -126 L 192 -115 L 189 -43 L 174 -21 L 145 -2 L 0 0",
                startLineTransform: "translate(0, 0) rotate(180)" 
            },
            'aut': {
                viewBox: "-650 -450 900 600",
                path: "M -4 -5 L -264 69 L -280 37 L -354 -48 L -396 -123 L -465 -271 L -526 -333 L -581 -387 L -580 -397 L -573 -403 L -467 -407 L -211 -363 L -117 -361 L -104 -353 L -100 -338 L -110 -320 L -150 -283 L -183 -271 L -220 -272 L -334 -287 L -351 -280 L -372 -256 L -371 -224 L -313 -123 L -287 -114 L -258 -120 L -241 -136 L -202 -178 L -182 -186 L -148 -191 L 106 -195 L 131 -191 L 147 -176 L 177 -78 L 174 -61 L 155 -48 L -4 -5",
                startLineTransform: "translate(-4, -5) rotate(164)" 
            },
            'gbr': {
                viewBox: "-700 -500 1000 600",
                path: "M 0 0 L -136 -93 L -145 -113 L -149 -133 L -146 -192 L -150 -209 L -159 -224 L -217 -287 L -221 -306 L -218 -310 L -172 -327 L -165 -338 L -168 -345 L -219 -360 L -257 -359 L -270 -354 L -277 -346 L -451 -113 L -457 -87 L -451 -70 L -433 -63 L -398 -65 L -384 -53 L -378 -35 L -383 -24 L -395 -16 L -415 -15 L -505 -59 L -522 -81 L -538 -113 L -564 -319 L -557 -337 L -536 -358 L -428 -386 L -333 -392 L -314 -399 L -292 -412 L -278 -420 L -264 -422 L -218 -410 L -195 -410 L -182 -417 L -168 -431 L -140 -441 L -119 -435 L -109 -422 L -90 -389 L -70 -373 L -45 -362 L 250 -222 L 263 -201 L 267 -170 L 254 -149 L 232 -140 L 222 -138 L 180 -101 L 119 -40 L 114 -31 L 115 -21 L 129 -8 L 130 1 L 126 12 L 107 28 L 88 38 L 59 39 L 54 35 L 0 0",
                startLineTransform: "translate(0, 0) rotate(214)" 
            },
            'bel': {
                viewBox: "-200 -450 900 600",
                path: "M 0 0 L -114 78 L -122 78 L -129 71 L -90 -17 L -73 -44 L 7 -121 L 23 -139 L 29 -155 L 42 -172 L 76 -182 L 91 -187 L 114 -205 L 179 -254 L 473 -366 L 483 -365 L 496 -358 L 505 -345 L 512 -343 L 522 -344 L 549 -356 L 563 -357 L 574 -351 L 652 -254 L 653 -241 L 642 -225 L 627 -221 L 614 -225 L 606 -232 L 575 -273 L 568 -275 L 555 -274 L 494 -245 L 400 -222 L 382 -212 L 374 -197 L 374 -164 L 385 -140 L 404 -122 L 422 -115 L 533 -82 L 549 -68 L 551 -50 L 547 -36 L 537 -14 L 539 -6 L 547 4 L 619 41 L 627 57 L 624 74 L 594 118 L 578 124 L 551 126 L 528 117 L 496 100 L 452 63 L 392 -27 L 382 -42 L 360 -52 L 282 -82 L 265 -82 L 179 -38 L 79 -19 L 70 -19 L 66 -27 L 68 -44 L 63 -49 L 0 0",
                startLineTransform: "translate(0, 0) rotate(146)" 
            },
            'hun': {
                viewBox: "-400 -600 600 600",
                path: "M 0 0 L -346 -4 L -358 -15 L -357 -24 L -285 -70 L -253 -75 L -252 -75 L -123 -78 L -103 -90 L -101 -108 L -108 -124 L -172 -152 L -183 -165 L -187 -181 L -232 -378 L -231 -415 L -235 -425 L -319 -491 L -324 -519 L -307 -543 L -280 -546 L -167 -533 L -160 -530 L -155 -520 L -155 -504 L -149 -498 L -83 -455 L -71 -455 L -64 -457 L -17 -483 L -5 -483 L 11 -477 L 16 -470 L 53 -401 L 73 -384 L 106 -373 L 140 -366 L 160 -345 L 166 -326 L 154 -123 L 144 -112 L 133 -112 L 72 -124 L 26 -122 L 16 -112 L 14 -89 L 23 -81 L 34 -75 L 120 -74 L 135 -59 L 139 -38 L 134 -16 L 118 -3 L 0 0",
                startLineTransform: "translate(0, 0) rotate(179)" 
            },
            'ned': {
                viewBox: "-250 -550 600 600",
                path: "M 0 0 L -162 0 L -182 -10 L -196 -32 L -188 -55 L -169 -61 L -156 -66 L -79 -65 L -28 -81 L -7 -81 L 9 -71 L 35 -38 L 56 -35 L 68 -46 L 69 -61 L 58 -74 L 9 -130 L -3 -163 L -16 -236 L -29 -269 L -53 -293 L -86 -313 L -115 -347 L -148 -454 L -139 -486 L -117 -503 L -84 -515 L 1 -498 L 59 -490 L 73 -485 L 83 -470 L 98 -425 L 94 -389 L 81 -353 L 60 -347 L 31 -361 L 19 -384 L 8 -407 L -19 -432 L -37 -439 L -61 -427 L -64 -404 L -53 -372 L -22 -298 L 44 -208 L 108 -153 L 113 -140 L 109 -132 L 101 -118 L 107 -101 L 127 -98 L 136 -105 L 262 -184 L 280 -186 L 301 -179 L 311 -163 L 331 -101 L 326 -53 L 306 -20 L 263 1 L 0 0",
                startLineTransform: "translate(0, 0) rotate(180)" 
            },
            'ita': {
                viewBox: "-600 -500 1000 600",
                path: "M 0 0 L -225 10 L -231 4 L -229 -5 L -235 -10 L -274 7 L -350 15 L -398 0 L -441 -47 L -458 -77 L -485 -235 L -491 -240 L -502 -244 L -506 -251 L -547 -357 L -544 -368 L -536 -380 L -520 -383 L -437 -398 L -427 -391 L -356 -286 L -171 -116 L -161 -113 L -135 -118 L -117 -113 L -103 -94 L -94 -90 L 265 -89 L 284 -75 L 290 -60 L 271 -28 L 217 0 L 0 0",
                startLineTransform: "translate(0, 0) rotate(177)" 
            },
            'aze': {
                viewBox: "-900 -350 1200 500",
                path: "M 0 0 L 134 1 L 139 -5 L 142 -16 L 137 -154 L 134 -158 L 129 -162 L -237 -160 L -243 -157 L -245 -151 L -245 -56 L -249 -53 L -315 -51 L -391 -40 L -400 -32 L -398 -23 L -401 -15 L -526 19 L -540 19 L -552 26 L -557 24 L -548 -53 L -552 -61 L -561 -66 L -561 -72 L -565 -78 L -582 -86 L -589 -91 L -590 -112 L -598 -120 L -679 -120 L -752 -111 L -765 -108 L -805 -59 L -822 -40 L -829 -32 L -852 48 L -859 53 L -865 64 L -862 69 L -851 78 L -773 172 L -759 185 L -751 184 L -739 176 L -716 149 L -691 129 L -599 98 L -588 92 L -583 82 L -558 44 L -546 40 L -392 -2 L -378 -3 L 0 0",
                startLineTransform: "translate(0, 0) rotate(0)" 
            },
            'sin': {
                viewBox: "-850 -250 950 550",
                path: "M 0 0 L -15 -128 L -19 -176 L -26 -187 L -39 -190 L -53 -186 L -66 -189 L -76 -200 L -82 -215 L -96 -219 L -112 -215 L -117 -206 L -120 -187 L -122 -177 L -124 -147 L -115 -116 L -101 -84 L -95 -64 L -90 -14 L -95 -2 L -111 3 L -317 -12 L -339 -19 L -506 -109 L -522 -104 L -550 -65 L -566 -30 L -574 -16 L -580 -16 L -630 -73 L -646 -80 L -676 -67 L -686 -54 L -772 107 L -776 128 L -772 144 L -760 161 L -728 175 L -719 176 L -718 182 L -715 214 L -707 230 L -666 260 L -647 289 L -636 293 L -625 289 L -618 272 L -591 83 L -564 11 L -561 9 L -459 99 L -448 100 L -407 104 L -405 110 L -402 140 L -390 152 L -276 160 L -267 156 L -259 115 L -253 111 L -193 117 L -189 123 L -186 149 L -179 161 L -28 170 L -19 165 L 14 117 L 16 110 L 0 0",
                startLineTransform: "translate(0, 0) rotate(-97)" 
            },
            'usa': {
                viewBox: "-200 -480 1100 700",
                path: "M 0 0 L 241 191 L 258 194 L 265 186 L 263 171 L 238 104 L 239 73 L 252 48 L 332 -1 L 349 -14 L 366 -55 L 370 -58 L 399 -71 L 412 -80 L 421 -123 L 428 -133 L 458 -155 L 471 -157 L 534 -134 L 543 -133 L 582 -171 L 602 -180 L 624 -175 L 636 -162 L 643 -157 L 740 -176 L 859 -331 L 857 -338 L 850 -339 L 589 -261 L 511 -249 L 278 -220 L 273 -210 L 277 -204 L 326 -148 L 332 -124 L 328 -119 L 285 -120 L 280 -124 L 273 -154 L 249 -174 L 220 -175 L 218 -169 L 260 -93 L 267 -73 L 252 -36 L 246 -30 L 202 -11 L 192 -11 L 147 -27 L 136 -39 L 87 -113 L 75 -118 L -48 -67 L -55 -57 L -51 -46 L 0 0",
                startLineTransform: "translate(0, 0) rotate(38)" 
            },
            'mex': {
                viewBox: "-200 -130 900 600",
                path: "M 0 0 L 213 32 L 575 74 L 580 81 L 576 119 L 579 126 L 602 138 L 602 149 L 553 255 L 445 427 L 445 440 L 450 446 L 467 458 L 467 463 L 421 497 L 409 490 L 407 481 L 427 335 L 419 329 L 386 308 L 380 301 L 367 270 L 353 261 L 279 250 L 272 240 L 261 203 L 251 194 L 191 162 L 2 135 L -7 130 L -14 55 L -19 43 L -29 45 L -37 65 L -42 65 L -56 54 L -68 54 L -90 50 L -100 39 L -63 -5 L -46 -9 L 0 0",
                startLineTransform: "translate(0, 0) rotate(9)" 
            },
            'bra': {
                viewBox: "-300 -200 900 600",
                path: "M 0 0 L -185 104 L -204 123 L -209 145 L -200 159 L -184 167 L -161 177 L -153 189 L -154 202 L -162 220 L -163 270 L -148 309 L -108 336 L -47 351 L -32 350 L 388 342 L 414 325 L 418 307 L 400 214 L 382 195 L 357 180 L 138 96 L 111 77 L 103 51 L 105 0 L 116 -14 L 165 -44 L 214 -60 L 234 -53 L 239 -39 L 226 -9 L 228 20 L 245 33 L 265 34 L 283 22 L 319 -43 L 377 -78 L 395 -73 L 402 -61 L 401 -53 L 357 18 L 355 49 L 365 89 L 388 107 L 528 150 L 538 145 L 545 127 L 552 47 L 515 -24 L 451 -91 L 415 -103 L 383 -110 L 196 -100 L 165 -93 L 141 -83 L 0 0",
                startLineTransform: "translate(0, 0) rotate(151)" 
            },
            'las': {
                viewBox: "-800 -130 950 550",
                path: "M 0 0 L -36 -45 L -107 -100 L -118 -100 L -129 -92 L -132 -81 L -125 -65 L -92 -21 L -88 -1 L -101 35 L -128 45 L -471 45 L -482 39 L -487 28 L -487 -57 L -508 -89 L -555 -106 L -568 -106 L -572 -103 L -570 -91 L -576 -82 L -590 -78 L -614 -91 L -626 -93 L -637 -85 L -640 -71 L -642 74 L -660 102 L -677 117 L -762 154 L -791 190 L -799 242 L -793 255 L -784 256 L -774 251 L -763 258 L -558 365 L -451 385 L -8 392 L 4 385 L 7 372 L 0 365 L 4 356 L 23 341 L 30 325 L 25 45 L 27 28 L 0 0",
                startLineTransform: "translate(0, 0) rotate(231)" 
            },
            'qat': {
                viewBox: "-350 -550 850 550",
                path: "M 0 0 L -244 -3 L -270 -19 L -276 -51 L -267 -63 L -174 -116 L -168 -146 L -175 -163 L -254 -210 L -265 -227 L -330 -413 L -326 -430 L -316 -442 L -260 -459 L -246 -454 L -230 -442 L -185 -319 L -169 -312 L -158 -320 L -138 -491 L -117 -512 L -83 -509 L -69 -492 L -48 -421 L -6 -379 L 2 -364 L 2 -342 L -20 -269 L -11 -252 L 16 -243 L 32 -249 L 40 -253 L 114 -297 L 141 -345 L 195 -468 L 215 -483 L 231 -486 L 298 -487 L 312 -479 L 315 -471 L 357 -392 L 357 -383 L 258 -259 L 254 -235 L 264 -213 L 380 -42 L 380 -27 L 359 -4 L 0 0",
                startLineTransform: "translate(0, 0) rotate(179)" 
            },
            'abu': {
                viewBox: "-550 -200 1200 600",
                path: "M 0 0 L -1 231 L 6 242 L 18 248 L 127 233 L 151 219 L 166 181 L 195 147 L 228 136 L 257 139 L 321 165 L 337 170 L 530 170 L 539 157 L 536 148 L -56 -142 L -62 -138 L -62 -110 L -67 -103 L -105 -104 L -158 -92 L -206 -66 L -361 87 L -452 217 L -450 239 L -427 262 L -395 265 L -367 250 L -357 237 L -340 121 L -330 104 L -293 60 L -277 53 L -209 51 L -204 61 L -206 110 L -200 121 L -146 131 L -129 119 L -121 93 L -123 -26 L -113 -42 L -92 -53 L -30 -74 L -7 -73 L 0 -67 L 0 0",
                startLineTransform: "translate(0, 0) rotate(90)" 
            }
        };

        const circuitsData = [
            // ğŸŒ [ì•„ì‹œì•„/ì˜¤ì„¸ì•„ë‹ˆì•„]
            // í˜¸ì£¼: ì§í•­/ê²½ìœ  ì™•ë³µ (190ë§Œ) + ë©œë²„ë¥¸ ì‹œë‚´ ìˆ™ë°•
            { id: 'aus', name: 'Albert Park Circuit', country: 'Australia', month: 3, day: 10, h: 2000000, f: 1900000, t: 850000 },
            // ì¼ë³¸: ë²šê½ƒ ì‹œì¦Œ ì™•ë³µ (70ë§Œ) + ë‚˜ê³ ì•¼/ì˜¤ì‚¬ì¹´ ì´ë™ ìˆ™ë°•
            { id: 'jpn', name: 'Suzuka International', country: 'Japan', month: 4, day: 7, h: 1500000, f: 700000, t: 750000 },
            // ì¤‘êµ­: ìƒí•˜ì´ ì™•ë³µ (60ë§Œ)
            { id: 'chn', name: 'Shanghai Int. Circuit', country: 'China', month: 4, day: 21, h: 1200000, f: 600000, t: 850000 },
            // ì‹±ê°€í¬ë¥´: F1 ê¸°ê°„ í•­ê³µê¶Œ ê¸‰ë“± (150ë§Œ) + ìº¡ìŠ/í˜¸ìŠ¤í…” í™œìš©
            { id: 'sin', name: 'Marina Bay Street Circuit', country: 'Singapore', month: 10, day: 4, h: 2500000, f: 1500000, t: 900000 },

            // ğŸª [ì¤‘ë™]
            // ì‚¬ìš°ë””: êµ­ì ê¸° ê²½ìœ  ì™•ë³µ (210ë§Œ)
            { id: 'ksa', name: 'Jeddah Corniche Circuit', country: 'Saudi Arabia', month: 3, day: 24, h: 2200000, f: 2100000, t: 900000 },
            // ì¹´íƒ€ë¥´: ì§í•­/ê²½ìœ  ì™•ë³µ (220ë§Œ)
            { id: 'qat', name: 'Lusail Int. Circuit', country: 'Qatar', month: 12, day: 1, h: 2200000, f: 2200000, t: 900000 },
            // ì•„ë¶€ë‹¤ë¹„: ì§í•­/ê²½ìœ  ì™•ë³µ (230ë§Œ)
            { id: 'abu', name: 'Yas Marina Circuit', country: 'Abu Dhabi', month: 12, day: 8, h: 2500000, f: 2300000, t: 1500000 },
            // ì•„ì œë¥´ë°”ì´ì”: ê²½ìœ  ì™•ë³µ (220ë§Œ)
            { id: 'aze', name: 'Baku City Circuit', country: 'Azerbaijan', month: 9, day: 15, h: 1600000, f: 2200000, t: 800000 },

            // ğŸ° [ìœ ëŸ½ - ì—¬ë¦„ ì„±ìˆ˜ê¸° ì™•ë³µ ë°˜ì˜]
            // ì´ëª°ë¼: ë°€ë¼ë…¸/ë¡œë§ˆ IN ì™•ë³µ (260ë§Œ)
            { id: 'imo', name: 'Imola Circuit', country: 'Italy (Imola)', month: 5, day: 19, h: 1800000, f: 2600000, t: 1100000 },
            // ëª¨ë‚˜ì½”: ë‹ˆìŠ¤/íŒŒë¦¬ ê²½ìœ  ì™•ë³µ (240ë§Œ) + ë‹ˆìŠ¤ í†µê·¼ ìˆ™ë°•
            { id: 'mon', name: 'Circuit de Monaco', country: 'Monaco', month: 5, day: 26, h: 3500000, f: 2400000, t: 1500000 },
            // ìŠ¤í˜ì¸: ë°”ë¥´ì…€ë¡œë‚˜ ì™•ë³µ (280ë§Œ)
            { id: 'esp', name: 'Circuit de Barcelona', country: 'Spain', month: 6, day: 23, h: 1800000, f: 2800000, t: 1000000 },
            // ì˜¤ìŠ¤íŠ¸ë¦¬ì•„: ë¹„ì—”ë‚˜/ë®Œí—¨ ì™•ë³µ (290ë§Œ)
            { id: 'aut', name: 'Red Bull Ring', country: 'Austria', month: 6, day: 30, h: 1900000, f: 2900000, t: 1100000 },
            // ì˜êµ­: ëŸ°ë˜ íˆë“œë¡œ ì™•ë³µ (350ë§Œ - 7ì›” ê·¹ì„±ìˆ˜ê¸°)
            { id: 'gbr', name: 'Silverstone Circuit', country: 'Great Britain', month: 7, day: 7, h: 2500000, f: 3500000, t: 1800000 },
            // í—ê°€ë¦¬: ë¶€ë‹¤í˜ìŠ¤íŠ¸/ë¹„ì—”ë‚˜ ì™•ë³µ (270ë§Œ)
            { id: 'hun', name: 'Hungaroring', country: 'Hungary', month: 7, day: 21, h: 1500000, f: 2700000, t: 900000 },
            // ë²¨ê¸°ì—: ë¸Œë¤¼ì…€/ì•”ìŠ¤í…Œë¥´ë‹´/íŒŒë¦¬ ì™•ë³µ (300ë§Œ)
            { id: 'bel', name: 'Spa-Francorchamps', country: 'Belgium', month: 7, day: 28, h: 1800000, f: 3000000, t: 1200000 },
            // ë„¤ëœë€ë“œ: ì•”ìŠ¤í…Œë¥´ë‹´ ì™•ë³µ (310ë§Œ)
            { id: 'ned', name: 'Zandvoort Circuit', country: 'Netherlands', month: 8, day: 25, h: 2200000, f: 3100000, t: 1300000 },
            // ì´íƒˆë¦¬ì•„: ë°€ë¼ë…¸ ì™•ë³µ (280ë§Œ)
            { id: 'ita', name: 'Monza Circuit', country: 'Italy (Monza)', month: 9, day: 1, h: 2000000, f: 2800000, t: 1400000 },

            // ğŸ—½ [ë¯¸ì£¼]
            // ë§ˆì´ì• ë¯¸: ë¯¸êµ­ ê²½ìœ  ì™•ë³µ (280ë§Œ)
            { id: 'mia', name: 'Miami Int. Autodrome', country: 'USA (Miami)', month: 5, day: 5, h: 3500000, f: 2800000, t: 2500000 },
            // ìºë‚˜ë‹¤: ë°´ì¿ ë²„/í† ë¡ í†  ê²½ìœ  ëª¬íŠ¸ë¦¬ì˜¬ ì™•ë³µ (320ë§Œ)
            { id: 'can', name: 'Circuit Gilles Villeneuve', country: 'Canada', month: 6, day: 9, h: 2200000, f: 3200000, t: 1200000 },
            // ë¯¸êµ­(ì˜¤ìŠ¤í‹´): ëŒˆëŸ¬ìŠ¤/íœ´ìŠ¤í„´ ê²½ìœ  ì™•ë³µ (330ë§Œ)
            { id: 'usa', name: 'Circuit of The Americas', country: 'USA (Austin)', month: 10, day: 20, h: 2500000, f: 3300000, t: 1500000 },
            // ë©•ì‹œì½”: ë¯¸êµ­ ê²½ìœ  ì™•ë³µ (260ë§Œ)
            { id: 'mex', name: 'AutÃ³dromo H. RodrÃ­guez', country: 'Mexico', month: 10, day: 27, h: 1800000, f: 2600000, t: 850000 },
            // ë¸Œë¼ì§ˆ: ìµœì¥ê±°ë¦¬ ê²½ìœ  ì™•ë³µ (300ë§Œ)
            { id: 'bra', name: 'Interlagos Circuit', country: 'Brazil', month: 11, day: 3, h: 1800000, f: 3000000, t: 800000 },
            // ë¼ìŠ¤ë² ì´ê±°ìŠ¤: ì§í•­/ê²½ìœ  ì™•ë³µ (280ë§Œ)
            { id: 'las', name: 'Las Vegas Strip Circuit', country: 'USA (Las Vegas)', month: 11, day: 23, h: 3800000, f: 2800000, t: 3000000 }
        ];

        const teamsDB = {
            redbull: { name: 'Red Bull Racing', drivers: ['VERSTAPPEN', 'HADJAR'] },
            mercedes: { name: 'Mercedes-AMG', drivers: ['RUSSELL', 'ANTONELLI'] },
            ferrari: { name: 'Ferrari HP', drivers: ['LECLERC', 'HAMILTON'] },
            mclaren: { name: 'McLaren F1', drivers: ['NORRIS', 'PIASTRI'] },
            astonmartin: { name: 'Aston Martin', drivers: ['ALONSO', 'STROLL'] },
            alpine: { name: 'BWT Alpine F1 Team', drivers: ['GASLY', 'COLAPINTO'] },
            williams: { name: 'Williams Racing', drivers: ['ALBON', 'SAINZ'] },
            rb: { name: 'Visa Cash App RB', drivers: ['LAWSON', 'LINDBLAD'] },
            sauber: { name: 'Audi F1 Team', drivers: ['HULKENBERG', 'BORTOLETO'] },
            haas: { name: 'TGR HAAS F1 TEAM', drivers: ['OCON', 'BEARMAN'] },
            cadillac: { name: 'Cadillac F1 Team', drivers: ['BOTTAS', 'PEREZ'] }
        };

        const driverGroups = {
            top: ['VER', 'NOR', 'PIA', 'RUS', 'LEC', 'HAM'], 
            mid: ['SAI', 'ALB', 'ANT', 'HUL', 'ALO', 'BOT', 'PER', 'GAS'], 
            btm: ['STR', 'OCO', 'LAW', 'HAD', 'LIN', 'BOR', 'COL', 'BEA'] 
        };

        const driverColors = {
            'VER': '#3671C6', 'HAD': '#3671C6', 
            'ANT': '#00D2BE', 'RUS': '#00D2BE', 
            'LEC': '#FF2800', 'HAM': '#FF2800', 
            'NOR': '#FF8000', 'PIA': '#FF8000', 
            'ALO': '#CEDC00', 'STR': '#CEDC00', 
            'GAS': '#FD4BC7', 'COL': '#FD4BC7', 
            'ALB': '#00A0DE', 'SAI': '#00A0DE', 
            'LAW': '#3671C6', 'LIN': '#3671C6', 
            'HUL': '#00E042', 'BOR': '#00E042', 
            'OCO': '#E6002B', 'BEA': '#E6002B',
            'BOT': '#F1B315', 'PER': '#F1B315' 
        };

        const REF_WIDTH = 1200; 

        let g_rowHeight = 21;

        let state = { 
            currentAmount: 0, team: 'redbull', driver: 'VERSTAPPEN', 
            q1: 2500000, q2: 3500000, q3: 700000, 
            lastSession: 'Q1', savingsDay: 25, depositUnit: 100000, 
            lastDepositDate: '', targetDate: '2026-03-08',
            circuitId: 'aus', pathStartOffset: 0,
            scaleFactor: 1,
            speedFactor: 1 
        };

        let visualProgress = 0, animId = null;
        let trackSpeedProfile = [];
        let raceStarted = false; 

        // let bgmPlayer;   <-- ì¤‘ë³µ ì„ ì–¸ ì‚­ì œë¨
        // let enginePlayer; <-- ì¤‘ë³µ ì„ ì–¸ ì‚­ì œë¨
        let isMuted = false;
        let aiDrivers = [];
        let stableRanking = [];
        let raceStatus = 'GREEN'; 
        let stoppedCarId = null;  
        let safetyCar = {
            active: false,
            progress: 0,
            element: null,
            speed: 0
        };
        let eventTimer = 0;        

        const driverList = [
            { id: 'VER', speed: 1.29 }, 
            { id: 'NOR', speed: 1.29 }, 
            { id: 'PIA', speed: 1.26 }, 
            { id: 'RUS', speed: 1.25 }, 
            { id: 'LEC', speed: 1.24 }, 
            { id: 'HAM', speed: 1.23 }, 
            { id: 'SAI', speed: 1.21 }, 
            { id: 'ALB', speed: 1.20 }, 
            { id: 'HUL', speed: 1.18 }, 
            { id: 'ANT', speed: 1.18 }, 
            { id: 'ALO', speed: 1.16 }, 
            { id: 'BOT', speed: 1.14 }, 
            { id: 'PER', speed: 1.14 }, 
            { id: 'GAS', speed: 1.10 }, 
            { id: 'STR', speed: 1.09 }, 
            { id: 'OCO', speed: 1.08 }, 
            { id: 'LAW', speed: 1.08 }, 
            { id: 'HAD', speed: 1.05 },
            { id: 'LIN', speed: 1.03 }, 
            { id: 'COL', speed: 1.02 }, 
            { id: 'BOR', speed: 1.01 }, 
            { id: 'BEA', speed: 1.01 }  
        ];

        function calculateScaleFactor(viewBoxStr) {
            const parts = viewBoxStr.split(' ').map(Number);
            const width = parts[2]; 
            const rawRatio = width / REF_WIDTH;
            state.speedFactor = Math.max(rawRatio, 0.85);
            state.scaleFactor = Math.max(rawRatio, 0.9);
            const newStroke = 10 * state.scaleFactor;
            document.documentElement.style.setProperty('--dynamic-stroke', `${newStroke}px`);
        }

        function adjustLeaderboardLayout() {
            const container = document.getElementById('leaderboard-items');
            if (!container) return;

            const totalDrivers = aiDrivers.length || 20;
            const availableHeight = window.innerHeight - 360; 
            const idealHeight = totalDrivers * 21;

            let scaleRatio = 1;
            if (availableHeight < idealHeight) {
                scaleRatio = availableHeight / idealHeight;
            }

            g_rowHeight = Math.max(12, 21 * scaleRatio);
            
            const newFontSize = Math.max(8, 10 * scaleRatio); 
            const newPosSize = Math.max(7, 9 * scaleRatio);

            container.style.height = (totalDrivers * g_rowHeight) + 'px';

            const rows = document.querySelectorAll('.lb-row');
            rows.forEach((row, index) => {
                row.style.height = (g_rowHeight - 1) + 'px'; 
                row.style.transform = `translateY(${index * g_rowHeight}px)`;
                
                const pos = row.querySelector('.lb-pos');
                const name = row.querySelector('.lb-name');
                if(pos) { pos.style.fontSize = newPosSize + 'px'; pos.style.lineHeight = g_rowHeight + 'px'; }
                if(name) { name.style.fontSize = newFontSize + 'px'; name.style.lineHeight = g_rowHeight + 'px'; }
            });
        }

        function init() {
            if (window.innerWidth <= 1024) {
                const lb = document.getElementById('leaderboard');
                const btn = document.getElementById('lb-toggle-btn');
                const openIcon = document.getElementById('lb-icon-open');
                const closeIcon = document.getElementById('lb-icon-close');
                
                if(lb) lb.classList.add('hidden');
                if(btn) btn.classList.remove('active');
                if(openIcon) openIcon.style.display = 'block';
                if(closeIcon) closeIcon.style.display = 'none';
            }

            window.addEventListener('resize', () => {
                if (typeof adjustLeaderboardLayout === 'function') adjustLeaderboardLayout();
                if (typeof updateLeaderboard === 'function') updateLeaderboard(); 
            });

            const container = document.getElementById('wave-container');
            if (container) {
                container.innerHTML = '';
                for(let i = 0; i < 30; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'bar';
                    const curve = Math.sin((i / 29) * Math.PI); 
                    const maxEnvelope = (14 * curve) + 4; 
                    const randomHeight = maxEnvelope * (0.6 + Math.random() * 0.4);
                    bar.style.setProperty('--eq-height', `${randomHeight}px`);
                    bar.style.animation = `equalizer ${0.2 + Math.random() * 0.3}s infinite ease-in-out`;
                    bar.style.animationDelay = `${Math.random() * -1}s`;
                    container.appendChild(bar);
                }
            }

            loadData(); 
            initCircuitSelect(); 
            updateCircuit(); 
            updateTeamSelectUI(); 
            requestAnimationFrame(animateAIDrivers); 

            setTimeout(() => {
                const track = document.getElementById('bg-track');
                if(track) {
                   const asset = circuitAssets[state.circuitId] || circuitAssets['aus']; 
                   state.pathStartOffset = findPathOffset(track, asset.startLineTransform);
                   generateTrackSpeedProfile();
                }
                
                initAIDrivers(); 
                if (typeof initLeaderboard === 'function') {
                    initLeaderboard(); 
                    if (typeof adjustLeaderboardLayout === 'function') adjustLeaderboardLayout(); 
                }
                updateDashboard(); 
            }, 50);
        }

        function initCircuitSelect() {
            const select = document.getElementById('circuit-select');
            select.innerHTML = '';
            circuitsData.forEach((c, index) => {
                const option = document.createElement('option');
                option.value = c.id;
                option.text = `[Rd.${index+1}] ${c.country} - ${c.name}`;
                if(c.id === state.circuitId) option.selected = true;
                select.appendChild(option);
            });
        }

        function updateCircuit() {
            const select = document.getElementById('circuit-select');
            const circuitId = select.value || state.circuitId;
            const data = circuitsData.find(c => c.id === circuitId);
            if(!data) return;

            state.circuitId = circuitId;
            state.q1 = data.h; 
            state.q2 = data.f; 
            state.q3 = data.t; 
            
            document.getElementById('q1-goal').value = state.q1;
            document.getElementById('q2-goal').value = state.q2;
            document.getElementById('q3-goal').value = state.q3;

            const year = 2030;
            const month = String(data.month).padStart(2, '0');
            const day = String(data.day).padStart(2, '0');
            state.targetDate = `${year}-${month}-${day}`;
            document.getElementById('target-date').value = state.targetDate;

            calculateRecommendation();

            raceStatus = 'GREEN';       
            stoppedCarId = null;        
            safetyCar.active = false;   
            eventTimer = 0;             

            const statusDisplay = document.getElementById('race-status-display');
            statusDisplay.style.opacity = '0'; 
            statusDisplay.className = ''; 

            const mobilePanel = document.getElementById('mobile-status-panel');
            if (mobilePanel) mobilePanel.style.display = 'none';

            const asset = circuitAssets[circuitId] || circuitAssets['aus'];
            const svgElement = document.querySelector('.track-svg');
            svgElement.setAttribute('viewBox', asset.viewBox);
            calculateScaleFactor(asset.viewBox);
            document.getElementById('bg-track').setAttribute('d', asset.path);
            document.getElementById('active-track').setAttribute('d', asset.path);

            const checker = document.getElementById('start-finish-line');
            checker.setAttribute('transform', asset.startLineTransform);
            checker.innerHTML = `
                <rect x="-8" y="-3" width="4" height="3" class="checker-black"/><rect x="-4" y="-3" width="4" height="3" class="checker-white"/><rect x="0" y="-3" width="4" height="3" class="checker-black"/><rect x="4" y="-3" width="4" height="3" class="checker-white"/>
                <rect x="-8" y="0" width="4" height="3" class="checker-white"/><rect x="-4" y="0" width="4" height="3" class="checker-black"/><rect x="0" y="0" width="4" height="3" class="checker-white"/><rect x="4" y="0" width="4" height="3" class="checker-black"/>
            `;

            setTimeout(() => {
                const track = document.getElementById('bg-track');
                state.pathStartOffset = findPathOffset(track, asset.startLineTransform);
                generateTrackSpeedProfile();
                initAIDrivers(); 
                updateDashboard(); 
            }, 50);
        }

        function findPathOffset(pathElement, transformStr) {
            const match = transformStr.match(/translate\(\s*(-?[\d.]+)\s*,\s*(-?[\d.]+)\s*\)/);
            if (!match) return 0;
            const targetX = parseFloat(match[1]), targetY = parseFloat(match[2]);
            const totalLen = pathElement.getTotalLength();
            let minDist = Infinity, bestRatio = 0;
            const steps = 5000; 
            for(let i=0; i <= steps; i++) {
                const len = (i / steps) * totalLen;
                const pt = pathElement.getPointAtLength(len);
                const dist = Math.sqrt(Math.pow(pt.x - targetX, 2) + Math.pow(pt.y - targetY, 2));
                if (dist < minDist) { minDist = dist; bestRatio = i / steps; }
            }
            return bestRatio;
        }

        function toggleLeaderboard() {
            const lb = document.getElementById('leaderboard');
            const btn = document.getElementById('lb-toggle-btn');
            const openIcon = document.getElementById('lb-icon-open');
            const closeIcon = document.getElementById('lb-icon-close');
            
            lb.classList.toggle('hidden');
            
            const isHidden = lb.classList.contains('hidden');
            openIcon.style.display = isHidden ? 'block' : 'none';
            closeIcon.style.display = isHidden ? 'none' : 'block';
            
            if (!isHidden) btn.classList.add('active');
            else btn.classList.remove('active');
        }

        function initAIDrivers() {
            const layer = document.getElementById('ai-cars-layer');
            if (!layer) return;
            
            layer.innerHTML = ''; 
            aiDrivers = [];
            
            let topGroup = [...driverGroups.top];
            let midGroup = [...driverGroups.mid];
            let btmGroup = [...driverGroups.btm];

            for (let i = topGroup.length - 1; i >= 0; i--) {
                if (Math.random() < 0.05) { 
                    const driver = topGroup.splice(i, 1)[0];
                    btmGroup.push(driver); 
                }
            }
            for (let i = btmGroup.length - 1; i >= 0; i--) {
                if (Math.random() < 0.05) { 
                    const driver = btmGroup.splice(i, 1)[0];
                    midGroup.push(driver); 
                }
            }

            const shuffle = (a) => a.sort(() => Math.random() - 0.5);
            const combinedIds = [...shuffle(topGroup), ...shuffle(midGroup), ...shuffle(btmGroup)];
            
            let gridStartPos = state.pathStartOffset - 0.02;
            if (gridStartPos < 0) gridStartPos += 1; 

            combinedIds.forEach((id, index) => {
                const dInfo = driverList.find(d => d.id === id) || { speed: 1.0 };
                const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                g.setAttribute("class", "ai-marker");
                g.innerHTML = `<rect x="-20" y="-30" width="40" height="20"/><text x="0" y="-16" style="font-size:14px;">${id}</text><circle r="4"/>`;
                layer.appendChild(g);

                const row = Math.floor(index / 2);
                const stagger = (index % 2 === 1) ? 0.004 : 0; 
                
                let initialProgress = gridStartPos - (row * 0.015) - stagger;
                if (initialProgress < 0) initialProgress += 1;

                aiDrivers.push({ 
                    id: id, 
                    element: g, 
                    baseSpeed: dInfo.speed, 
                    progress: initialProgress, 
                    actualSpeed: 0, 
                    totalLaps: 0,
                    condition: 1.0, 
                    randomFactor: Math.random() * 100,
                    focus: 1.0,
                    battleState: 'normal',
                    battleTimer: 0,        
                    cooldown: 0            
                });
            });

            const scGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
            scGroup.setAttribute("class", "ai-marker sc-marker");
            scGroup.style.display = 'none'; 
            scGroup.innerHTML = `<rect x="-20" y="-30" width="40" height="20"/><text x="0" y="-16" style="font-size:12px;">SC</text>`;
            layer.appendChild(scGroup);

            safetyCar.element = scGroup;

            updateRaceScenario();
            
            if (typeof initLeaderboard === 'function') {
                initLeaderboard();
                if (typeof adjustLeaderboardLayout === 'function') adjustLeaderboardLayout();
            }
        }

        function updateRaceScenario() {
            const heroId = getDriverShortId(state.driver);
            aiDrivers.forEach(ai => {
                const isHero = (ai.id === heroId);
                ai.element.classList.toggle('hero-marker', isHero);
                if(isHero) document.getElementById('ai-cars-layer').appendChild(ai.element);
            });
        }

        function getDriverShortId(n) { 
            if (n === 'LINDBLAD') return 'LIN';
            if (n === 'HADJAR') return 'HAD';
            if (n === 'COLAPINTO') return 'COL';
            return n.substring(0,3).toUpperCase(); 
        }

        function generateTrackSpeedProfile() {
            const track = document.getElementById('bg-track');
            const len = track.getTotalLength();
            trackSpeedProfile = []; 
            for(let i=0; i<1000; i++) {
                const pt1 = track.getPointAtLength(((i-5+1000)%1000)/1000*len);
                const pt2 = track.getPointAtLength((i/1000)*len);
                const pt3 = track.getPointAtLength(((i+5)%1000)/1000*len);
                
                const angle1 = Math.atan2(pt2.y - pt1.y, pt2.x - pt1.x);
                const angle2 = Math.atan2(pt3.y - pt2.y, pt3.x - pt2.x);
                let diff = Math.abs(angle1 - angle2);
                if (diff > Math.PI) diff = 2 * Math.PI - diff; 

                let trackFactor;
                if (diff < 0.12) trackFactor = 2.0;      
                else if (diff < 0.25) trackFactor = 1.4; 
                else if (diff < 0.45) trackFactor = 0.7; 
                else trackFactor = 0.35;                 
                
                trackSpeedProfile.push(trackFactor);
            }
        }

        let leaderboardRows = {}; 

        function initLeaderboard() {
            const container = document.getElementById('leaderboard-items');
            if (!container) return; 

            container.innerHTML = ''; 
            leaderboardRows = {}; 

            container.style.height = (aiDrivers.length * 21) + 'px';
            container.style.position = 'relative'; 
            container.style.width = '100%';        

            aiDrivers.forEach((ai, index) => {
                const row = document.createElement('div');
                row.className = 'lb-row';
                row.style.transform = `translateY(${index * 21}px)`;

                const color = driverColors[ai.id] || '#888';
                const isMyDriver = (ai.id === getDriverShortId(state.driver));
                const textStyle = isMyDriver ? 'color: #FFEC00;' : 'color: #ffffff;';
                
                row.innerHTML = `
                    <div class="lb-pos" style="${textStyle}">${index + 1}</div>
                    <div class="lb-color-strip" style="background-color: ${color}; box-shadow: 0 0 4px ${color};"></div>
                    <div class="lb-name" style="${textStyle}">${ai.id}</div>
                `;

                container.appendChild(row);

                leaderboardRows[ai.id] = { 
                    element: row, 
                    posElement: row.querySelector('.lb-pos') 
                };
            });
        }

        function updateLeaderboard() {
            const sortedDrivers = [...aiDrivers].sort((a, b) => {
                const scoreA = (a.totalLaps * 10000) + a.progress;
                const scoreB = (b.totalLaps * 10000) + b.progress;
                return scoreB - scoreA; 
            });

            sortedDrivers.forEach((driver, index) => {
                const rowObj = leaderboardRows[driver.id];
                
                if (rowObj && rowObj.element) {
                    rowObj.element.style.transform = `translateY(${index * g_rowHeight}px)`;
                    
                    const isMyDriver = (driver.id === getDriverShortId(state.driver));
                    const targetColor = isMyDriver ? '#FFEC00' : '#ffffff'; 

                    if (rowObj.posElement) {
                        const currentRank = String(index + 1);
                        if (rowObj.posElement.innerText !== currentRank) {
                            rowObj.posElement.innerText = currentRank;
                        }
                        rowObj.posElement.style.color = targetColor;
                    }
                    
                    const nameElement = rowObj.element.querySelector('.lb-name');
                    if (nameElement) {
                        nameElement.style.color = targetColor;
                    }
                    
                    rowObj.element.style.zIndex = (index === 0) ? '100' : '10';
                }
            });
            
            stableRanking = sortedDrivers.map(d => d.id);
        }

        function triggerRaceIncident() {
            const victimIndex = Math.floor(Math.random() * aiDrivers.length);
            const victim = aiDrivers[victimIndex];
            
            if (stoppedCarId !== null) return;
            stoppedCarId = victim.id;
            
            const isSC = Math.random() > 0.4; 

            if (isSC) {
                raceStatus = 'SC';
                eventTimer = 3000; 
                updateStatusUI('SAFETY CAR', 'status-sc');
                spawnSafetyCar(); 
            } else {
                raceStatus = 'YELLOW';
                eventTimer = 600; 
                updateStatusUI('YELLOW FLAG', 'status-yellow');
            }
        }

        function spawnSafetyCar() {
            const leader = [...aiDrivers].sort((a, b) => (b.totalLaps + b.progress) - (a.totalLaps + a.progress))[0];
            
            safetyCar.active = true;
            safetyCar.speed = 0.8; 

            const fixedOffset = 0.003;
            safetyCar.progress = leader.progress + fixedOffset; 
            
            if (safetyCar.progress >= 1) safetyCar.progress -= 1;
            
            safetyCar.element.style.display = 'block';
        }

        function animateAIDrivers() {
            const track = document.getElementById('bg-track');
            if(!track) { requestAnimationFrame(animateAIDrivers); return; }
            
            const len = track.getTotalLength();
            const now = Date.now();

            const circuitSpecialists = {
                'aus': { 'NOR': 1.03, 'PIA': 1.03, 'LEC': 1.02, 'PER': 1.02 },
                'chn': { 'PIA': 1.03, 'NOR': 1.02, 'VER': 1.01 },
                'jpn': { 'VER': 1.04, 'NOR': 1.02, 'PIA': 1.01, 'PER': 1.02 },
                'bhr': { 'PIA': 1.03, 'VER': 1.02, 'PER': 1.03 },
                'ksa': { 'PIA': 1.03, 'NOR': 1.02, 'PER': 1.02 },
                'mia': { 'PIA': 1.03, 'NOR': 1.02, 'LEC': 1.02, 'PER': 1.02 },
                'mon': { 'NOR': 1.04, 'LEC': 1.03, 'PER': 1.04 },
                'esp': { 'PIA': 1.03, 'NOR': 1.02, 'VER': 1.02, 'PER': 1.02 },
                'can': { 'RUS': 1.05, 'VER': 1.02, 'PER': 1.03 },
                'aut': { 'NOR': 1.03, 'PIA': 1.02, 'PER': 1.03 },
                'gbr': { 'NOR': 1.03, 'PIA': 1.02, 'HUL': 1.05, 'PER': 1.02 }, 
                'bel': { 'PIA': 1.03, 'NOR': 1.02, 'PER': 1.03 },
                'hun': { 'NOR': 1.03, 'PIA': 1.02, 'RUS': 1.03, 'PER': 1.02 },
                'ned': { 'PIA': 1.03, 'VER': 1.02, 'HAD': 1.05, 'PER': 1.02 },
                'ita': { 'VER': 1.04, 'NOR': 1.02, 'PIA': 1.01, 'PER': 1.02 },
                'mad': { 'PIA': 1.03, 'NOR': 1.02, 'PER': 1.03 },
                'aze': { 'PER': 1.055, 'VER': 1.02, 'RUS': 1.03, 'SAI': 1.04 },
                'sin': { 'RUS': 1.05, 'VER': 1.02, 'NOR': 1.01, 'PER': 1.03 },
                'usa': { 'VER': 1.04, 'NOR': 1.02, 'PER': 1.03 },
                'mex': { 'NOR': 1.03, 'PER': 1.05, 'LEC': 1.02 },
                'bra': { 'NOR': 1.03, 'ANT': 1.05, 'VER': 1.02, 'PER': 1.02 },
                'las': { 'VER': 1.04, 'RUS': 1.03, 'ANT': 1.03, 'PER': 1.02 },
                'qat': { 'VER': 1.04, 'PIA': 1.02, 'PER': 1.03 },
                'abu': { 'VER': 1.04, 'PIA': 1.02, 'PER': 1.03 }
            };

            const battleRank = [...aiDrivers].sort((a, b) => (b.totalLaps + b.progress) - (a.totalLaps + a.progress));
            const leaderCar = battleRank[0];
            const leaderDist = leaderCar ? (leaderCar.totalLaps + leaderCar.progress) : 0;

            if (raceStarted && raceStatus === 'GREEN') {
                if (leaderCar && leaderCar.totalLaps >= 1) {
                    if (Math.random() < 0.00025) triggerRaceIncident();
                }
            }

            if (raceStatus !== 'GREEN') {
                eventTimer--;
                if (raceStatus === 'SC' && eventTimer === 180) {
                    raceStatus = 'SC_ENDING';
                    updateStatusUI('SC ENDING', 'status-sc');
                }
                if ((raceStatus === 'SC_ENDING' || raceStatus === 'YELLOW') && eventTimer <= 0) {
                    resumeRace();
                }
            }

            if (safetyCar.active) {
                if (raceStatus === 'SC_ENDING') {
                    safetyCar.element.style.display = 'none';
                    safetyCar.active = false; 
                } else {
                    safetyCar.progress += 0.8 * 0.00038 * state.speedFactor;
                    if (safetyCar.progress >= 1) safetyCar.progress -= 1;

                    const pt = track.getPointAtLength(len * safetyCar.progress);
                    safetyCar.element.setAttribute('transform', `translate(${pt.x}, ${pt.y}) scale(${state.scaleFactor})`);

                    if (stoppedCarId && raceStatus === 'SC' && eventTimer > 200) {
                        const victim = aiDrivers.find(d => d.id === stoppedCarId);
                        if (victim) {
                            let distToVictim = victim.progress - safetyCar.progress;
                            if (distToVictim < 0) distToVictim += 1; 
                            if (distToVictim < 0.4) {
                                raceStatus = 'SC_ENDING';
                                eventTimer = 180; 
                                updateStatusUI('SC ENDING', 'status-sc');
                            }
                        }
                    }
                }
            }

            aiDrivers.forEach(ai => {
                if (raceStarted) {
                    if (ai.id === stoppedCarId) {
                        ai.actualSpeed *= 0.9;
                        if (ai.actualSpeed < 0.01) ai.actualSpeed = 0;
                        ai.element.classList.add('stopped');
                        const pt = track.getPointAtLength(len * ai.progress);
                        ai.element.setAttribute('transform', `translate(${pt.x}, ${pt.y}) scale(${state.scaleFactor})`);
                        return; 
                    } else {
                        ai.element.classList.remove('stopped');
                    }

                    if (!ai.battleState) { ai.battleState = 'normal'; ai.battleTimer = 0; ai.cooldown = 0; }
                    if (!ai.conditionState) { ai.conditionState = 'normal'; ai.conditionTimer = 0; }
                    if (ai.battleTimer > 0) ai.battleTimer--;
                    if (ai.cooldown > 0) ai.cooldown--;
                    if (ai.conditionTimer > 0) ai.conditionTimer--;
                    
                    if (ai.battleState !== 'normal' && ai.battleState !== 'underdog_push' && ai.battleTimer <= 0) { 
                        ai.battleState = 'normal'; ai.cooldown = 200; 
                    }
                    if (ai.battleState === 'underdog_push' && ai.battleTimer <= 0) {
                        ai.battleState = 'normal'; ai.cooldown = 100;
                    }
                    if (ai.conditionState !== 'normal' && ai.conditionTimer <= 0) ai.conditionState = 'normal';

                    const currentIndex = Math.floor(ai.progress * 1000) % 1000;
                    const lookAheadIndex = (currentIndex + 20) % 1000;
                    const normalTrackFactor = (trackSpeedProfile[currentIndex] * 0.6) + (trackSpeedProfile[lookAheadIndex] * 0.4);

                    const compressedBaseSpeed = 1.0 + (ai.baseSpeed - 1.0) * 0.65;

                    let targetSpeed = compressedBaseSpeed;
                    let currentLerpRate = 0.05;

                    let circuitBoost = 1.0;
                    if (circuitSpecialists[state.circuitId] && circuitSpecialists[state.circuitId][ai.id]) {
                        circuitBoost = circuitSpecialists[state.circuitId][ai.id];
                    }

                    if (raceStatus === 'GREEN') {
                        let conditionBoost = 1.0;
                        if (ai.conditionState === 'super') conditionBoost = 1.35;
                        else if (ai.conditionState === 'slump') conditionBoost = 0.75;
                        else if (ai.conditionState === 'normal' && ai.battleState === 'normal') {
                            const isPlayer = (ai.id === getDriverShortId(state.driver));
                            const eventChance = isPlayer ? 0.0008 : 0.0005; 
                            if (Math.random() < eventChance) {
                                if (Math.random() < (isPlayer ? 0.9 : 0.5)) { ai.conditionState = 'super'; ai.conditionTimer = 300; }
                                else { ai.conditionState = 'slump'; ai.conditionTimer = 240; }
                            }
                        }

                        let battleBoost = 1.0;
                        const myCurrentRank = battleRank.findIndex(r => r.id === ai.id);
                        
                        if (ai.battleState === 'normal' && myCurrentRank >= 14) {
                            if (Math.random() < 0.0015) { 
                                ai.battleState = 'underdog_push'; ai.battleTimer = 120; 
                            }
                        }

                        if (ai.battleState === 'boost') battleBoost = 1.15;
                        else if (ai.battleState === 'lag') battleBoost = 0.90;
                        else if (ai.battleState === 'underdog_push') battleBoost = 1.30; 
                        else if (ai.battleState === 'normal' && ai.cooldown <= 0 && myCurrentRank > 0) {
                            const ahead = battleRank[myCurrentRank - 1];
                            const dist = (ahead.totalLaps + ahead.progress) - (ai.totalLaps + ai.progress);
                            if (dist > 0 && dist < 0.02) {
                                const isPlayer = (ai.id === getDriverShortId(state.driver));
                                const aggression = (circuitBoost > 1.0) ? 0.6 : 0.4;
                                if (Math.random() < (isPlayer ? 0.7 : aggression)) { ai.battleState = 'boost'; ai.battleTimer = 150; }
                                else { ai.battleState = 'lag'; ai.battleTimer = 100; }
                            }
                        }

                        let rubberBandBoost = 1.0;
                        if (leaderCar) {
                            const myDist = ai.totalLaps + ai.progress;
                            const gap = leaderDist - myDist; 

                            if (ai.id === leaderCar.id) {
                                rubberBandBoost = 0.990; 
                            } else if (gap > 0) {
                                rubberBandBoost = 1.0 + (gap * 0.08); 
                                if (rubberBandBoost > 1.12) rubberBandBoost = 1.12;
                            }
                        }

                        let calculatedSpeed = compressedBaseSpeed * normalTrackFactor * battleBoost * conditionBoost * circuitBoost * rubberBandBoost;
                        
                        if (myCurrentRank > 0) {
                            const ahead = battleRank[myCurrentRank - 1];
                            const dist = (ahead.totalLaps + ahead.progress) - (ai.totalLaps + ai.progress);
                            if (ai.battleState === 'boost' || ai.battleState === 'underdog_push') { 
                                targetSpeed = calculatedSpeed; 
                            } 
                            else if (dist < 0.005 && ai.actualSpeed > ahead.actualSpeed) { 
                                targetSpeed = ahead.actualSpeed; currentLerpRate = 0.2; 
                            } 
                            else { targetSpeed = calculatedSpeed; }
                        } else { targetSpeed = calculatedSpeed; }

                    } else if (raceStatus === 'YELLOW') {
                        const isLeader = (battleRank[0] && ai.id === battleRank[0].id);
                        let yellowPaceFactor = isLeader ? 0.55 : 0.75; 
                        let limitSpeed = compressedBaseSpeed * normalTrackFactor * yellowPaceFactor;
                        targetSpeed = limitSpeed;

                        let minDistY = 100;
                        let carAhead = null;
                        aiDrivers.forEach(other => {
                            if (other.id !== ai.id && other.id !== stoppedCarId) { 
                                let d = other.progress - ai.progress;
                                if (d < 0) d += 1; 
                                if (d < minDistY) { minDistY = d; carAhead = other; }
                            }
                        });

                        if (carAhead) {
                            const safeDistance = 0.02;
                            if (minDistY <= safeDistance) {
                                if (targetSpeed > carAhead.actualSpeed) {
                                    targetSpeed = carAhead.actualSpeed;
                                    if (minDistY < 0.01) targetSpeed *= 0.9; 
                                }
                                currentLerpRate = 0.3; 
                            } else { currentLerpRate = 0.1; }
                        }

                    } else if (raceStatus === 'SC' || raceStatus === 'SC_ENDING') {
                        let minDist = 100; 
                        let objectAhead = null; 
                        
                        if (safetyCar.active) {
                            let d = safetyCar.progress - ai.progress;
                            if (d < 0) d += 1; 
                            if (d < minDist) { minDist = d; objectAhead = { type: 'SC', speed: 0.8 }; }
                        }

                        aiDrivers.forEach(other => {
                            if (other.id !== ai.id && other.id !== stoppedCarId) {
                                let d = other.progress - ai.progress;
                                if (d < 0) d += 1; 
                                if (d < minDist) { minDist = d; objectAhead = { type: 'CAR', speed: other.actualSpeed }; }
                            }
                        });

                        if (objectAhead) {
                            const isSC = (objectAhead.type === 'SC');
                            if (minDist < 0.002) { targetSpeed = objectAhead.speed * 0.5; currentLerpRate = 0.5; } 
                            else if (minDist < 0.006) { targetSpeed = objectAhead.speed; currentLerpRate = 0.3; } 
                            else {
                                targetSpeed = 1.8; 
                                if (isSC && minDist < 0.15) { targetSpeed = 0.9; }
                                currentLerpRate = 0.08;
                            }
                        } else {
                            if (raceStatus === 'SC_ENDING') {
                                targetSpeed = compressedBaseSpeed * normalTrackFactor * 1.3;
                                currentLerpRate = 0.05;
                            } else { targetSpeed = 0.8; currentLerpRate = 0.1; }
                        }
                    }

                    if (ai.id === getDriverShortId(state.driver)) {
                        let heroBonus = 1.002; 
                        
                        if (ai.baseSpeed <= 1.10) { 
                            heroBonus = 1.015; 
                        } else if (ai.baseSpeed <= 1.20) { 
                            heroBonus = 1.008; 
                        }
                        
                        targetSpeed *= heroBonus;
                    }
                    
                    ai.actualSpeed += (targetSpeed - ai.actualSpeed) * currentLerpRate;
                    ai.progress += ai.actualSpeed * 0.00038 * state.speedFactor;
                    
                    if (ai.progress >= 1) {
                        ai.progress -= 1;
                        ai.totalLaps += 1;
                    }
                } 
                
                const pt = track.getPointAtLength(len * ai.progress);
                const jitterPower = (raceStatus === 'GREEN') ? 2.0 : 0.0;
                const jitterX = (Math.sin(now/200 + ai.randomFactor) * jitterPower); 
                const jitterY = (Math.cos(now/200 + ai.randomFactor) * jitterPower);
                ai.element.setAttribute('transform', `translate(${pt.x + jitterX}, ${pt.y + jitterY}) scale(${state.scaleFactor})`);
            });

            if(raceStarted) updateLeaderboard();
            requestAnimationFrame(animateAIDrivers);
        }

        function resumeRace() {
            const leader = [...aiDrivers].sort((a, b) => (b.totalLaps + b.progress) - (a.totalLaps + a.progress))[0];

            if (stoppedCarId && leader) {
                const victim = aiDrivers.find(d => d.id === stoppedCarId);
                
                if (victim) {
                    victim.totalLaps = leader.totalLaps;
                    if (victim.progress > leader.progress) {
                        victim.totalLaps -= 1;
                    }
                    victim.actualSpeed = victim.baseSpeed * 0.8; 
                    console.log(`[Rank Reset] ${victim.id} synced relative to Leader.`);
                }
            }

            raceStatus = 'GREEN';
            stoppedCarId = null;
            safetyCar.active = false;
            safetyCar.element.style.display = 'none'; 
            
            updateStatusUI('GREEN FLAG', 'status-green');
            
            setTimeout(() => {
                if(raceStatus === 'GREEN') document.getElementById('race-status-display').style.opacity = '0';
            }, 2000);
        }

        function updateStatusUI(text, cssClass) {
            const el = document.getElementById('race-status-display');
            el.innerText = text;
            el.className = ''; 
            el.classList.add(cssClass);
            el.style.opacity = '1';

            const mobilePanel = document.getElementById('mobile-status-panel');
            if (mobilePanel) {
                mobilePanel.className = 'status-panel';
                
                if (text.includes('GREEN')) {
                    mobilePanel.style.display = 'none';
                } else {
                    mobilePanel.innerText = text;
                    mobilePanel.style.display = 'block';
                    
                    if (cssClass.includes('sc')) mobilePanel.classList.add('sc');
                    else if (cssClass.includes('yellow')) mobilePanel.classList.add('yellow');
                }
            }
        }

        function addMoney() {
            const btn = document.querySelector('.box-btn');
            btn.classList.add('flash-active');
            setTimeout(() => btn.classList.remove('flash-active'), 150);
            
            const today = new Date();
            const todayStr = today.toDateString(); 

            if (today.getDate() !== state.savingsDay) { 
                const d = state.savingsDay;
                
                const j = d % 10, k = d % 100;
                let suffix = "th";
                if (j === 1 && k !== 11) suffix = "st";
                else if (j === 2 && k !== 12) suffix = "nd";
                else if (j === 3 && k !== 13) suffix = "rd";

                showTooltip(`NOT YET, BOX ON THE ${d}${suffix}`); 
                return; 
            }

            if (state.lastDepositDate === todayStr) {
                showTooltip("ALREADY BOXED! SAVE TIRES.");
                return;
            }

            const totalGoal = state.q1 + state.q2 + state.q3;
            if (state.currentAmount >= totalGoal) { 
                showTooltip("MAX POWER REACHED"); 
                return; 
            }

            state.currentAmount += state.depositUnit;
            if(state.currentAmount > totalGoal) state.currentAmount = totalGoal;
            
            state.lastDepositDate = todayStr;
            
            let checkS = state.currentAmount >= totalGoal ? 'FINISH' : state.currentAmount >= (state.q1 + state.q2) ? 'Q3' : state.currentAmount >= state.q1 ? 'Q2' : 'Q1';
            if (checkS !== state.lastSession && checkS !== 'Q1') triggerCelebration(state.lastSession);
            state.lastSession = checkS;
            
            saveData(); 
            updateDashboard();
        }

        function updateDashboard() {
            document.body.className = state.team;
            document.getElementById('display-name').innerHTML = `<span>${state.driver}</span>`;
            
            const data = circuitsData.find(c => c.id === state.circuitId);
            if(data) {
                document.getElementById('disp-country').innerText = data.country;
                document.getElementById('disp-circuit').innerText = data.name;
            }

            const totalGoal = state.q1 + state.q2 + state.q3;
            let targetP = 0;
            let step = "[Q1]";
            let name = "HOTEL";

            if (state.currentAmount < state.q1) { 
                targetP = state.currentAmount / state.q1;
                step = "[Q1]";
                name = "HOTEL";
            
            } else if (state.currentAmount < (state.q1 + state.q2)) { 
                targetP = (state.currentAmount - state.q1) / state.q2;
                step = "[Q2]";
                name = "FLIGHT";
            
            } else if (state.currentAmount < totalGoal) { 
                targetP = (state.currentAmount - (state.q1 + state.q2)) / state.q3;
                step = "[Q3]";
                name = "TICKET";
            
            } else { 
                targetP = 1; 
                step = "POLE";
                name = "POSITION";
            }

            syncTrackFill(Math.max(0, Math.min(1, targetP)));

            document.getElementById('session-step').innerText = step;
            document.getElementById('session-name').innerText = name;
            document.getElementById('txt-current').innerText = `CUR â‚©${state.currentAmount.toLocaleString()}`;
            
            document.getElementById('txt-goal').innerText = `TAR â‚©${totalGoal.toLocaleString()}`;

            document.getElementById('savings-day').value = state.savingsDay;
            document.getElementById('deposit-unit').value = state.depositUnit;
            document.getElementById('manual-amount').value = state.currentAmount;
            document.getElementById('q1-goal').value = state.q1;
            document.getElementById('q2-goal').value = state.q2;
            document.getElementById('q3-goal').value = state.q3;
            document.getElementById('target-date').value = state.targetDate;
        }

        function syncTrackFill(target) {
            if (animId) cancelAnimationFrame(animId);
            const activeTrack = document.getElementById('active-track');
            const totalLength = activeTrack.getTotalLength();
            
            const baseOffset = -1 * (totalLength * state.pathStartOffset);

            function frame() {
                visualProgress += (target - visualProgress) * 0.08;
                
                activeTrack.style.strokeDasharray = `${totalLength * visualProgress} ${totalLength * 1.1}`;
                activeTrack.style.strokeDashoffset = baseOffset;
                
                if (Math.abs(target - visualProgress) > 0.001) animId = requestAnimationFrame(frame);
            }
            frame();
        }

        function triggerCelebration(sessionName) {
            document.getElementById('celebration-overlay').style.display = 'flex';
            document.getElementById('lap-session-title').innerText = `[${sessionName}] FASTEST LAP`;
            document.getElementById('lap-driver-name').innerText = state.driver;
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        }

        function showTooltip(m) { const t = document.getElementById('msg-tooltip'); t.innerText = m; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }
        function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; updateTeamSelectUI(); calculateRecommendation(); }
        function closeCelebration() { document.getElementById('celebration-overlay').style.display = 'none'; }
        function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
        function loadData() { const s = localStorage.getItem(STORAGE_KEY); if (s) state = { ...state, ...JSON.parse(s) }; }
        function shuffleArray(a) { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; }

        function calculateRecommendation() {
            const savingsDay = parseInt(document.getElementById('savings-day').value) || 1;
            const targetDateStr = document.getElementById('target-date').value;
            const curAmt = parseInt(document.getElementById('manual-amount').value) || 0;
            const totalGoal = (parseInt(document.getElementById('q1-goal').value) || 0) + (parseInt(document.getElementById('q2-goal').value) || 0) + (parseInt(document.getElementById('q3-goal').value) || 0);
            const remaining = totalGoal - curAmt;
            const targetDate = new Date(targetDateStr);
            const today = new Date();
            let count = 0, temp = new Date(today);
            if (temp.getDate() > savingsDay) temp.setMonth(temp.getMonth() + 1);
            temp.setDate(savingsDay);
            while (temp <= targetDate) { count++; temp.setMonth(temp.getMonth() + 1); }
            document.getElementById('rec-box').style.display = 'block';
            document.getElementById('rec-msg').innerText = count > 0 ? `REC: â‚©${Math.ceil(remaining/count).toLocaleString()} / month (${count} stops)` : "FULL DEPOSIT NEEDED";
        }

        function saveAndCloseSettings() {
            state.team = document.getElementById('team-select').value;
            state.driver = document.getElementById('driver-select').value;
            
            state.savingsDay = Number(document.getElementById('savings-day').value);
            state.depositUnit = Number(document.getElementById('deposit-unit').value);
            state.currentAmount = Number(document.getElementById('manual-amount').value);
            
            state.q1 = Number(document.getElementById('q1-goal').value);
            state.q2 = Number(document.getElementById('q2-goal').value);
            state.q3 = Number(document.getElementById('q3-goal').value);
            state.targetDate = document.getElementById('target-date').value;

            saveData();

            updateDashboard();      
            updateRaceScenario();   

            document.getElementById('settings-modal').style.display = 'none';
        }

        function updateDriverList(teamKey) {
            const driverSelect = document.getElementById('driver-select');
            driverSelect.innerHTML = '';
            teamsDB[teamKey].drivers.forEach(d => {
                const opt = document.createElement('option'); opt.value = d; opt.text = d;
                driverSelect.appendChild(opt);
            });
            document.body.className = teamKey;
        }

        function updateTeamSelectUI() {
            document.getElementById('team-select').value = state.team;
            updateDriverList(state.team);
            document.getElementById('driver-select').value = state.driver;
        }

        function setDriver(val) {
            state.driver = val;
            
            updateRaceScenario(); 
            
            document.getElementById('display-name').innerHTML = `<span>${state.driver}</span>`;

            updateLeaderboard();
            
            console.log(`[Camera Switch] Now watching: ${state.driver}`);
        }

        // ==========================================
        // ğŸ”§ [FIX] YouTube API ì•ˆì „í•œ ë¡œë”© (ìˆœì„œ ë³´ì¥)
        // ==========================================
        function loadYouTubeAPI() {
            const tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            const firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        }

        // ğŸ’¡ init() ì‹¤í–‰ í›„ APIë¥¼ ë¡œë“œí•˜ì—¬ ìˆœì„œ ê¼¬ì„ ë°©ì§€
        init(); 
        loadYouTubeAPI(); 
    </script>
</body>
</html>
